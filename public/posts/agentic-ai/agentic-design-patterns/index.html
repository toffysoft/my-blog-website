<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด | Toffysoft&#39;s Blog</title>
<meta name="keywords" content="AI, Artificial Intelligence, Agentic AI, Design Patterns, Software Engineering, Python">
<meta name="description" content="เจาะลึกรูปแบบการออกแบบ AI ที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ พร้อมตัวอย่างการประยุกต์ใช้งานในโลกจริง">
<meta name="author" content="Apiwat Ruangkanjanapaisarn">
<link rel="canonical" href="http://localhost:1313/posts/agentic-ai/agentic-design-patterns/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2d6240e602c0dc461084f6be8e56c708e5e1efe1df0e71e2e8d12c0b5b8047a9.css" integrity="sha256-LWJA5gLA3EYQhPa&#43;jlbHCOXh7&#43;HfDnHi6NEsC1uAR6k=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/agentic-ai/agentic-design-patterns/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:1313/posts/agentic-ai/agentic-design-patterns/">
  <meta property="og:site_name" content="Toffysoft&#39;s Blog">
  <meta property="og:title" content="ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด">
  <meta property="og:description" content="เจาะลึกรูปแบบการออกแบบ AI ที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ พร้อมตัวอย่างการประยุกต์ใช้งานในโลกจริง">
  <meta property="og:locale" content="th-th">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-02-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-02-06T00:00:00+00:00">
    <meta property="article:tag" content="AI">
    <meta property="article:tag" content="Artificial Intelligence">
    <meta property="article:tag" content="Agentic AI">
    <meta property="article:tag" content="Design Patterns">
    <meta property="article:tag" content="Software Engineering">
    <meta property="article:tag" content="Python">
    <meta property="og:image" content="https://raw.githubusercontent.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen/main/images/l1.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen/main/images/l1.png">
<meta name="twitter:title" content="ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด">
<meta name="twitter:description" content="เจาะลึกรูปแบบการออกแบบ AI ที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ พร้อมตัวอย่างการประยุกต์ใช้งานในโลกจริง">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Agentic AI",
      "item": "http://localhost:1313/posts/agentic-ai/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด",
      "item": "http://localhost:1313/posts/agentic-ai/agentic-design-patterns/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด",
  "name": "ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด",
  "description": "เจาะลึกรูปแบบการออกแบบ AI ที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ พร้อมตัวอย่างการประยุกต์ใช้งานในโลกจริง",
  "keywords": [
    "AI", "Artificial Intelligence", "Agentic AI", "Design Patterns", "Software Engineering", "Python"
  ],
  "articleBody": "ในยุคที่ AI กำลังเข้ามามีบทบาทสำคัญในชีวิตประจำวันของเรามากขึ้น การออกแบบระบบ AI ให้สามารถทำงานได้อย่างชาญฉลาดและมีประสิทธิภาพจึงเป็นเรื่องที่สำคัญมาก หนึ่งในแนวคิดที่น่าสนใจคือ “Agentic Design Patterns” หรือรูปแบบการออกแบบที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ มาทำความรู้จักกับแนวคิดนี้กันให้ลึกซึ้งยิ่งขึ้น\nAgentic Design Patterns คืออะไร? Agentic Design Patterns เป็นแนวทางการออกแบบที่ใช้ในการสร้างระบบ AI ที่สามารถทำงานได้อย่างอิสระ (Autonomous) โดยไม่ต้องพึ่งพาการควบคุมจากมนุษย์ตลอดเวลา รูปแบบการออกแบบเหล่านี้ช่วยกำหนดวิธีการที่ระบบ AI จะคิด ตัดสินใจ และมีปฏิสัมพันธ์กับสภาพแวดล้อม รวมถึงระบบอื่นๆ เพื่อให้บรรลุเป้าหมายที่ต้องการ\nรูปแบบการออกแบบที่น่าสนใจ 1. ReACT - การผสมผสานระหว่างการคิดและการกระทำ ReACT (Reasoning and Acting) เป็นรูปแบบที่น่าสนใจมาก เพราะจำลองการทำงานคล้ายกับวิธีที่มนุษย์เราคิดและตัดสินใจ โดยระบบจะ:\nวิเคราะห์สถานการณ์และคิดหาทางแก้ไข ลงมือทำตามแผนที่วางไว้ ประเมินผลลัพธ์และปรับปรุงการตัดสินใจในรอบถัดไป ตัวอย่างที่เห็นได้ชัดคือ ระบบวางแผนการเดินทาง ที่จะสลับไปมาระหว่างการค้นหาเที่ยวบิน (การคิด) และการจองตั๋ว (การกระทำ) โดยปรับเปลี่ยนแผนตามราคาและความพร้อมของเที่ยวบินที่พบ\nตัวอย่าง ReACT from typing import Dict, List, Tuple, TypedDict, Annotated from datetime import datetime, timedelta import json from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import os # Define our state structure class AgentState(TypedDict): messages: List[str] current_plan: Dict flight_data: Dict booking_status: str next_action: str # Mock flight database MOCK_FLIGHTS = { \"BKK-NRT\": [ {\"flight\": \"TG676\", \"departure\": \"10:30\", \"arrival\": \"18:45\", \"price\": 15000}, {\"flight\": \"JL708\", \"departure\": \"08:00\", \"arrival\": \"15:30\", \"price\": 18000}, ], \"NRT-BKK\": [ {\"flight\": \"TG677\", \"departure\": \"19:30\", \"arrival\": \"00:45\", \"price\": 16000}, {\"flight\": \"JL709\", \"departure\": \"16:30\", \"arrival\": \"22:00\", \"price\": 17000}, ] } # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", # หรือใช้โมเดลอื่นที่ OpenRouter รองรับ temperature=0, headers={ \"HTTP-Referer\": \"http://localhost:8000\", # your website URL \"X-Title\": \"Flight Booking Assistant\" # your app name } ) def reasoning_step(state: AgentState) -\u003e AgentState: \"\"\" Analyze the current situation and plan next steps \"\"\" # Create a prompt for the LLM to analyze the situation messages = [ HumanMessage(content=f\"\"\" Current situation: - Planning status: {state['current_plan']} - Available flight data: {state['flight_data']} - Booking status: {state['booking_status']} What should be the next action? Choose from: 1. SEARCH_FLIGHTS - If we need to look for flights 2. BOOK_FLIGHT - If we found a suitable flight and should book it 3. END - If we've completed the booking Provide your reasoning and the next action. \"\"\") ] # Get LLM response response = llm.invoke(messages) # Extract next action from response if \"SEARCH_FLIGHTS\" in response.content: state[\"next_action\"] = \"SEARCH_FLIGHTS\" elif \"BOOK_FLIGHT\" in response.content: state[\"next_action\"] = \"BOOK_FLIGHT\" elif \"END\" in response.content: state[\"next_action\"] = \"END\" state[\"messages\"].append(f\"Reasoning: {response.content}\") return state def search_flights(state: AgentState) -\u003e AgentState: \"\"\" Search for available flights based on the current plan \"\"\" route = f\"{state['current_plan']['origin']}-{state['current_plan']['destination']}\" if route in MOCK_FLIGHTS: state[\"flight_data\"] = MOCK_FLIGHTS[route] state[\"messages\"].append(f\"Found {len(MOCK_FLIGHTS[route])} flights for {route}\") else: state[\"flight_data\"] = {} state[\"messages\"].append(f\"No flights found for {route}\") return state def book_flight(state: AgentState) -\u003e AgentState: \"\"\" Attempt to book the selected flight \"\"\" if state[\"flight_data\"]: # Find the cheapest flight selected_flight = min(state[\"flight_data\"], key=lambda x: x[\"price\"]) state[\"booking_status\"] = \"CONFIRMED\" state[\"messages\"].append( f\"Booked flight {selected_flight['flight']} for {selected_flight['price']} THB\" ) else: state[\"booking_status\"] = \"FAILED\" state[\"messages\"].append(\"Booking failed - no flights available\") return state def router(state: AgentState) -\u003e str: \"\"\" Route to the next step based on the reasoning outcome \"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(AgentState) # Add nodes workflow.add_node(\"reasoning\", reasoning_step) workflow.add_node(\"search_flights\", search_flights) workflow.add_node(\"book_flight\", book_flight) # Add edges workflow.add_edge(\"reasoning\", router) workflow.add_edge(\"search_flights\", \"reasoning\") workflow.add_edge(\"book_flight\", \"reasoning\") # Set entry point workflow.set_entry_point(\"reasoning\") # Create conditional edges workflow.add_conditional_edges( \"reasoning\", router, { \"SEARCH_FLIGHTS\": \"search_flights\", \"BOOK_FLIGHT\": \"book_flight\", \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"current_plan\": { \"origin\": \"BKK\", \"destination\": \"NRT\", \"date\": \"2025-02-15\" }, \"flight_data\": {}, \"booking_status\": \"NOT_STARTED\", \"next_action\": \"SEARCH_FLIGHTS\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 2. ระบบที่พัฒนาตัวเองได้ (Self-Improvement) ความน่าสนใจของรูปแบบนี้อยู่ที่ความสามารถในการเรียนรู้และพัฒนาตัวเองอย่างต่อเนื่อง เหมือนกับที่มนุษย์เราเรียนรู้จากประสบการณ์ ระบบจะ:\nประเมินผลการทำงานของตัวเอง เรียนรู้จากข้อมูลใหม่ๆ ปรับปรุงกระบวนการทำงานภายใน ตัวอย่างที่เห็นได้บ่อยคือ ผู้ช่วยเขียนโค้ด ที่จะปรับปรุงคำแนะนำให้ดีขึ้นจากการวิเคราะห์ผลตอบรับของผู้ใช้\nตัวอย่าง Self-Improvement from typing import Dict, List, TypedDict, Optional from datetime import datetime import json from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import numpy as np from dataclasses import dataclass, asdict import os # Define our state and data structures @dataclass class CodeSuggestion: code: str explanation: str confidence: float timestamp: str feedback_score: Optional[float] = None class AssistantState(TypedDict): messages: List[str] current_query: str suggestions_history: List[Dict] feedback_history: List[Dict] improvement_metrics: Dict next_action: str current_suggestion: Optional[Dict] # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", # หรือโมเดลอื่นที่ OpenRouter รองรับ temperature=0.7, headers={ \"HTTP-Referer\": \"http://localhost:8000\", # your website URL \"X-Title\": \"Code Assistant\" # your app name } ) # Knowledge base for code patterns (would be expanded in real implementation) CODE_PATTERNS_DB = { \"error_handling\": { \"weight\": 0.5, \"examples\": [\"try-except blocks\", \"error logging\", \"graceful degradation\"] }, \"code_style\": { \"weight\": 0.3, \"examples\": [\"PEP8 compliance\", \"meaningful variable names\", \"proper indentation\"] }, \"performance\": { \"weight\": 0.2, \"examples\": [\"algorithmic efficiency\", \"memory usage\", \"optimization techniques\"] } } def generate_code_suggestion(state: AssistantState) -\u003e AssistantState: \"\"\" Generate code suggestions based on current knowledge and past feedback \"\"\" messages = [ HumanMessage(content=f\"\"\" Task: Generate Python code based on the following: Query: {state['current_query']} Consider past feedback patterns: {json.dumps(state['improvement_metrics'], indent=2)} Provide: 1. Code suggestion (in ```python code blocks) 2. Explanation: 3. Confidence: (a number between 0-1) \"\"\") ] response = llm.invoke(messages) # Parse LLM response (in real implementation, would use more robust parsing) suggestion = CodeSuggestion( code=response.content.split(\"```python\")[1].split(\"```\")[0].strip(), explanation=response.content.split(\"Explanation:\")[1].split(\"Confidence:\")[0].strip(), confidence=float(response.content.split(\"Confidence:\")[1].strip()), timestamp=datetime.now().isoformat() ) state[\"current_suggestion\"] = asdict(suggestion) state[\"suggestions_history\"].append(asdict(suggestion)) state[\"next_action\"] = \"EVALUATE\" return state def evaluate_feedback(state: AssistantState) -\u003e AssistantState: \"\"\" Analyze user feedback and update improvement metrics \"\"\" if not state[\"feedback_history\"]: state[\"next_action\"] = \"END\" return state recent_feedback = state[\"feedback_history\"][-1] # Analyze feedback and update metrics feedback_score = recent_feedback.get(\"score\", 0) feedback_comments = recent_feedback.get(\"comments\", \"\") # Update improvement metrics based on feedback messages = [ HumanMessage(content=f\"\"\" Analyze this feedback and identify which patterns need adjustment: Score: {feedback_score} Comments: {feedback_comments} Current metrics: {json.dumps(state['improvement_metrics'], indent=2)} Analyze which patterns (error_handling, code_style, performance) are mentioned in the feedback and should be adjusted. \"\"\") ] response = llm.invoke(messages) # Update metrics (simplified version) for pattern in CODE_PATTERNS_DB: if pattern in response.content.lower(): state[\"improvement_metrics\"][pattern][\"weight\"] *= (1 + feedback_score * 0.1) # Normalize weights total_weight = sum(m[\"weight\"] for m in state[\"improvement_metrics\"].values()) for pattern in state[\"improvement_metrics\"]: state[\"improvement_metrics\"][pattern][\"weight\"] /= total_weight state[\"next_action\"] = \"REFLECT\" return state def self_reflection(state: AssistantState) -\u003e AssistantState: \"\"\" Periodic self-reflection to identify areas for improvement \"\"\" if len(state[\"suggestions_history\"]) \u003c 5: # Need more data for meaningful reflection state[\"next_action\"] = \"END\" return state # Analyze recent performance recent_suggestions = state[\"suggestions_history\"][-5:] avg_confidence = np.mean([s[\"confidence\"] for s in recent_suggestions]) messages = [ HumanMessage(content=f\"\"\" Analyze recent performance and suggest improvements: Average confidence: {avg_confidence} Recent suggestions: {json.dumps(recent_suggestions, indent=2)} Current metrics: {json.dumps(state['improvement_metrics'], indent=2)} Please provide specific suggestions for improving: 1. Code quality 2. Explanation clarity 3. Confidence estimation accuracy \"\"\") ] response = llm.invoke(messages) # Update state with reflection insights state[\"messages\"].append(f\"Self-reflection insights: {response.content}\") state[\"next_action\"] = \"END\" return state def router(state: AssistantState) -\u003e str: \"\"\" Route to the next step based on the current state \"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(AssistantState) # Add nodes workflow.add_node(\"generate\", generate_code_suggestion) workflow.add_node(\"evaluate\", evaluate_feedback) workflow.add_node(\"reflect\", self_reflection) # Add edges workflow.add_edge(\"generate\", router) workflow.add_edge(\"evaluate\", router) workflow.add_edge(\"reflect\", router) # Set entry point workflow.set_entry_point(\"generate\") # Create conditional edges workflow.add_conditional_edges( \"generate\", router, { \"EVALUATE\": \"evaluate\", \"END\": END } ) workflow.add_conditional_edges( \"evaluate\", router, { \"REFLECT\": \"reflect\", \"END\": END } ) workflow.add_conditional_edges( \"reflect\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"current_query\": \"Write a function to find the nth Fibonacci number with memoization\", \"suggestions_history\": [], \"feedback_history\": [ { \"score\": 0.8, \"comments\": \"Good use of memoization, but could improve error handling\" } ], \"improvement_metrics\": { \"error_handling\": {\"weight\": 0.3, \"count\": 0}, \"code_style\": {\"weight\": 0.4, \"count\": 0}, \"performance\": {\"weight\": 0.3, \"count\": 0} }, \"next_action\": \"GENERATE\", \"current_suggestion\": None } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 3. Agentic RAG - การผสมผสานการค้นหาและการสร้างเนื้อหา รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบ AI สามารถใช้ข้อมูลจากแหล่งภายนอกมาประกอบการตัดสินใจได้ โดย:\nค้นหาข้อมูลที่เกี่ยวข้องจากฐานข้อมูล นำข้อมูลมาประมวลผลและสร้างเป็นคำตอบ ตรวจสอบความถูกต้องของข้อมูลก่อนนำไปใช้ ระบบแชทบอทให้บริการลูกค้าที่สามารถค้นหาข้อมูลจากเอกสารนโยบายและสร้างคำตอบที่เหมาะสมเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Agentic RAG from typing import Dict, List, TypedDict, Optional import json from datetime import datetime from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from langchain_community.vectorstores import FAISS from langchain_community.embeddings import OllamaEmbeddings from langchain.text_splitter import RecursiveCharacterTextSplitter from dataclasses import dataclass, asdict import os # Define data structures @dataclass class RetrievedDocument: content: str source: str relevance_score: float @dataclass class GeneratedResponse: response: str confidence: float sources: List[str] timestamp: str class ChatbotState(TypedDict): messages: List[str] current_query: str retrieved_docs: List[Dict] generated_response: Optional[Dict] verification_result: Optional[Dict] next_action: str # Mock policy database POLICY_DOCUMENTS = { \"returns\": \"\"\" Return Policy: - Items can be returned within 30 days of purchase - Must have original receipt - Items must be unused and in original packaging - Shipping costs are non-refundable - Store credit or refund will be issued within 7 business days \"\"\", \"shipping\": \"\"\" Shipping Policy: - Free shipping on orders over 1000 THB - Standard shipping: 3-5 business days - Express shipping: 1-2 business days (additional fee) - International shipping available to select countries - Tracking number provided for all shipments \"\"\", \"warranty\": \"\"\" Warranty Policy: - 1-year manufacturer warranty on all products - Covers defects in materials and workmanship - Does not cover damage from misuse or accidents - Warranty claims require proof of purchase - Replacement or repair decision at company discretion \"\"\" } # Initialize components llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.7, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Policy Assistant\" } ) # Initialize Ollama embeddings embeddings = OllamaEmbeddings( model=\"nomic-embed-text\", # หรือจะใช้โมเดลอื่นที่ Ollama รองรับ base_url=\"http://localhost:11434\" # ปรับ URL ตาม Ollama server ) text_splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=50) # Create vector store from policy documents def initialize_vector_store(): texts = [] metadatas = [] for policy_type, content in POLICY_DOCUMENTS.items(): chunks = text_splitter.split_text(content) texts.extend(chunks) metadatas.extend([{\"source\": policy_type} for _ in chunks]) return FAISS.from_texts(texts, embeddings, metadatas=metadatas) vector_store = initialize_vector_store() def retrieve_relevant_docs(state: ChatbotState) -\u003e ChatbotState: \"\"\" Retrieve relevant documents based on the user query \"\"\" # Search vector store docs = vector_store.similarity_search_with_score( state[\"current_query\"], k=3 ) # Process and store retrieved documents retrieved_docs = [ asdict(RetrievedDocument( content=doc[0].page_content, source=doc[0].metadata[\"source\"], relevance_score=float(doc[1]) )) for doc in docs ] state[\"retrieved_docs\"] = retrieved_docs state[\"next_action\"] = \"GENERATE\" return state def generate_response(state: ChatbotState) -\u003e ChatbotState: \"\"\" Generate response using retrieved documents \"\"\" # Prepare context from retrieved documents context = \"\\n\".join([ f\"Document from {doc['source']}:\\n{doc['content']}\" for doc in state[\"retrieved_docs\"] ]) messages = [ HumanMessage(content=f\"\"\" Based on the following context and user query, generate a helpful response. Context: {context} User Query: {state['current_query']} Generate a response that: 1. Directly answers the user's question 2. References specific policies when relevant 3. Is clear and easy to understand 4. Uses bullet points for important information \"\"\") ] response = llm.invoke(messages) generated_response = GeneratedResponse( response=response.content, confidence=0.8, # In real implementation, would calculate based on relevance scores sources=[doc[\"source\"] for doc in state[\"retrieved_docs\"]], timestamp=datetime.now().isoformat() ) state[\"generated_response\"] = asdict(generated_response) state[\"next_action\"] = \"VERIFY\" return state def verify_response(state: ChatbotState) -\u003e ChatbotState: \"\"\" Verify the generated response against policy documents \"\"\" response = state[\"generated_response\"][\"response\"] sources = state[\"retrieved_docs\"] messages = [ HumanMessage(content=f\"\"\" Verify this response against the source documents for accuracy: Response: {response} Source Documents: {json.dumps(sources, indent=2)} Check for: 1. Factual accuracy 2. Completeness 3. Consistency with policies 4. Any missing important information Provide: 1. Verification result (verified/not verified) 2. Confidence score (0-1) 3. Detailed notes about any issues found \"\"\") ] verification = llm.invoke(messages) state[\"verification_result\"] = { \"verified\": \"incorrect information\" not in verification.content.lower(), \"confidence\": 0.9 if \"high confidence\" in verification.content.lower() else 0.7, \"notes\": verification.content } state[\"next_action\"] = \"END\" if state[\"verification_result\"][\"verified\"] else \"GENERATE\" return state def router(state: ChatbotState) -\u003e str: \"\"\" Route to the next step based on the current state \"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(ChatbotState) # Add nodes workflow.add_node(\"retrieve\", retrieve_relevant_docs) workflow.add_node(\"generate\", generate_response) workflow.add_node(\"verify\", verify_response) # Add edges workflow.add_edge(\"retrieve\", router) workflow.add_edge(\"generate\", router) workflow.add_edge(\"verify\", router) # Set entry point workflow.set_entry_point(\"retrieve\") # Create conditional edges workflow.add_conditional_edges( \"retrieve\", router, { \"GENERATE\": \"generate\", \"END\": END } ) workflow.add_conditional_edges( \"generate\", router, { \"VERIFY\": \"verify\", \"END\": END } ) workflow.add_conditional_edges( \"verify\", router, { \"GENERATE\": \"generate\", \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"current_query\": \"What is your return policy for unused items?\", \"retrieved_docs\": [], \"generated_response\": None, \"verification_result\": None, \"next_action\": \"RETRIEVE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 4. Meta-Agent - ผู้จัดการระบบอัจฉริยะ เปรียบเสมือนผู้จัดการโครงการที่คอยประสานงานระหว่างทีมย่อยต่างๆ Meta-Agent จะ:\nแบ่งงานให้ระบบย่อยที่เชี่ยวชาญเฉพาะด้าน ประสานงานให้ทุกส่วนทำงานสอดคล้องกัน ติดตามและควบคุมคุณภาพของงาน ตัวอย่างเช่น ระบบบริหารโครงการที่แบ่งงานให้ระบบย่อยดูแลเรื่องการจัดตารางเวลา งบประมาณ และการรายงานผล\nตัวอย่าง Meta-Agent from typing import Dict, List, TypedDict, Optional from datetime import datetime, timedelta import json from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from dataclasses import dataclass, asdict import os # Define data structures @dataclass class Task: id: str name: str description: str duration: int # in days dependencies: List[str] assigned_to: str status: str estimated_cost: float @dataclass class ScheduleReport: start_date: str end_date: str critical_path: List[str] milestone_dates: Dict[str, str] @dataclass class BudgetReport: total_cost: float cost_breakdown: Dict[str, float] budget_status: str warnings: List[str] class ProjectState(TypedDict): messages: List[str] tasks: List[Dict] schedule: Optional[Dict] budget: Optional[Dict] quality_metrics: Dict next_action: str current_request: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", # your website URL \"X-Title\": \"Project Management Assistant\" # your app name } ) class SchedulingAgent: \"\"\"Agent responsible for project scheduling\"\"\" @staticmethod def create_schedule(tasks: List[Task]) -\u003e ScheduleReport: # Create schedule based on task dependencies and durations today = datetime.now() schedule = {} scheduled_tasks = set() def can_schedule(task): return all(dep in scheduled_tasks for dep in task.dependencies) current_date = today while len(scheduled_tasks) \u003c len(tasks): for task in tasks: if task.id not in scheduled_tasks and can_schedule(task): schedule[task.id] = { 'start': current_date.strftime('%Y-%m-%d'), 'end': (current_date + timedelta(days=task.duration)).strftime('%Y-%m-%d') } scheduled_tasks.add(task.id) current_date += timedelta(days=1) return ScheduleReport( start_date=today.strftime('%Y-%m-%d'), end_date=max(date['end'] for date in schedule.values()), critical_path=list(schedule.keys()), # Simplified critical path milestone_dates=schedule ) class BudgetingAgent: \"\"\"Agent responsible for budget management\"\"\" @staticmethod def analyze_budget(tasks: List[Task], schedule: ScheduleReport) -\u003e BudgetReport: total_cost = sum(task.estimated_cost for task in tasks) # Calculate cost breakdown by category cost_breakdown = {} for task in tasks: category = task.assigned_to cost_breakdown[category] = cost_breakdown.get(category, 0) + task.estimated_cost # Determine budget status and warnings warnings = [] if total_cost \u003e 100000: # Example budget threshold warnings.append(\"Project exceeds recommended budget\") status = \"GREEN\" if not warnings else \"YELLOW\" return BudgetReport( total_cost=total_cost, cost_breakdown=cost_breakdown, budget_status=status, warnings=warnings ) class QualityAgent: \"\"\"Agent responsible for quality control\"\"\" @staticmethod def assess_quality(state: ProjectState) -\u003e Dict: messages = [ HumanMessage(content=f\"\"\" Analyze the project quality and provide assessment: Schedule Information: {json.dumps(state['schedule'], indent=2)} Budget Information: {json.dumps(state['budget'], indent=2)} Task Information: {json.dumps(state['tasks'], indent=2)} Please provide: 1. Quality score (0-100) 2. Risk level assessment (LOW/MEDIUM/HIGH) 3. Specific improvement recommendations 4. Areas of concern, if any Format your response with clear sections and bullet points. \"\"\") ] response = llm.invoke(messages) # Parse LLM response (simplified) quality_metrics = { \"quality_score\": 85, # Would be parsed from response \"risk_level\": \"MEDIUM\", \"recommendations\": response.content.split(\"\\n\") } return quality_metrics def meta_agent_coordinator(state: ProjectState) -\u003e ProjectState: \"\"\" Main coordination function that delegates tasks to specialized agents \"\"\" messages = [ HumanMessage(content=f\"\"\" Analyze this project management request and determine the next action: Current Request: {state['current_request']} Current State: {json.dumps(state, indent=2)} Available actions: 1. SCHEDULE - Create or update project schedule 2. BUDGET - Analyze project budget and costs 3. QUALITY - Assess project quality and risks 4. END - Complete the workflow Consider: - Dependencies between tasks - Resource allocation - Timeline constraints - Budget requirements Provide your reasoning and recommended next action. \"\"\") ] response = llm.invoke(messages) # Determine next action based on LLM response if \"SCHEDULE\" in response.content: state[\"next_action\"] = \"SCHEDULE\" elif \"BUDGET\" in response.content: state[\"next_action\"] = \"BUDGET\" elif \"QUALITY\" in response.content: state[\"next_action\"] = \"QUALITY\" else: state[\"next_action\"] = \"END\" return state def handle_scheduling(state: ProjectState) -\u003e ProjectState: \"\"\"Handle scheduling tasks\"\"\" tasks = [Task(**task) for task in state[\"tasks\"]] schedule = SchedulingAgent.create_schedule(tasks) state[\"schedule\"] = asdict(schedule) state[\"next_action\"] = \"BUDGET\" return state def handle_budgeting(state: ProjectState) -\u003e ProjectState: \"\"\"Handle budget analysis\"\"\" tasks = [Task(**task) for task in state[\"tasks\"]] budget = BudgetingAgent.analyze_budget(tasks, ScheduleReport(**state[\"schedule\"])) state[\"budget\"] = asdict(budget) state[\"next_action\"] = \"QUALITY\" return state def handle_quality(state: ProjectState) -\u003e ProjectState: \"\"\"Handle quality assessment\"\"\" quality_metrics = QualityAgent.assess_quality(state) state[\"quality_metrics\"] = quality_metrics state[\"next_action\"] = \"END\" return state def router(state: ProjectState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(ProjectState) # Add nodes workflow.add_node(\"coordinate\", meta_agent_coordinator) workflow.add_node(\"schedule\", handle_scheduling) workflow.add_node(\"budget\", handle_budgeting) workflow.add_node(\"quality\", handle_quality) # Add edges workflow.add_edge(\"coordinate\", router) workflow.add_edge(\"schedule\", router) workflow.add_edge(\"budget\", router) workflow.add_edge(\"quality\", router) # Set entry point workflow.set_entry_point(\"coordinate\") # Create conditional edges workflow.add_conditional_edges( \"coordinate\", router, { \"SCHEDULE\": \"schedule\", \"BUDGET\": \"budget\", \"QUALITY\": \"quality\", \"END\": END } ) workflow.add_conditional_edges( \"schedule\", router, { \"BUDGET\": \"budget\", \"END\": END } ) workflow.add_conditional_edges( \"budget\", router, { \"QUALITY\": \"quality\", \"END\": END } ) workflow.add_conditional_edges( \"quality\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state with example project tasks initial_state = { \"messages\": [], \"current_request\": \"Create project schedule and analyze budget\", \"tasks\": [ { \"id\": \"T1\", \"name\": \"Requirements Analysis\", \"description\": \"Gather and analyze project requirements\", \"duration\": 5, \"dependencies\": [], \"assigned_to\": \"Analysis Team\", \"status\": \"Not Started\", \"estimated_cost\": 20000 }, { \"id\": \"T2\", \"name\": \"System Design\", \"description\": \"Create system architecture and design\", \"duration\": 10, \"dependencies\": [\"T1\"], \"assigned_to\": \"Design Team\", \"status\": \"Not Started\", \"estimated_cost\": 30000 }, { \"id\": \"T3\", \"name\": \"Implementation\", \"description\": \"Develop the system\", \"duration\": 20, \"dependencies\": [\"T2\"], \"assigned_to\": \"Development Team\", \"status\": \"Not Started\", \"estimated_cost\": 50000 } ], \"schedule\": None, \"budget\": None, \"quality_metrics\": {}, \"next_action\": \"COORDINATE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 5. ระบบวางแผนและปฏิบัติ (Planner-Executor) รูปแบบนี้แยกการทำงานเป็นสองส่วนชัดเจน คือ:\nส่วนวางแผน:\nวิเคราะห์สถานการณ์ กำหนดกลยุทธ์ จัดลำดับความสำคัญของงาน ส่วนปฏิบัติ:\nดำเนินการตามแผน รายงานความคืบหน้า แจ้งเตือนเมื่อพบปัญหา ระบบ AI ที่เล่นเกมเป็นตัวอย่างที่ดี โดยส่วนวางแผนจะคิดกลยุทธ์การเล่น และส่วนปฏิบัติจะควบคุมการเคลื่อนไหวในเกม\nตัวอย่าง Planner-Executor from typing import Dict, List, TypedDict, Optional, Tuple import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import os # Define game-specific structures @dataclass class GameState: board: List[List[str]] # tic-tac-toe board current_player: str moves_made: int game_over: bool @dataclass class Strategy: main_goal: str priority_positions: List[Tuple[int, int]] fallback_positions: List[Tuple[int, int]] expected_outcome: str @dataclass class Move: position: Tuple[int, int] player: str priority: int reasoning: str class AIState(TypedDict): messages: List[str] game_state: Dict current_strategy: Optional[Dict] planned_move: Optional[Dict] execution_result: Optional[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", # หรือโมเดลอื่นที่ OpenRouter รองรับ temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", # your website URL \"X-Title\": \"Tic-Tac-Toe AI\" # your app name } ) class GameManager: \"\"\"Manages the game state and rules\"\"\" @staticmethod def create_empty_board() -\u003e List[List[str]]: return [[\" \" for _ in range(3)] for _ in range(3)] @staticmethod def is_valid_move(board: List[List[str]], position: Tuple[int, int]) -\u003e bool: row, col = position if row \u003c 0 or row \u003e 2 or col \u003c 0 or col \u003e 2: return False return board[row][col] == \" \" @staticmethod def make_move(board: List[List[str]], position: Tuple[int, int], player: str) -\u003e List[List[str]]: new_board = [row[:] for row in board] row, col = position new_board[row][col] = player return new_board @staticmethod def check_winner(board: List[List[str]]) -\u003e Optional[str]: # Check rows for row in board: if row[0] == row[1] == row[2] != \" \": return row[0] # Check columns for col in range(3): if board[0][col] == board[1][col] == board[2][col] != \" \": return board[0][col] # Check diagonals if board[0][0] == board[1][1] == board[2][2] != \" \": return board[0][0] if board[0][2] == board[1][1] == board[2][0] != \" \": return board[0][2] return None class Planner: \"\"\"Strategic planner for the game\"\"\" @staticmethod def analyze_game_state(state: GameState) -\u003e Strategy: board_str = \"\\n\".join([\"|\".join(row) for row in state.board]) messages = [ HumanMessage(content=f\"\"\" Analyze this Tic-Tac-Toe board and create a strategic plan: Current Board: {board_str} Player: {state.current_player} Moves Made: {state.moves_made} Please provide a structured strategy with: 1. Main Goal: [win/block/develop] 2. Priority Positions: Provide coordinates as tuples (row, col), 0-2 3. Fallback Positions: Provide alternative coordinates 4. Expected Outcome: [Victory/Draw/Continue] Consider: - Winning opportunities - Blocking opponent's winning moves - Center and corner control - Development of winning patterns \"\"\") ] response = llm.invoke(messages) # Parse response to create strategy (simplified) # In real implementation, would use more robust parsing strategy = Strategy( main_goal=\"Win in next move\" if \"win\" in response.content.lower() else \"Block opponent\", priority_positions=[(1, 1), (0, 0), (2, 2)], # Example positions fallback_positions=[(0, 1), (1, 0), (1, 2), (2, 1)], expected_outcome=\"Victory\" if \"victory\" in response.content.lower() else \"Continue\" ) return strategy class Executor: \"\"\"Tactical executor of planned moves\"\"\" @staticmethod def execute_move(game_state: GameState, strategy: Strategy) -\u003e Move: # Try priority positions first for pos in strategy.priority_positions: if GameManager.is_valid_move(game_state.board, pos): return Move( position=pos, player=game_state.current_player, priority=1, reasoning=\"Priority position available\" ) # Try fallback positions for pos in strategy.fallback_positions: if GameManager.is_valid_move(game_state.board, pos): return Move( position=pos, player=game_state.current_player, priority=2, reasoning=\"Fallback position used\" ) # Find any valid move if nothing else is available for i in range(3): for j in range(3): if GameManager.is_valid_move(game_state.board, (i, j)): return Move( position=(i, j), player=game_state.current_player, priority=3, reasoning=\"Last resort move\" ) raise ValueError(\"No valid moves available\") def strategic_planning(state: AIState) -\u003e AIState: \"\"\" Strategic planning phase \"\"\" game_state = GameState(**state[\"game_state\"]) strategy = Planner.analyze_game_state(game_state) state[\"current_strategy\"] = asdict(strategy) state[\"next_action\"] = \"EXECUTE\" return state def tactical_execution(state: AIState) -\u003e AIState: \"\"\" Tactical execution phase \"\"\" game_state = GameState(**state[\"game_state\"]) strategy = Strategy(**state[\"current_strategy\"]) # Execute the planned move move = Executor.execute_move(game_state, strategy) # Update game state with the executed move new_board = GameManager.make_move( game_state.board, move.position, game_state.current_player ) # Update state state[\"game_state\"][\"board\"] = new_board state[\"game_state\"][\"moves_made\"] += 1 state[\"execution_result\"] = asdict(move) # Check for game end conditions winner = GameManager.check_winner(new_board) if winner or state[\"game_state\"][\"moves_made\"] \u003e= 9: state[\"game_state\"][\"game_over\"] = True state[\"next_action\"] = \"END\" else: state[\"next_action\"] = \"PLAN\" return state def router(state: AIState) -\u003e str: \"\"\" Route to the next step based on the current state \"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(AIState) # Add nodes workflow.add_node(\"plan\", strategic_planning) workflow.add_node(\"execute\", tactical_execution) # Add edges workflow.add_edge(\"plan\", router) workflow.add_edge(\"execute\", router) # Set entry point workflow.set_entry_point(\"plan\") # Create conditional edges workflow.add_conditional_edges( \"plan\", router, { \"EXECUTE\": \"execute\", \"END\": END } ) workflow.add_conditional_edges( \"execute\", router, { \"PLAN\": \"plan\", \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state with empty game initial_state = { \"messages\": [], \"game_state\": { \"board\": GameManager.create_empty_board(), \"current_player\": \"X\", \"moves_made\": 0, \"game_over\": False }, \"current_strategy\": None, \"planned_move\": None, \"execution_result\": None, \"next_action\": \"PLAN\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 6. Reflexive Agent - ระบบตอบสนองอัตโนมัติ รูปแบบนี้เน้นการตอบสนองที่รวดเร็วต่อการเปลี่ยนแปลง โดย:\nตรวจจับการเปลี่ยนแปลงในสภาพแวดล้อม ตอบสนองทันทีตามกฎที่กำหนดไว้ ไม่ต้องใช้เวลาคิดวิเคราะห์มาก หุ่นยนต์ดูดฝุ่นที่หลบสิ่งกีดขวางอัตโนมัติเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Reflexive Agent from typing import Dict, List, TypedDict, Tuple, Optional from enum import Enum import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain.chat_models import ChatOpenRouter from langchain_core.messages import HumanMessage, AIMessage import random import os # Define enums for direction and action class Direction(str, Enum): NORTH = \"NORTH\" SOUTH = \"SOUTH\" EAST = \"EAST\" WEST = \"WEST\" class Action(str, Enum): MOVE_FORWARD = \"MOVE_FORWARD\" TURN_LEFT = \"TURN_LEFT\" TURN_RIGHT = \"TURN_RIGHT\" CLEAN = \"CLEAN\" RETURN_HOME = \"RETURN_HOME\" # Define data structures @dataclass class Position: x: int y: int @dataclass class SensorData: front_obstacle: bool left_obstacle: bool right_obstacle: bool dirt_detected: bool battery_level: int @dataclass class RobotState: position: Position direction: Direction battery_level: int cleaned_positions: List[Tuple[int, int]] class AgentState(TypedDict): messages: List[str] robot_state: Dict sensor_data: Dict action_taken: Optional[str] next_action: str # Simulated environment class Environment: def __init__(self, size: int = 10): self.size = size self.obstacles = self._generate_obstacles() self.dirt_locations = self._generate_dirt() def _generate_obstacles(self) -\u003e List[Tuple[int, int]]: # Generate random obstacles obstacles = [] num_obstacles = self.size * 2 for _ in range(num_obstacles): x = random.randint(0, self.size-1) y = random.randint(0, self.size-1) if (x, y) != (0, 0): # Keep starting position clear obstacles.append((x, y)) return obstacles def _generate_dirt(self) -\u003e List[Tuple[int, int]]: # Generate random dirt locations dirt = [] num_dirt = self.size * 3 for _ in range(num_dirt): x = random.randint(0, self.size-1) y = random.randint(0, self.size-1) if (x, y) not in self.obstacles: dirt.append((x, y)) return dirt def get_sensor_data(self, position: Position, direction: Direction) -\u003e SensorData: # Check for obstacles in adjacent positions front_pos = self._get_adjacent_position(position, direction) left_pos = self._get_adjacent_position(position, self._turn_left(direction)) right_pos = self._get_adjacent_position(position, self._turn_right(direction)) return SensorData( front_obstacle=self._is_obstacle(front_pos), left_obstacle=self._is_obstacle(left_pos), right_obstacle=self._is_obstacle(right_pos), dirt_detected=(position.x, position.y) in self.dirt_locations, battery_level=100 # Simplified battery simulation ) def _is_obstacle(self, position: Position) -\u003e bool: # Check if position is obstacle or out of bounds if (position.x \u003c 0 or position.x \u003e= self.size or position.y \u003c 0 or position.y \u003e= self.size): return True return (position.x, position.y) in self.obstacles @staticmethod def _get_adjacent_position(pos: Position, direction: Direction) -\u003e Position: if direction == Direction.NORTH: return Position(pos.x, pos.y + 1) elif direction == Direction.SOUTH: return Position(pos.x, pos.y - 1) elif direction == Direction.EAST: return Position(pos.x + 1, pos.y) else: # WEST return Position(pos.x - 1, pos.y) @staticmethod def _turn_left(direction: Direction) -\u003e Direction: turns = { Direction.NORTH: Direction.WEST, Direction.WEST: Direction.SOUTH, Direction.SOUTH: Direction.EAST, Direction.EAST: Direction.NORTH } return turns[direction] @staticmethod def _turn_right(direction: Direction) -\u003e Direction: turns = { Direction.NORTH: Direction.EAST, Direction.EAST: Direction.SOUTH, Direction.SOUTH: Direction.WEST, Direction.WEST: Direction.NORTH } return turns[direction] # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Robot Vacuum AI\" } ) class StrategicAnalyzer: \"\"\"Analyzes environment and suggests optimal strategies\"\"\" @staticmethod def analyze_situation( sensor_data: SensorData, robot_state: RobotState, env_size: int ) -\u003e Dict: # Create a map representation map_data = [[\"?\" for _ in range(env_size)] for _ in range(env_size)] map_data[robot_state.position.y][robot_state.position.x] = \"R\" for x, y in robot_state.cleaned_positions: if map_data[y][x] != \"R\": map_data[y][x] = \"C\" map_str = \"\\n\".join([\" \".join(row) for row in map_data]) messages = [ HumanMessage(content=f\"\"\" Analyze the robot vacuum's situation and suggest a strategy: Current Map (R=Robot, C=Cleaned, ?=Unknown): {map_str} Sensor Data: - Front obstacle: {sensor_data.front_obstacle} - Left obstacle: {sensor_data.left_obstacle} - Right obstacle: {sensor_data.right_obstacle} - Dirt detected: {sensor_data.dirt_detected} - Battery level: {sensor_data.battery_level}% Robot State: - Position: ({robot_state.position.x}, {robot_state.position.y}) - Direction: {robot_state.direction} - Cleaned positions: {len(robot_state.cleaned_positions)} Suggest: 1. Primary objective 2. Movement pattern 3. Risk assessment 4. Efficiency recommendations \"\"\") ] response = llm.invoke(messages) # Parse LLM response (simplified) return { \"strategy\": response.content, \"risk_level\": \"LOW\" if sensor_data.battery_level \u003e 50 else \"MEDIUM\", \"recommended_pattern\": \"SPIRAL\" if \"spiral\" in response.content.lower() else \"ZIGZAG\" } class ReflexiveRules: \"\"\"Define reflexive rules for the robot vacuum\"\"\" def __init__(self): self.analyzer = StrategicAnalyzer() def determine_action( self, sensor_data: SensorData, robot_state: RobotState, env_size: int ) -\u003e Tuple[Action, str]: # Get strategic analysis for complex decisions analysis = self.analyzer.analyze_situation(sensor_data, robot_state, env_size) # Priority 1: Handle low battery if sensor_data.battery_level \u003c 20: return Action.RETURN_HOME, \"Low battery, returning to charging station\" # Priority 2: Clean dirt if detected if sensor_data.dirt_detected: return Action.CLEAN, \"Dirt detected, cleaning current position\" # Priority 3: Navigate based on strategic analysis and obstacles if \"SPIRAL\" in analysis[\"recommended_pattern\"]: if not sensor_data.right_obstacle: return Action.TURN_RIGHT, \"Following spiral pattern\" elif not sensor_data.front_obstacle: return Action.MOVE_FORWARD, \"Following spiral pattern\" # Default obstacle avoidance if sensor_data.front_obstacle: if not sensor_data.right_obstacle: return Action.TURN_RIGHT, f\"Avoiding obstacle: {analysis['strategy']}\" elif not sensor_data.left_obstacle: return Action.TURN_LEFT, f\"Avoiding obstacle: {analysis['strategy']}\" else: return Action.TURN_LEFT, \"Surrounded by obstacles, turning around\" # Default: Move forward return Action.MOVE_FORWARD, f\"Following {analysis['recommended_pattern']} pattern\" def sense_and_act(state: AgentState) -\u003e AgentState: \"\"\" Main function for the reflexive agent - sense environment and act immediately \"\"\" # Get current state robot_state = RobotState(**state[\"robot_state\"]) sensor_data = SensorData(**state[\"sensor_data\"]) # Create rules engine and determine action rules = ReflexiveRules() action, reasoning = rules.determine_action(sensor_data, robot_state, 10) # 10 is env_size # Execute action and update state if action == Action.MOVE_FORWARD: new_position = Environment._get_adjacent_position( robot_state.position, robot_state.direction ) if not Environment._is_obstacle(Position(new_position.x, new_position.y)): robot_state.position = new_position elif action == Action.TURN_LEFT: robot_state.direction = Environment._turn_left(robot_state.direction) elif action == Action.TURN_RIGHT: robot_state.direction = Environment._turn_right(robot_state.direction) elif action == Action.CLEAN: pos = (robot_state.position.x, robot_state.position.y) if pos not in robot_state.cleaned_positions: robot_state.cleaned_positions.append(pos) # Update state state[\"robot_state\"] = asdict(robot_state) state[\"action_taken\"] = action state[\"messages\"].append(reasoning) # Determine if we should continue or end if action == Action.RETURN_HOME and (robot_state.position.x, robot_state.position.y) == (0, 0): state[\"next_action\"] = \"END\" else: state[\"next_action\"] = \"CONTINUE\" return state def router(state: AgentState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(AgentState) # Add node workflow.add_node(\"sense_and_act\", sense_and_act) # Add edge workflow.add_edge(\"sense_and_act\", router) # Set entry point workflow.set_entry_point(\"sense_and_act\") # Create conditional edges workflow.add_conditional_edges( \"sense_and_act\", router, { \"CONTINUE\": \"sense_and_act\", \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize environment env = Environment(size=10) # Initialize state initial_state = { \"messages\": [], \"robot_state\": { \"position\": asdict(Position(0, 0)), \"direction\": Direction.NORTH, \"battery_level\": 100, \"cleaned_positions\": [] }, \"sensor_data\": asdict(env.get_sensor_data(Position(0, 0), Direction.NORTH)), \"action_taken\": None, \"next_action\": \"CONTINUE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) # Update sensor data for next iteration robot_state = RobotState(**output[\"robot_state\"]) output[\"sensor_data\"] = asdict(env.get_sensor_data( Position(**robot_state.position), robot_state.direction )) 7. Interactive Learning - การเรียนรู้แบบมีปฏิสัมพันธ์ รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบพัฒนาได้จากการมีปฏิสัมพันธ์กับผู้ใช้ โดย:\nรับข้อเสนอแนะจากผู้ใช้ วิเคราะห์และเรียนรู้จากข้อมูลป้อนกลับ ปรับปรุงพฤติกรรมให้ตรงกับความต้องการ ระบบแปลภาษาที่เรียนรู้จากการแก้ไขของผู้ใช้เป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Interactive Learning from typing import Dict, List, TypedDict, Optional from datetime import datetime import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import numpy as np from collections import defaultdict import os # Define data structures (dataclasses remain the same) @dataclass class Translation: original_text: str translated_text: str source_language: str target_language: str confidence_score: float timestamp: str @dataclass class UserFeedback: translation_id: str corrected_text: str feedback_type: str # GRAMMAR, CONTEXT, STYLE, etc. comment: str timestamp: str @dataclass class LearningPattern: pattern_type: str original_phrase: str corrected_phrase: str context: str frequency: int confidence: float class TranslatorState(TypedDict): messages: List[str] current_text: str source_language: str target_language: str translation_history: List[Dict] feedback_history: List[Dict] learning_patterns: Dict[str, List[Dict]] current_translation: Optional[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.3, headers={ \"HTTP-Referer\": \"http://localhost:8000\", # your website URL \"X-Title\": \"Translation Assistant\" # your app name } ) class TranslationMemory: \"\"\"Manages translation patterns and corrections\"\"\" def __init__(self): self.patterns = defaultdict(list) def add_pattern(self, pattern: LearningPattern): key = f\"{pattern.pattern_type}:{pattern.original_phrase}\" existing = next( (p for p in self.patterns[key] if p[\"corrected_phrase\"] == pattern.corrected_phrase), None ) if existing: existing[\"frequency\"] += 1 existing[\"confidence\"] = min(1.0, existing[\"confidence\"] + 0.1) else: self.patterns[key].append(asdict(pattern)) def get_relevant_patterns(self, text: str, pattern_type: str) -\u003e List[Dict]: relevant = [] for key, patterns in self.patterns.items(): if key.startswith(f\"{pattern_type}:\"): original = key.split(\":\", 1)[1] if original.lower() in text.lower(): relevant.extend(patterns) return relevant class FeedbackAnalyzer: \"\"\"Analyzes user feedback to extract learning patterns\"\"\" @staticmethod def analyze_feedback( original: Translation, feedback: UserFeedback ) -\u003e List[LearningPattern]: messages = [ HumanMessage(content=f\"\"\" Analyze this translation pair and identify improvement patterns: Original Text: {original.original_text} Initial Translation: {original.translated_text} Corrected Translation: {feedback.corrected_text} Feedback Type: {feedback.feedback_type} User Comment: {feedback.comment} Please identify patterns in these categories: 1. GRAMMAR: Grammar rules and structures 2. CONTEXT: Context-specific word choices 3. STYLE: Writing style and natural expression For each identified pattern, provide: - Pattern type (GRAMMAR/CONTEXT/STYLE) - Original phrase - Corrected phrase - Explanation of the improvement \"\"\") ] response = llm.invoke(messages) # Extract patterns (simplified version) patterns = [] for feedback_type in [\"GRAMMAR\", \"CONTEXT\", \"STYLE\"]: if feedback_type.lower() in response.content.lower(): pattern = LearningPattern( pattern_type=feedback_type, original_phrase=original.translated_text, corrected_phrase=feedback.corrected_text, context=original.original_text, frequency=1, confidence=0.5 ) patterns.append(pattern) return patterns def translate_with_memory(state: TranslatorState) -\u003e TranslatorState: \"\"\" Translate text using learned patterns and translation memory \"\"\" memory = TranslationMemory() # Load patterns from state for pattern_type, patterns in state[\"learning_patterns\"].items(): for pattern in patterns: memory.add_pattern(LearningPattern(**pattern)) # Get relevant patterns relevant_patterns = [] for pattern_type in [\"GRAMMAR\", \"CONTEXT\", \"STYLE\"]: relevant_patterns.extend( memory.get_relevant_patterns(state[\"current_text\"], pattern_type) ) # Create translation prompt with patterns messages = [ HumanMessage(content=f\"\"\" Translate the following text from {state['source_language']} to {state['target_language']}. Text to translate: {state['current_text']} Consider these learned patterns: {json.dumps(relevant_patterns, indent=2)} Please provide: 1. Translation: (your translation) 2. Confidence: (score between 0-1) 3. Applied Patterns: (list which patterns were used) Format your response with clear sections. \"\"\") ] response = llm.invoke(messages) # Create translation object (with improved parsing) translation = Translation( original_text=state[\"current_text\"], translated_text=response.content.split(\"Translation:\")[1].split(\"Confidence:\")[0].strip(), source_language=state[\"source_language\"], target_language=state[\"target_language\"], confidence_score=float(response.content.split(\"Confidence:\")[1].split(\"\\n\")[0].strip()), timestamp=datetime.now().isoformat() ) state[\"current_translation\"] = asdict(translation) state[\"translation_history\"].append(asdict(translation)) state[\"next_action\"] = \"AWAIT_FEEDBACK\" return state def process_feedback(state: TranslatorState) -\u003e TranslatorState: \"\"\" Process user feedback and update learning patterns \"\"\" if not state[\"feedback_history\"]: state[\"next_action\"] = \"END\" return state # Get latest feedback feedback = UserFeedback(**state[\"feedback_history\"][-1]) original = Translation(**state[\"current_translation\"]) # Analyze feedback analyzer = FeedbackAnalyzer() new_patterns = analyzer.analyze_feedback(original, feedback) # Update learning patterns memory = TranslationMemory() for pattern in new_patterns: pattern_type = pattern.pattern_type.lower() if pattern_type not in state[\"learning_patterns\"]: state[\"learning_patterns\"][pattern_type] = [] memory.add_pattern(pattern) state[\"learning_patterns\"][pattern_type].append(asdict(pattern)) state[\"next_action\"] = \"END\" return state def process_feedback(state: TranslatorState) -\u003e TranslatorState: \"\"\" Process user feedback and update learning patterns \"\"\" if not state[\"feedback_history\"]: state[\"next_action\"] = \"END\" return state # Get latest feedback feedback = UserFeedback(**state[\"feedback_history\"][-1]) original = Translation(**state[\"current_translation\"]) # Analyze feedback analyzer = FeedbackAnalyzer() new_patterns = analyzer.analyze_feedback(original, feedback) # Update learning patterns memory = TranslationMemory() for pattern in new_patterns: pattern_type = pattern.pattern_type.lower() if pattern_type not in state[\"learning_patterns\"]: state[\"learning_patterns\"][pattern_type] = [] memory.add_pattern(pattern) state[\"learning_patterns\"][pattern_type].append(asdict(pattern)) state[\"next_action\"] = \"END\" return state def router(state: TranslatorState) -\u003e str: \"\"\" Route to the next step based on the current state \"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(TranslatorState) # Add nodes workflow.add_node(\"translate\", translate_with_memory) workflow.add_node(\"feedback\", process_feedback) # Add edges workflow.add_edge(\"translate\", router) workflow.add_edge(\"feedback\", router) # Set entry point workflow.set_entry_point(\"translate\") # Create conditional edges workflow.add_conditional_edges( \"translate\", router, { \"AWAIT_FEEDBACK\": \"feedback\", \"END\": END } ) workflow.add_conditional_edges( \"feedback\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"current_text\": \"The cat sat on the mat.\", \"source_language\": \"English\", \"target_language\": \"Thai\", \"translation_history\": [], \"feedback_history\": [ { \"translation_id\": \"1\", \"corrected_text\": \"แมวนั่งอยู่บนเสื่อ\", \"feedback_type\": \"STYLE\", \"comment\": \"More natural Thai expression\", \"timestamp\": datetime.now().isoformat() } ], \"learning_patterns\": {}, \"current_translation\": None, \"next_action\": \"TRANSLATE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 8. การแยกงานเป็นลำดับชั้น (Hierarchical Task Decomposition) รูปแบบนี้ช่วยจัดการงานที่ซับซ้อนได้อย่างมีประสิทธิภาพ โดย:\nแยกงานใหญ่เป็นงานย่อยที่จัดการได้ง่ายขึ้น จัดลำดับความสำคัญของงานย่อย ติดตามความคืบหน้าในแต่ละระดับ ผู้ช่วย AI ที่ช่วยจัดงานอีเวนต์ โดยแบ่งเป็นการจองสถานที่ ส่งการ์ดเชิญ และจัดตารางงาน เป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Hierarchical Task Decomposition from typing import Dict, List, TypedDict, Optional from datetime import datetime, timedelta import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import os # Define data structures @dataclass class Task: id: str name: str description: str priority: int # 1 (highest) to 5 (lowest) status: str # NOT_STARTED, IN_PROGRESS, COMPLETED parent_id: Optional[str] subtasks: List[str] dependencies: List[str] assigned_to: str deadline: str progress: int # 0-100% @dataclass class TaskUpdate: task_id: str status: str progress: int notes: str timestamp: str class PlannerState(TypedDict): messages: List[str] event_details: Dict tasks: Dict[str, Dict] updates: List[Dict] current_focus: Optional[str] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", # your website URL \"X-Title\": \"Event Planning Assistant\" # your app name } ) class TaskDecomposer: \"\"\"Handles breaking down complex tasks into subtasks\"\"\" @staticmethod def decompose_event_planning(event_details: Dict) -\u003e List[Task]: messages = [ HumanMessage(content=f\"\"\" Please decompose this event into a structured task hierarchy: EVENT DETAILS: {json.dumps(event_details, indent=2)} MAIN CATEGORIES: 1. Venue Management 2. Guest Management 3. Logistics \u0026 Schedule 4. Budget \u0026 Contracts For each task, provide: 1. Task ID (unique identifier) 2. Task Name 3. Description (clear and actionable) 4. Priority (1-5, where 1 is highest) 5. Dependencies (list of task IDs) 6. Timeline and deadlines 7. Team assignment Ensure tasks are: - Well-defined and measurable - Properly sequenced with dependencies - Assigned appropriate priorities - Given realistic timelines Format each task in a structured way. \"\"\") ] response = llm.invoke(messages) # Create task hierarchy (simplified version - would parse LLM response in full implementation) tasks = [ Task( id=\"VENUE_MAIN\", name=\"Venue Management\", description=\"Overall venue selection and management\", priority=1, status=\"NOT_STARTED\", parent_id=None, subtasks=[\"VENUE_SEARCH\", \"VENUE_BOOK\", \"VENUE_SETUP\"], dependencies=[], assigned_to=\"Venue Team\", deadline=(datetime.now() + timedelta(days=30)).isoformat(), progress=0 ), Task( id=\"VENUE_SEARCH\", name=\"Venue Search\", description=\"Research and visit potential venues\", priority=1, status=\"NOT_STARTED\", parent_id=\"VENUE_MAIN\", subtasks=[], dependencies=[], assigned_to=\"Venue Team\", deadline=(datetime.now() + timedelta(days=7)).isoformat(), progress=0 ), # Additional tasks would be parsed from LLM response ] return tasks class TaskPrioritizer: \"\"\"Manages task priorities and dependencies\"\"\" @staticmethod def calculate_critical_path(tasks: Dict[str, Task]) -\u003e List[str]: critical_tasks = [] remaining_tasks = set(tasks.keys()) while remaining_tasks: for task_id in list(remaining_tasks): task = tasks[task_id] if all(dep not in remaining_tasks for dep in task.dependencies): critical_tasks.append(task_id) remaining_tasks.remove(task_id) return critical_tasks @staticmethod def update_priorities(tasks: Dict[str, Task]) -\u003e Dict[str, Task]: critical_path = TaskPrioritizer.calculate_critical_path(tasks) # Adjust priorities based on critical path for i, task_id in enumerate(critical_path): tasks[task_id].priority = min(tasks[task_id].priority, 1 + i // 3) return tasks class ProgressTracker: \"\"\"Tracks and updates task progress\"\"\" @staticmethod def update_task_progress( tasks: Dict[str, Task], update: TaskUpdate ) -\u003e Dict[str, Task]: if update.task_id not in tasks: return tasks # Update specific task task = tasks[update.task_id] task.status = update.status task.progress = update.progress # Update parent task progress if task.parent_id: parent = tasks[task.parent_id] subtask_progress = [ tasks[subtask_id].progress for subtask_id in parent.subtasks ] parent.progress = sum(subtask_progress) // len(subtask_progress) return tasks @staticmethod def get_status_report(tasks: Dict[str, Task]) -\u003e Dict: return { \"total_tasks\": len(tasks), \"completed\": sum(1 for t in tasks.values() if t.status == \"COMPLETED\"), \"in_progress\": sum(1 for t in tasks.values() if t.status == \"IN_PROGRESS\"), \"not_started\": sum(1 for t in tasks.values() if t.status == \"NOT_STARTED\"), \"overall_progress\": sum(t.progress for t in tasks.values()) // len(tasks) } def decompose_tasks(state: PlannerState) -\u003e PlannerState: \"\"\" Initial task decomposition \"\"\" decomposer = TaskDecomposer() tasks = decomposer.decompose_event_planning(state[\"event_details\"]) # Convert tasks to dictionary format state[\"tasks\"] = {task.id: asdict(task) for task in tasks} state[\"next_action\"] = \"PRIORITIZE\" return state def prioritize_tasks(state: PlannerState) -\u003e PlannerState: \"\"\" Prioritize tasks and calculate critical path \"\"\" # Convert dict back to Task objects tasks = { task_id: Task(**task_data) for task_id, task_data in state[\"tasks\"].items() } # Update priorities prioritizer = TaskPrioritizer() tasks = prioritizer.update_priorities(tasks) # Convert back to dict format state[\"tasks\"] = {task_id: asdict(task) for task_id, task in tasks.items()} state[\"next_action\"] = \"UPDATE_PROGRESS\" return state def update_progress(state: PlannerState) -\u003e PlannerState: \"\"\" Update task progress based on recent updates \"\"\" if not state[\"updates\"]: state[\"next_action\"] = \"END\" return state # Convert dict back to Task objects tasks = { task_id: Task(**task_data) for task_id, task_data in state[\"tasks\"].items() } # Process each update tracker = ProgressTracker() for update_data in state[\"updates\"]: update = TaskUpdate(**update_data) tasks = tracker.update_task_progress(tasks, update) # Get status report status_report = tracker.get_status_report(tasks) # Update state state[\"tasks\"] = {task_id: asdict(task) for task_id, task in tasks.items()} state[\"status_report\"] = status_report state[\"next_action\"] = \"END\" return state def router(state: PlannerState) -\u003e str: \"\"\" Route to the next step based on the current state \"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(PlannerState) # Add nodes workflow.add_node(\"decompose\", decompose_tasks) workflow.add_node(\"prioritize\", prioritize_tasks) workflow.add_node(\"progress\", update_progress) # Add edges workflow.add_edge(\"decompose\", router) workflow.add_edge(\"prioritize\", router) workflow.add_edge(\"progress\", router) # Set entry point workflow.set_entry_point(\"decompose\") # Create conditional edges workflow.add_conditional_edges( \"decompose\", router, { \"PRIORITIZE\": \"prioritize\", \"END\": END } ) workflow.add_conditional_edges( \"prioritize\", router, { \"UPDATE_PROGRESS\": \"progress\", \"END\": END } ) workflow.add_conditional_edges( \"progress\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state with example event initial_state = { \"messages\": [], \"event_details\": { \"name\": \"Tech Conference 2025\", \"date\": \"2025-06-15\", \"expected_attendees\": 200, \"type\": \"Conference\", \"budget\": 50000, \"location_preference\": \"City Center\", \"special_requirements\": [\"AV Equipment\", \"Catering\", \"Registration Desk\"] }, \"tasks\": {}, \"updates\": [ { \"task_id\": \"VENUE_SEARCH\", \"status\": \"COMPLETED\", \"progress\": 100, \"notes\": \"Selected Convention Center A\", \"timestamp\": datetime.now().isoformat() } ], \"current_focus\": None, \"next_action\": \"DECOMPOSE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 9. ระบบที่ทำงานตามเป้าหมาย (Goal-Oriented Agent) รูปแบบนี้เน้นการทำงานที่มีจุดมุ่งหมายชัดเจน โดย:\nกำหนดเป้าหมายที่ต้องการ วางแผนการทำงานเพื่อให้บรรลุเป้าหมาย ปรับเปลี่ยนกลยุทธ์ตามสถานการณ์ ระบบวางแผนการเงินที่ปรับกลยุทธ์การลงทุนเพื่อให้บรรลุเป้าหมายการออมเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Goal-Oriented Agent from typing import Dict, List, TypedDict, Optional from datetime import datetime, timedelta import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import os # Define data structures @dataclass class FinancialGoal: id: str name: str target_amount: float current_amount: float target_date: str priority: int # 1 (highest) to 5 (lowest) risk_tolerance: str # LOW, MEDIUM, HIGH progress: float # Percentage @dataclass class Investment: type: str # STOCKS, BONDS, SAVINGS, etc. amount: float expected_return: float risk_level: str liquidity: str allocation_percentage: float @dataclass class Strategy: goal_id: str investments: List[Investment] monthly_contribution: float expected_timeline: int # months risk_assessment: str contingency_plans: List[str] class PlannerState(TypedDict): messages: List[str] financial_goals: Dict[str, Dict] current_portfolio: Dict[str, float] market_conditions: Dict[str, str] strategies: Dict[str, Dict] analysis_results: Optional[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Financial Planning Assistant\" } ) class GoalAnalyzer: \"\"\"Analyzes financial goals and current progress\"\"\" @staticmethod def analyze_goal_progress(goal: FinancialGoal, strategy: Strategy) -\u003e Dict: messages = [ HumanMessage(content=f\"\"\" Analyze progress towards this financial goal: Goal Details: - Name: {goal.name} - Target: ${goal.target_amount:,.2f} - Current: ${goal.current_amount:,.2f} - Deadline: {goal.target_date} - Risk Tolerance: {goal.risk_tolerance} Current Strategy: - Monthly Contribution: ${strategy.monthly_contribution:,.2f} - Timeline: {strategy.expected_timeline} months - Investment Mix: {json.dumps([asdict(inv) for inv in strategy.investments], indent=2)} Please analyze: 1. Progress status and likelihood of achievement 2. Risk alignment 3. Required adjustments 4. Recommendations for optimization \"\"\") ] response = llm.invoke(messages) # Parse response for analysis results return { \"status\": \"ON_TRACK\" if goal.progress \u003e= (goal.current_amount / goal.target_amount * 100) else \"NEEDS_ADJUSTMENT\", \"analysis\": response.content, \"requires_strategy_update\": \"adjustment\" in response.content.lower() } class StrategyPlanner: \"\"\"Plans and adjusts investment strategies\"\"\" @staticmethod def create_strategy( goal: FinancialGoal, current_portfolio: Dict[str, float], market_conditions: Dict[str, str] ) -\u003e Strategy: messages = [ HumanMessage(content=f\"\"\" Create an investment strategy for this financial goal: Goal: {json.dumps(asdict(goal), indent=2)} Current Portfolio: {json.dumps(current_portfolio, indent=2)} Market Conditions: {json.dumps(market_conditions, indent=2)} Provide a comprehensive strategy including: 1. Asset allocation 2. Monthly contribution requirements 3. Risk management approach 4. Timeline and milestones 5. Contingency plans Consider: - Risk tolerance level - Time horizon - Current market conditions - Liquidity needs \"\"\") ] response = llm.invoke(messages) # Create strategy (simplified version - would parse LLM response in real implementation) return Strategy( goal_id=goal.id, investments=[ Investment( type=\"STOCKS\", amount=goal.target_amount * 0.6, expected_return=0.08, risk_level=\"MEDIUM\", liquidity=\"MEDIUM\", allocation_percentage=60 ), Investment( type=\"BONDS\", amount=goal.target_amount * 0.3, expected_return=0.04, risk_level=\"LOW\", liquidity=\"MEDIUM\", allocation_percentage=30 ), Investment( type=\"SAVINGS\", amount=goal.target_amount * 0.1, expected_return=0.02, risk_level=\"LOW\", liquidity=\"HIGH\", allocation_percentage=10 ) ], monthly_contribution=(goal.target_amount - goal.current_amount) / 12, expected_timeline=12, risk_assessment=\"MODERATE\", contingency_plans=[ \"Increase contributions if falling behind\", \"Adjust allocation if market conditions change\", \"Extended timeline option available\" ] ) class StrategyOptimizer: \"\"\"Optimizes and adjusts strategies based on performance\"\"\" @staticmethod def optimize_strategy( strategy: Strategy, goal: FinancialGoal, market_conditions: Dict[str, str] ) -\u003e Strategy: messages = [ HumanMessage(content=f\"\"\" Optimize this investment strategy based on current conditions: Current Strategy: {json.dumps(asdict(strategy), indent=2)} Goal Progress: {json.dumps(asdict(goal), indent=2)} Market Conditions: {json.dumps(market_conditions, indent=2)} Please recommend: 1. Allocation adjustments 2. Contribution modifications 3. Risk management updates 4. Timeline revisions Explain the reasoning for each recommendation. \"\"\") ] response = llm.invoke(messages) # Update strategy based on recommendations # (Simplified - would parse LLM response in real implementation) if goal.progress \u003c 50: # If behind schedule strategy.monthly_contribution *= 1.2 # Increase contributions by 20% # Adjust allocations for more aggressive growth for inv in strategy.investments: if inv.type == \"STOCKS\": inv.allocation_percentage += 10 elif inv.type == \"SAVINGS\": inv.allocation_percentage -= 10 return strategy def analyze_goals(state: PlannerState) -\u003e PlannerState: \"\"\" Analyze progress towards financial goals \"\"\" analysis_results = {} for goal_id, goal_data in state[\"financial_goals\"].items(): goal = FinancialGoal(**goal_data) strategy = Strategy(**state[\"strategies\"][goal_id]) if goal_id in state[\"strategies\"] else None if strategy: analyzer = GoalAnalyzer() analysis_results[goal_id] = analyzer.analyze_goal_progress(goal, strategy) state[\"analysis_results\"] = analysis_results state[\"next_action\"] = \"PLAN\" return state def plan_strategies(state: PlannerState) -\u003e PlannerState: \"\"\" Create or update investment strategies \"\"\" planner = StrategyPlanner() optimizer = StrategyOptimizer() for goal_id, goal_data in state[\"financial_goals\"].items(): goal = FinancialGoal(**goal_data) if goal_id not in state[\"strategies\"]: # Create new strategy strategy = planner.create_strategy( goal, state[\"current_portfolio\"], state[\"market_conditions\"] ) state[\"strategies\"][goal_id] = asdict(strategy) elif state[\"analysis_results\"][goal_id][\"requires_strategy_update\"]: # Optimize existing strategy current_strategy = Strategy(**state[\"strategies\"][goal_id]) optimized_strategy = optimizer.optimize_strategy( current_strategy, goal, state[\"market_conditions\"] ) state[\"strategies\"][goal_id] = asdict(optimized_strategy) state[\"next_action\"] = \"END\" return state def router(state: PlannerState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(PlannerState) # Add nodes workflow.add_node(\"analyze\", analyze_goals) workflow.add_node(\"plan\", plan_strategies) # Add edges workflow.add_edge(\"analyze\", router) workflow.add_edge(\"plan\", router) # Set entry point workflow.set_entry_point(\"analyze\") # Create conditional edges workflow.add_conditional_edges( \"analyze\", router, { \"PLAN\": \"plan\", \"END\": END } ) workflow.add_conditional_edges( \"plan\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"financial_goals\": { \"RETIREMENT\": { \"id\": \"RETIREMENT\", \"name\": \"Retirement Fund\", \"target_amount\": 2000000.0, \"current_amount\": 500000.0, \"target_date\": \"2045-01-01\", \"priority\": 1, \"risk_tolerance\": \"MEDIUM\", \"progress\": 25.0 } }, \"current_portfolio\": { \"STOCKS\": 300000.0, \"BONDS\": 150000.0, \"SAVINGS\": 50000.0 }, \"market_conditions\": { \"stocks_outlook\": \"POSITIVE\", \"interest_rates\": \"RISING\", \"economic_indicators\": \"STABLE\", \"market_volatility\": \"MODERATE\" }, \"strategies\": {}, \"analysis_results\": None, \"next_action\": \"ANALYZE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 10. ระบบจดจำบริบท (Contextual Memory) รูปแบบนี้ช่วยให้ระบบสามารถจดจำและใช้ประโยชน์จากข้อมูลในอดีต โดย:\nเก็บข้อมูลการโต้ตอบกับผู้ใช้ วิเคราะห์รูปแบบการใช้งาน ปรับการทำงานให้เหมาะกับแต่ละผู้ใช้ ระบบแชทบอทที่จำความชอบของผู้ใช้และปรับการสนทนาให้เหมาะสมเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Contextual Memory from typing import Dict, List, TypedDict, Optional from datetime import datetime import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from collections import defaultdict import os # Define data structures @dataclass class UserPreference: topic: str sentiment: float # -1 to 1 frequency: int last_discussed: str keywords: List[str] @dataclass class ConversationStyle: formality_level: str # CASUAL, FORMAL, PROFESSIONAL preferred_language: str communication_pace: str # BRIEF, DETAILED interests: List[str] special_notes: List[str] @dataclass class Interaction: timestamp: str user_message: str bot_response: str topics: List[str] sentiment: float user_feedback: Optional[str] class ChatbotState(TypedDict): messages: List[str] current_input: str user_id: str user_preferences: Dict[str, Dict] conversation_style: Optional[Dict] interaction_history: List[Dict] context_analysis: Optional[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.7, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Contextual Chatbot\" } ) class PreferenceAnalyzer: \"\"\"Analyzes and maintains user preferences\"\"\" @staticmethod def update_preferences( current_prefs: Dict[str, UserPreference], interaction: Interaction ) -\u003e Dict[str, UserPreference]: messages = [ HumanMessage(content=f\"\"\" Analyze this interaction and update user preferences: User Message: {interaction.user_message} Bot Response: {interaction.bot_response} Current Topics: {interaction.topics} Current Preferences: {json.dumps({k: asdict(v) for k, v in current_prefs.items()}, indent=2)} Please identify: 1. New topics/interests 2. Sentiment towards topics 3. Key preferences or dislikes 4. Patterns in communication style \"\"\") ] response = llm.invoke(messages) # Update preferences based on analysis updated_prefs = current_prefs.copy() # Add new topics or update existing ones for topic in interaction.topics: if topic not in updated_prefs: updated_prefs[topic] = UserPreference( topic=topic, sentiment=interaction.sentiment, frequency=1, last_discussed=interaction.timestamp, keywords=[] ) else: pref = updated_prefs[topic] pref.frequency += 1 pref.last_discussed = interaction.timestamp pref.sentiment = (pref.sentiment * (pref.frequency - 1) + interaction.sentiment) / pref.frequency return updated_prefs class ConversationAnalyzer: \"\"\"Analyzes conversation patterns and style\"\"\" @staticmethod def analyze_style(interactions: List[Interaction]) -\u003e ConversationStyle: messages = [ HumanMessage(content=f\"\"\" Analyze these interactions to determine conversation style: Recent Interactions: {json.dumps([asdict(i) for i in interactions[-5:]], indent=2)} Please determine: 1. Preferred formality level 2. Communication style (brief/detailed) 3. Key interests and themes 4. Special considerations \"\"\") ] response = llm.invoke(messages) # Create conversation style (simplified - would parse LLM response in real implementation) return ConversationStyle( formality_level=\"CASUAL\" if \"casual\" in response.content.lower() else \"FORMAL\", preferred_language=\"English\", # Would be detected from interactions communication_pace=\"BRIEF\" if \"brief\" in response.content.lower() else \"DETAILED\", interests=[topic for i in interactions[-5:] for topic in i.topics], special_notes=[] ) class ContextManager: \"\"\"Manages contextual memory and retrieval\"\"\" def __init__(self): self.short_term_memory: List[Interaction] = [] self.long_term_memory: Dict[str, List[Interaction]] = defaultdict(list) def add_interaction(self, interaction: Interaction, topics: List[str]): # Add to short-term memory self.short_term_memory.append(interaction) if len(self.short_term_memory) \u003e 10: # Keep last 10 interactions self.short_term_memory.pop(0) # Add to long-term memory by topic for topic in topics: self.long_term_memory[topic].append(interaction) def get_relevant_context(self, current_input: str, user_preferences: Dict[str, UserPreference]) -\u003e List[Interaction]: messages = [ HumanMessage(content=f\"\"\" Find relevant context for this input: Current Input: {current_input} User Preferences: {json.dumps({k: asdict(v) for k, v in user_preferences.items()}, indent=2)} Return relevant topics and importance scores. \"\"\") ] response = llm.invoke(messages) # Get relevant interactions (simplified) relevant = self.short_term_memory[-3:] # Last 3 interactions for topic in user_preferences: if topic.lower() in current_input.lower(): relevant.extend(self.long_term_memory[topic][-2:]) # Last 2 topic-specific interactions return list(set(relevant)) # Remove duplicates class ResponseGenerator: \"\"\"Generates contextually aware responses\"\"\" @staticmethod def generate_response( current_input: str, relevant_context: List[Interaction], conversation_style: ConversationStyle, user_preferences: Dict[str, UserPreference] ) -\u003e str: context_str = \"\\n\".join([ f\"Previous interaction: {i.user_message} -\u003e {i.bot_response}\" for i in relevant_context[-3:] # Last 3 relevant interactions ]) messages = [ HumanMessage(content=f\"\"\" Generate a response considering this context: Current Input: {current_input} Previous Context: {context_str} Conversation Style: {json.dumps(asdict(conversation_style), indent=2)} User Preferences: {json.dumps({k: asdict(v) for k, v in user_preferences.items()}, indent=2)} Generate a response that: 1. Matches the user's preferred style 2. References relevant past interactions 3. Shows awareness of user preferences 4. Maintains conversation continuity \"\"\") ] response = llm.invoke(messages) return response.content def analyze_context(state: ChatbotState) -\u003e ChatbotState: \"\"\" Analyze context and user preferences \"\"\" if state[\"interaction_history\"]: # Convert recent interactions to objects recent_interactions = [ Interaction(**interaction) for interaction in state[\"interaction_history\"][-5:] ] # Analyze conversation style analyzer = ConversationAnalyzer() conversation_style = analyzer.analyze_style(recent_interactions) state[\"conversation_style\"] = asdict(conversation_style) # Get relevant context context_manager = ContextManager() for interaction in state[\"interaction_history\"]: context_manager.add_interaction( Interaction(**interaction), interaction.get(\"topics\", []) ) current_prefs = { k: UserPreference(**v) for k, v in state[\"user_preferences\"].items() } relevant_context = context_manager.get_relevant_context( state[\"current_input\"], current_prefs ) state[\"context_analysis\"] = { \"relevant_interactions\": [asdict(i) for i in relevant_context], \"conversation_style\": asdict(conversation_style) } state[\"next_action\"] = \"RESPOND\" return state def generate_response(state: ChatbotState) -\u003e ChatbotState: \"\"\" Generate contextually aware response \"\"\" # Convert data structures conversation_style = ConversationStyle(**state[\"conversation_style\"]) user_preferences = { k: UserPreference(**v) for k, v in state[\"user_preferences\"].items() } relevant_context = [ Interaction(**i) for i in state[\"context_analysis\"][\"relevant_interactions\"] ] # Generate response generator = ResponseGenerator() response = generator.generate_response( state[\"current_input\"], relevant_context, conversation_style, user_preferences ) # Create new interaction interaction = Interaction( timestamp=datetime.now().isoformat(), user_message=state[\"current_input\"], bot_response=response, topics=[], # Would be extracted from response sentiment=0.0, # Would be analyzed user_feedback=None ) # Update state state[\"messages\"].append(response) state[\"interaction_history\"].append(asdict(interaction)) state[\"next_action\"] = \"END\" return state def router(state: ChatbotState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(ChatbotState) # Add nodes workflow.add_node(\"analyze\", analyze_context) workflow.add_node(\"respond\", generate_response) # Add edges workflow.add_edge(\"analyze\", router) workflow.add_edge(\"respond\", router) # Set entry point workflow.set_entry_point(\"analyze\") # Create conditional edges workflow.add_conditional_edges( \"analyze\", router, { \"RESPOND\": \"respond\", \"END\": END } ) workflow.add_conditional_edges( \"respond\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"current_input\": \"What restaurants do you recommend?\", \"user_id\": \"user123\", \"user_preferences\": { \"cuisine\": { \"topic\": \"cuisine\", \"sentiment\": 0.8, \"frequency\": 5, \"last_discussed\": \"2024-02-05T10:00:00\", \"keywords\": [\"Thai\", \"Italian\", \"vegetarian\"] } }, \"conversation_style\": { \"formality_level\": \"CASUAL\", \"preferred_language\": \"English\", \"communication_pace\": \"DETAILED\", \"interests\": [\"food\", \"travel\"], \"special_notes\": [\"Prefers detailed explanations\"] }, \"interaction_history\": [ { \"timestamp\": \"2024-02-05T09:00:00\", \"user_message\": \"I love Thai food\", \"bot_response\": \"Thai cuisine is amazing! Do you have a favorite dish?\", \"topics\": [\"cuisine\", \"Thai\"], \"sentiment\": 0.9, \"user_feedback\": None } ], \"context_analysis\": None, \"next_action\": \"ANALYZE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 11. ระบบหลายตัวแทนที่ทำงานร่วมกัน (Collaborative Multi-Agent Systems) รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบย่อยหลายๆ ระบบทำงานร่วมกันได้อย่างมีประสิทธิภาพ โดย:\nแบ่งงานตามความเชี่ยวชาญ ประสานงานระหว่างระบบย่อย แก้ไขความขัดแย้งที่อาจเกิดขึ้น โดรนขนส่งที่ทำงานประสานกันเพื่อส่งพัสดุในเมืองเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Collaborative Multi-Agent Systems from typing import Dict, List, TypedDict, Optional, Tuple from datetime import datetime, timedelta import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter import os import random from enum import Enum # Define data structures class DroneStatus(str, Enum): IDLE = \"IDLE\" LOADING = \"LOADING\" DELIVERING = \"DELIVERING\" RETURNING = \"RETURNING\" CHARGING = \"CHARGING\" MAINTENANCE = \"MAINTENANCE\" @dataclass class Location: x: float y: float name: str is_charging_station: bool = False is_depot: bool = False @dataclass class Package: id: str pickup_location: Location delivery_location: Location weight: float priority: int # 1 (highest) to 5 (lowest) deadline: str status: str # PENDING, ASSIGNED, IN_TRANSIT, DELIVERED @dataclass class Drone: id: str current_location: Location status: DroneStatus battery_level: float max_payload: float current_package: Optional[str] assigned_zone: List[float] # [x_min, y_min, x_max, y_max] delivery_history: List[str] @dataclass class DeliveryPlan: drone_id: str package_ids: List[str] route: List[Location] estimated_battery_usage: float estimated_completion_time: str priority_score: float class SystemState(TypedDict): messages: List[str] drones: Dict[str, Dict] packages: Dict[str, Dict] delivery_plans: Dict[str, Dict] conflict_resolutions: List[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Drone Fleet Manager\" } ) class RouteOptimizer: \"\"\"Optimizes delivery routes for each drone\"\"\" @staticmethod def calculate_distance(loc1: Location, loc2: Location) -\u003e float: return ((loc1.x - loc2.x) ** 2 + (loc1.y - loc2.y) ** 2) ** 0.5 @staticmethod def estimate_battery_usage(route: List[Location], package_weight: float) -\u003e float: total_distance = sum( RouteOptimizer.calculate_distance(route[i], route[i+1]) for i in range(len(route)-1) ) # Simple battery usage model: distance + weight factor return total_distance * (1 + package_weight * 0.1) @staticmethod def optimize_route( drone: Drone, packages: List[Package], charging_stations: List[Location] ) -\u003e DeliveryPlan: messages = [ HumanMessage(content=f\"\"\" Optimize delivery route for drone considering: Drone Status: {json.dumps(asdict(drone), indent=2)} Available Packages: {json.dumps([asdict(p) for p in packages], indent=2)} Charging Stations: {json.dumps([asdict(s) for s in charging_stations], indent=2)} Consider: 1. Battery efficiency 2. Package priorities 3. Deadlines 4. Drone zone restrictions 5. Charging station locations Provide: 1. Optimized package sequence 2. Complete route with charging stops 3. Estimated battery usage 4. Expected completion time \"\"\") ] response = llm.invoke(messages) # Create delivery plan (simplified - would parse LLM response in real implementation) route = [drone.current_location] if packages: route.extend([ packages[0].pickup_location, packages[0].delivery_location ]) if drone.battery_level \u003c 0.3: route.append(min( charging_stations, key=lambda s: RouteOptimizer.calculate_distance(route[-1], s) )) return DeliveryPlan( drone_id=drone.id, package_ids=[p.id for p in packages], route=route, estimated_battery_usage=RouteOptimizer.estimate_battery_usage( route, sum(p.weight for p in packages) ), estimated_completion_time=( datetime.now() + timedelta(minutes=len(route)*10) ).isoformat(), priority_score=sum(1/p.priority for p in packages) ) class ConflictResolver: \"\"\"Resolves conflicts between drone delivery plans\"\"\" @staticmethod def detect_conflicts(plans: List[DeliveryPlan]) -\u003e List[Dict]: messages = [ HumanMessage(content=f\"\"\" Analyze these delivery plans for potential conflicts: Delivery Plans: {json.dumps([asdict(p) for p in plans], indent=2)} Check for: 1. Path intersections 2. Resource conflicts (charging stations) 3. Timing conflicts 4. Zone violations Identify specific conflicts and suggest resolutions. \"\"\") ] response = llm.invoke(messages) # Process conflicts (simplified) conflicts = [] for i, plan1 in enumerate(plans): for plan2 in plans[i+1:]: # Check for path intersections for loc1 in plan1.route: for loc2 in plan2.route: if (loc1.x == loc2.x and loc1.y == loc2.y and loc1.is_charging_station): conflicts.append({ \"type\": \"CHARGING_STATION_CONFLICT\", \"drones\": [plan1.drone_id, plan2.drone_id], \"location\": asdict(loc1), \"resolution\": \"RESEQUENCE\" }) return conflicts @staticmethod def resolve_conflicts( conflicts: List[Dict], plans: Dict[str, DeliveryPlan] ) -\u003e Dict[str, DeliveryPlan]: messages = [ HumanMessage(content=f\"\"\" Resolve these delivery plan conflicts: Conflicts: {json.dumps(conflicts, indent=2)} Current Plans: {json.dumps({k: asdict(v) for k, v in plans.items()}, indent=2)} Provide: 1. Modified routes 2. Updated timing 3. Rationale for changes \"\"\") ] response = llm.invoke(messages) # Resolve conflicts (simplified) updated_plans = plans.copy() for conflict in conflicts: if conflict[\"type\"] == \"CHARGING_STATION_CONFLICT\": # Add delay to second drone's plan drone_id = conflict[\"drones\"][1] plan = updated_plans[drone_id] plan.estimated_completion_time = ( datetime.fromisoformat(plan.estimated_completion_time) + timedelta(minutes=15) ).isoformat() return updated_plans class FleetCoordinator: \"\"\"Coordinates overall fleet operations\"\"\" @staticmethod def assign_packages( drones: Dict[str, Drone], packages: List[Package], charging_stations: List[Location] ) -\u003e Dict[str, DeliveryPlan]: messages = [ HumanMessage(content=f\"\"\" Assign packages to drones optimally: Available Drones: {json.dumps({k: asdict(v) for k, v in drones.items()}, indent=2)} Pending Packages: {json.dumps([asdict(p) for p in packages], indent=2)} Consider: 1. Drone locations and zones 2. Package priorities and deadlines 3. Battery levels 4. Load balancing Provide assignment plan with rationale. \"\"\") ] response = llm.invoke(messages) # Create delivery plans (simplified) optimizer = RouteOptimizer() plans = {} for drone in drones.values(): if drone.status in [DroneStatus.IDLE, DroneStatus.RETURNING]: # Find packages in drone's zone zone_packages = [ p for p in packages if (drone.assigned_zone[0] \u003c= p.delivery_location.x \u003c= drone.assigned_zone[2] and drone.assigned_zone[1] \u003c= p.delivery_location.y \u003c= drone.assigned_zone[3]) ] if zone_packages: plans[drone.id] = optimizer.optimize_route( drone, sorted(zone_packages, key=lambda p: p.priority)[:2], charging_stations ) return plans def plan_deliveries(state: SystemState) -\u003e SystemState: \"\"\" Plan and optimize delivery routes \"\"\" # Convert data structures drones = { k: Drone(**d) for k, d in state[\"drones\"].items() } packages = [ Package(**p) for p in state[\"packages\"].values() if p[\"status\"] == \"PENDING\" ] charging_stations = [ Location(0, 0, \"Station 1\", True), Location(10, 10, \"Station 2\", True) ] # Create delivery plans coordinator = FleetCoordinator() plans = coordinator.assign_packages(drones, packages, charging_stations) # Convert to dict format state[\"delivery_plans\"] = { k: asdict(v) for k, v in plans.items() } state[\"next_action\"] = \"RESOLVE_CONFLICTS\" return state def resolve_conflicts(state: SystemState) -\u003e SystemState: \"\"\" Detect and resolve conflicts between delivery plans \"\"\" if not state[\"delivery_plans\"]: state[\"next_action\"] = \"END\" return state # Convert plans to objects plans = { k: DeliveryPlan(**p) for k, p in state[\"delivery_plans\"].items() } # Detect and resolve conflicts resolver = ConflictResolver() conflicts = resolver.detect_conflicts(list(plans.values())) if conflicts: updated_plans = resolver.resolve_conflicts(conflicts, plans) state[\"delivery_plans\"] = { k: asdict(v) for k, v in updated_plans.items() } state[\"conflict_resolutions\"] = conflicts state[\"next_action\"] = \"END\" return state def router(state: SystemState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(SystemState) # Add nodes workflow.add_node(\"plan\", plan_deliveries) workflow.add_node(\"resolve\", resolve_conflicts) # Add edges workflow.add_edge(\"plan\", router) workflow.add_edge(\"resolve\", router) # Set entry point workflow.set_entry_point(\"plan\") # Create conditional edges workflow.add_conditional_edges( \"plan\", router, { \"RESOLVE_CONFLICTS\": \"resolve\", \"END\": END } ) workflow.add_conditional_edges( \"resolve\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"drones\": { \"drone1\": { \"id\": \"drone1\", \"current_location\": asdict(Location(0, 0, \"Depot\", is_depot=True)), \"status\": \"IDLE\", \"battery_level\": 0.9, \"max_payload\": 5.0, \"current_package\": None, \"assigned_zone\": [0, 0, 5, 5], \"delivery_history\": [] }, \"drone2\": { \"id\": \"drone2\", \"current_location\": asdict(Location(5, 5, \"Depot 2\", is_depot=True)), \"status\": \"IDLE\", \"battery_level\": 0.8, \"max_payload\": 5.0, \"current_package\": None, \"assigned_zone\": [5, 5, 10, 10], \"delivery_history\": [] } }, \"packages\": { \"pkg1\": { \"id\": \"pkg1\", \"pickup_location\": asdict(Location(1, 1, \"Warehouse A\")), \"delivery_location\": asdict(Location(4, 4, \"Customer 1\")), \"weight\": 2.0, \"priority\": 1, \"deadline\": (datetime.now() + timedelta(hours=2)).isoformat(), \"status\": \"PENDING\" }, \"pkg2\": { \"id\": \"pkg2\", \"pickup_location\": asdict(Location(6, 6, \"Warehouse B\")), \"delivery_location\": asdict(Location(8, 8, \"Customer 2\")), \"weight\": 3.0, \"priority\": 2, \"deadline\": (datetime.now() + timedelta(hours=3)).isoformat(), \"status\": \"PENDING\" } }, \"delivery_plans\": {}, \"conflict_resolutions\": [], \"next_action\": \"PLAN\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 12. ระบบสำรวจ (Exploratory Agent) รูปแบบนี้เหมาะกับการค้นหาข้อมูลและโอกาสใหม่ๆ โดย:\nสำรวจสภาพแวดล้อมหรือข้อมูลที่ไม่คุ้นเคย วิเคราะห์และจัดเก็บข้อมูลที่พบ ระบุรูปแบบหรือโอกาสที่น่าสนใจ ผู้ช่วยวิจัยที่สแกนวารสารวิชาการเพื่อค้นหาแนวโน้มใหม่ๆ เป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Exploratory Agent from typing import Dict, List, TypedDict, Optional from datetime import datetime import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from collections import defaultdict import os # Define data structures @dataclass class ResearchPaper: title: str authors: List[str] abstract: str keywords: List[str] publication_date: str journal: str citations: int research_areas: List[str] @dataclass class ResearchTrend: topic: str emerging_keywords: List[str] key_papers: List[str] growth_rate: float # Trend growth rate relevance_score: float # 0-1 first_observed: str last_updated: str @dataclass class Insight: trend_id: str description: str supporting_evidence: List[str] potential_impact: str confidence_score: float timestamp: str class ResearchState(TypedDict): messages: List[str] papers: Dict[str, Dict] identified_trends: Dict[str, Dict] insights: List[Dict] research_focus: List[str] analysis_results: Optional[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.3, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Research Assistant\" } ) class TrendAnalyzer: \"\"\"Analyzes research papers to identify trends\"\"\" @staticmethod def identify_trends(papers: List[ResearchPaper]) -\u003e List[ResearchTrend]: # Group papers by research areas area_papers = defaultdict(list) for paper in papers: for area in paper.research_areas: area_papers[area].append(paper) messages = [ HumanMessage(content=f\"\"\" Analyze these research papers and identify emerging trends: Papers by Research Area: {json.dumps({area: [asdict(p) for p in papers] for area, papers in area_papers.items()}, indent=2)} For each trend, identify: 1. Core topic and theme 2. Key emerging keywords 3. Most influential papers 4. Growth trajectory 5. Potential impact Focus on: - Novel research directions - Emerging methodologies - Cross-disciplinary connections - Technology applications \"\"\") ] response = llm.invoke(messages) # Process trends (simplified - would parse LLM response in real implementation) trends = [] for area, area_paper_list in area_papers.items(): if len(area_paper_list) \u003e= 3: # Minimum papers to identify trend recent_papers = sorted( area_paper_list, key=lambda p: p.publication_date, reverse=True )[:3] trend = ResearchTrend( topic=area, emerging_keywords=list(set( kw for p in recent_papers for kw in p.keywords )), key_papers=[p.title for p in recent_papers], growth_rate=0.5, # Would calculate from citation patterns relevance_score=0.8, # Would calculate based on analysis first_observed=min(p.publication_date for p in area_paper_list), last_updated=max(p.publication_date for p in area_paper_list) ) trends.append(trend) return trends class InsightGenerator: \"\"\"Generates insights from identified trends\"\"\" @staticmethod def generate_insights( trends: List[ResearchTrend], papers: Dict[str, ResearchPaper] ) -\u003e List[Insight]: messages = [ HumanMessage(content=f\"\"\" Generate research insights based on these trends: Research Trends: {json.dumps([asdict(t) for t in trends], indent=2)} Supporting Papers: {json.dumps({k: asdict(v) for k, v in papers.items()}, indent=2)} For each insight: 1. Describe the key finding 2. Provide supporting evidence 3. Assess potential impact 4. Estimate confidence level Consider: - Cross-trend patterns - Unexpected connections - Research gaps - Future implications \"\"\") ] response = llm.invoke(messages) # Generate insights (simplified) insights = [] for trend in trends: insight = Insight( trend_id=trend.topic, description=f\"Emerging trend in {trend.topic}\", supporting_evidence=trend.key_papers, potential_impact=\"HIGH\" if trend.growth_rate \u003e 0.7 else \"MEDIUM\", confidence_score=trend.relevance_score, timestamp=datetime.now().isoformat() ) insights.append(insight) return insights class PatternMatcher: \"\"\"Identifies patterns and connections across research areas\"\"\" @staticmethod def find_patterns( trends: List[ResearchTrend], insights: List[Insight] ) -\u003e Dict: messages = [ HumanMessage(content=f\"\"\" Identify patterns and connections across research trends: Trends: {json.dumps([asdict(t) for t in trends], indent=2)} Insights: {json.dumps([asdict(i) for i in insights], indent=2)} Look for: 1. Common themes across areas 2. Complementary research directions 3. Technology convergence 4. Methodology patterns Highlight: - Strong connections - Research opportunities - Potential collaborations \"\"\") ] response = llm.invoke(messages) # Analyze patterns (simplified) patterns = { \"theme_clusters\": defaultdict(list), \"methodology_patterns\": [], \"research_opportunities\": [] } # Group related trends for trend in trends: for keyword in trend.emerging_keywords: patterns[\"theme_clusters\"][keyword].append(trend.topic) return patterns def analyze_trends(state: ResearchState) -\u003e ResearchState: \"\"\" Identify and analyze research trends \"\"\" # Convert papers to objects papers = [ ResearchPaper(**paper_data) for paper_data in state[\"papers\"].values() ] # Identify trends analyzer = TrendAnalyzer() trends = analyzer.identify_trends(papers) # Store trends state[\"identified_trends\"] = { trend.topic: asdict(trend) for trend in trends } state[\"next_action\"] = \"GENERATE_INSIGHTS\" return state def generate_insights(state: ResearchState) -\u003e ResearchState: \"\"\" Generate insights from identified trends \"\"\" # Convert data structures trends = [ ResearchTrend(**trend_data) for trend_data in state[\"identified_trends\"].values() ] papers = { k: ResearchPaper(**v) for k, v in state[\"papers\"].items() } # Generate insights generator = InsightGenerator() insights = generator.generate_insights(trends, papers) # Find patterns matcher = PatternMatcher() patterns = matcher.find_patterns(trends, insights) # Update state state[\"insights\"] = [asdict(insight) for insight in insights] state[\"analysis_results\"] = patterns state[\"next_action\"] = \"END\" return state def router(state: ResearchState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(ResearchState) # Add nodes workflow.add_node(\"analyze\", analyze_trends) workflow.add_node(\"insights\", generate_insights) # Add edges workflow.add_edge(\"analyze\", router) workflow.add_edge(\"insights\", router) # Set entry point workflow.set_entry_point(\"analyze\") # Create conditional edges workflow.add_conditional_edges( \"analyze\", router, { \"GENERATE_INSIGHTS\": \"insights\", \"END\": END } ) workflow.add_conditional_edges( \"insights\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state with example papers initial_state = { \"messages\": [], \"papers\": { \"paper1\": { \"title\": \"Deep Learning in Medical Imaging\", \"authors\": [\"Smith, J.\", \"Jones, K.\"], \"abstract\": \"This paper explores applications of deep learning...\", \"keywords\": [\"deep learning\", \"medical imaging\", \"AI\"], \"publication_date\": \"2024-01-15\", \"journal\": \"AI in Medicine\", \"citations\": 10, \"research_areas\": [\"AI\", \"Healthcare\"] }, \"paper2\": { \"title\": \"Advances in Quantum Computing\", \"authors\": [\"Brown, R.\", \"Lee, M.\"], \"abstract\": \"Recent developments in quantum computing...\", \"keywords\": [\"quantum computing\", \"qubits\", \"algorithms\"], \"publication_date\": \"2024-01-20\", \"journal\": \"Quantum Computing Review\", \"citations\": 15, \"research_areas\": [\"Quantum Computing\", \"Computer Science\"] } }, \"identified_trends\": {}, \"insights\": [], \"research_focus\": [\"AI\", \"Quantum Computing\", \"Healthcare\"], \"analysis_results\": None, \"next_action\": \"ANALYZE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 13. ระบบจัดการขั้นตอนการทำงานแบบปรับตัวได้ (Adaptive Workflow Orchestration) รูปแบบนี้ช่วยให้ระบบปรับเปลี่ยนการทำงานตามสถานการณ์ได้อย่างยืดหยุ่น โดย:\nติดตามการเปลี่ยนแปลงของสภาพแวดล้อม ปรับลำดับความสำคัญของงาน จัดสรรทรัพยากรใหม่ตามความจำเป็น ระบบบริหารจัดการโรงพยาบาลที่ปรับการจัดสรรทรัพยากรตามจำนวนผู้ป่วยที่เข้ามาเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Adaptive Workflow Orchestration from typing import Dict, List, TypedDict, Optional from datetime import datetime, timedelta import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from enum import Enum import os # Define data structures class ResourceType(str, Enum): DOCTOR = \"DOCTOR\" NURSE = \"NURSE\" BED = \"BED\" EQUIPMENT = \"EQUIPMENT\" ICU = \"ICU\" EMERGENCY = \"EMERGENCY\" class PatientPriority(str, Enum): CRITICAL = \"CRITICAL\" HIGH = \"HIGH\" MEDIUM = \"MEDIUM\" LOW = \"LOW\" @dataclass class Resource: id: str type: ResourceType department: str status: str # AVAILABLE, BUSY, MAINTENANCE current_assignment: Optional[str] capacity: float # 0-1 for utilization skills: List[str] @dataclass class Department: name: str current_load: float # 0-1 for utilization patient_count: int resources: Dict[ResourceType, List[str]] wait_time: int # minutes status: str # NORMAL, HIGH_LOAD, CRITICAL @dataclass class Patient: id: str priority: PatientPriority department: str required_resources: List[ResourceType] arrival_time: str status: str # WAITING, IN_TREATMENT, DISCHARGED estimated_duration: int # minutes @dataclass class ResourceAllocation: patient_id: str resource_ids: List[str] department: str start_time: str duration: int priority: PatientPriority class HospitalState(TypedDict): messages: List[str] departments: Dict[str, Dict] resources: Dict[str, Dict] patients: Dict[str, Dict] allocations: Dict[str, Dict] metrics: Dict[str, float] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Hospital Resource Manager\" } ) class LoadAnalyzer: \"\"\"Analyzes department loads and resource utilization\"\"\" @staticmethod def analyze_department_loads( departments: Dict[str, Department], patients: Dict[str, Patient] ) -\u003e Dict[str, float]: messages = [ HumanMessage(content=f\"\"\" Analyze hospital department loads: Departments: {json.dumps({k: asdict(v) for k, v in departments.items()}, indent=2)} Current Patients: {json.dumps({k: asdict(v) for k, v in patients.items()}, indent=2)} Consider: 1. Current patient count vs capacity 2. Patient priorities and types 3. Wait times 4. Resource utilization Provide load analysis and recommendations. \"\"\") ] response = llm.invoke(messages) # Calculate loads (simplified) loads = {} for dept_name, dept in departments.items(): dept_patients = sum(1 for p in patients.values() if p.department == dept_name) critical_patients = sum( 1 for p in patients.values() if p.department == dept_name and p.priority == PatientPriority.CRITICAL ) # Calculate load score (0-1) base_load = dept_patients / 20 # Assuming 20 patients is max capacity critical_factor = critical_patients * 0.1 # Extra 10% load per critical patient wait_time_factor = min(dept.wait_time / 120, 0.5) # Max 50% impact from wait time loads[dept_name] = min(base_load + critical_factor + wait_time_factor, 1.0) return loads class ResourceOptimizer: \"\"\"Optimizes resource allocation based on loads and priorities\"\"\" @staticmethod def optimize_resources( departments: Dict[str, Department], resources: Dict[str, Resource], patients: Dict[str, Patient], current_loads: Dict[str, float] ) -\u003e List[ResourceAllocation]: messages = [ HumanMessage(content=f\"\"\" Optimize resource allocation based on current situation: Department Loads: {json.dumps(current_loads, indent=2)} Available Resources: {json.dumps({k: asdict(v) for k, v in resources.items()}, indent=2)} Waiting Patients: {json.dumps({k: asdict(v) for k, v in patients.items() if v.status == \"WAITING\"}, indent=2)} Consider: 1. Patient priorities 2. Department loads 3. Resource capabilities 4. Wait times 5. Resource utilization balance Provide optimal resource allocation plan. \"\"\") ] response = llm.invoke(messages) # Create allocations (simplified) allocations = [] waiting_patients = {k: p for k, p in patients.items() if p.status == \"WAITING\"} available_resources = {k: r for k, r in resources.items() if r.status == \"AVAILABLE\"} # Prioritize patients by severity and wait time sorted_patients = sorted( waiting_patients.values(), key=lambda p: ( PatientPriority[p.priority].value, datetime.fromisoformat(p.arrival_time) ) ) for patient in sorted_patients: # Find available required resources needed_resources = [] for resource_type in patient.required_resources: matching_resources = [ r for r in available_resources.values() if r.type == resource_type and r.department == patient.department ] if matching_resources: needed_resources.append(matching_resources[0].id) del available_resources[matching_resources[0].id] if len(needed_resources) == len(patient.required_resources): allocation = ResourceAllocation( patient_id=patient.id, resource_ids=needed_resources, department=patient.department, start_time=datetime.now().isoformat(), duration=patient.estimated_duration, priority=patient.priority ) allocations.append(allocation) return allocations class WorkflowAdjuster: \"\"\"Adjusts workflows based on current situation\"\"\" @staticmethod def adjust_workflows( departments: Dict[str, Department], loads: Dict[str, float], resources: Dict[str, Resource] ) -\u003e Dict[str, List[str]]: messages = [ HumanMessage(content=f\"\"\" Recommend workflow adjustments based on current situation: Department Status: {json.dumps({k: asdict(v) for k, v in departments.items()}, indent=2)} Department Loads: {json.dumps(loads, indent=2)} Available Resources: {json.dumps({k: asdict(v) for k, v in resources.items()}, indent=2)} Consider: 1. Load balancing opportunities 2. Resource reallocation needs 3. Process optimization 4. Emergency protocols Provide specific workflow adjustment recommendations. \"\"\") ] response = llm.invoke(messages) # Generate adjustments (simplified) adjustments = defaultdict(list) for dept_name, load in loads.items(): if load \u003e 0.8: # High load adjustments[dept_name].extend([ \"ACTIVATE_EMERGENCY_PROTOCOL\", \"REQUEST_ADDITIONAL_STAFF\", \"EXPEDITE_DISCHARGES\" ]) elif load \u003e 0.6: # Moderate load adjustments[dept_name].extend([ \"OPTIMIZE_RESOURCE_ALLOCATION\", \"REVIEW_WAIT_TIMES\" ]) return adjustments def analyze_situation(state: HospitalState) -\u003e HospitalState: \"\"\" Analyze current hospital situation \"\"\" # Convert data structures departments = { k: Department(**d) for k, d in state[\"departments\"].items() } patients = { k: Patient(**p) for k, p in state[\"patients\"].items() } # Analyze loads analyzer = LoadAnalyzer() loads = analyzer.analyze_department_loads(departments, patients) # Store analysis results state[\"metrics\"][\"department_loads\"] = loads state[\"next_action\"] = \"OPTIMIZE\" return state def optimize_resources(state: HospitalState) -\u003e HospitalState: \"\"\" Optimize resource allocation \"\"\" # Convert data structures departments = { k: Department(**d) for k, d in state[\"departments\"].items() } resources = { k: Resource(**r) for k, r in state[\"resources\"].items() } patients = { k: Patient(**p) for k, p in state[\"patients\"].items() } # Optimize resources optimizer = ResourceOptimizer() allocations = optimizer.optimize_resources( departments, resources, patients, state[\"metrics\"][\"department_loads\"] ) # Update allocations state[\"allocations\"] = { f\"alloc_{i}\": asdict(alloc) for i, alloc in enumerate(allocations) } state[\"next_action\"] = \"ADJUST\" return state def adjust_workflows(state: HospitalState) -\u003e HospitalState: \"\"\" Adjust workflows based on current situation \"\"\" # Convert data structures departments = { k: Department(**d) for k, d in state[\"departments\"].items() } resources = { k: Resource(**r) for k, r in state[\"resources\"].items() } # Adjust workflows adjuster = WorkflowAdjuster() adjustments = adjuster.adjust_workflows( departments, state[\"metrics\"][\"department_loads\"], resources ) # Store adjustments state[\"metrics\"][\"workflow_adjustments\"] = adjustments state[\"next_action\"] = \"END\" return state def router(state: HospitalState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(HospitalState) # Add nodes workflow.add_node(\"analyze\", analyze_situation) workflow.add_node(\"optimize\", optimize_resources) workflow.add_node(\"adjust\", adjust_workflows) # Add edges workflow.add_edge(\"analyze\", router) workflow.add_edge(\"optimize\", router) workflow.add_edge(\"adjust\", router) # Set entry point workflow.set_entry_point(\"analyze\") # Create conditional edges workflow.add_conditional_edges( \"analyze\", router, { \"OPTIMIZE\": \"optimize\", \"END\": END } ) workflow.add_conditional_edges( \"optimize\", router, { \"ADJUST\": \"adjust\", \"END\": END } ) workflow.add_conditional_edges( \"adjust\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"departments\": { \"emergency\": { \"name\": \"Emergency\", \"current_load\": 0.7, \"patient_count\": 15, \"resources\": { \"DOCTOR\": [\"doc1\", \"doc2\"], \"NURSE\": [\"nurse1\", \"nurse2\"], \"BED\": [\"bed1\", \"bed2\"] }, \"wait_time\": 45, \"status\": \"HIGH_LOAD\" } }, \"resources\": { \"doc1\": { \"id\": \"doc1\", \"type\": \"DOCTOR\", \"department\": \"emergency\", \"status\": \"BUSY\", \"current_assignment\": \"patient1\", \"capacity\": 0.8, \"skills\": [\"emergency\", \"general\"] } }, \"patients\": { \"patient1\": { \"id\": \"patient1\", \"priority\": \"HIGH\", \"department\": \"emergency\", \"required_resources\": [\"DOCTOR\", \"BED\"], \"arrival_time\": \"2024-02-06T10:00:00\", \"status\": \"IN_TREATMENT\", \"estimated_duration\": 60 } }, \"allocations\": {}, \"metrics\": {}, \"next_action\": \"ANALYZE\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 14. ระบบซ่อมแซมตัวเอง (Self-Healing Systems) รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบสามารถรักษาเสถียรภาพการทำงานได้ด้วยตัวเอง โดย:\nตรวจจับปัญหาหรือข้อผิดพลาด วิเคราะห์สาเหตุของปัญหา ดำเนินการแก้ไขโดยอัตโนมัติ ระบบจัดการคลาวด์ที่สามารถตรวจจับและแก้ไขปัญหาเซิร์ฟเวอร์ที่ทำงานผิดปกติเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Self-Healing Systems from typing import Dict, List, TypedDict, Optional from datetime import datetime, timedelta import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from enum import Enum import os # Define data structures class ServerStatus(str, Enum): HEALTHY = \"HEALTHY\" WARNING = \"WARNING\" CRITICAL = \"CRITICAL\" MAINTENANCE = \"MAINTENANCE\" OFFLINE = \"OFFLINE\" class IssueType(str, Enum): CPU_OVERLOAD = \"CPU_OVERLOAD\" MEMORY_LEAK = \"MEMORY_LEAK\" DISK_FULL = \"DISK_FULL\" NETWORK_LATENCY = \"NETWORK_LATENCY\" SERVICE_DOWN = \"SERVICE_DOWN\" DATABASE_SLOW = \"DATABASE_SLOW\" @dataclass class ServerMetrics: cpu_usage: float memory_usage: float disk_usage: float network_latency: float response_time: float error_rate: float uptime: float timestamp: str @dataclass class Server: id: str name: str status: ServerStatus role: str # web, database, cache, etc. current_metrics: ServerMetrics historical_metrics: List[ServerMetrics] active_issues: List[str] maintenance_history: List[Dict] @dataclass class Issue: id: str server_id: str type: IssueType severity: float # 0-1 detected_time: str description: str root_cause: Optional[str] resolution_steps: List[str] status: str # DETECTED, ANALYZING, RESOLVING, RESOLVED @dataclass class Resolution: issue_id: str server_id: str actions: List[str] expected_impact: Dict[str, float] success_criteria: Dict[str, float] rollback_plan: List[str] class CloudState(TypedDict): messages: List[str] servers: Dict[str, Dict] issues: Dict[str, Dict] resolutions: Dict[str, Dict] system_health: Dict[str, float] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Cloud Health Monitor\" } ) class HealthMonitor: \"\"\"Monitors server health and detects issues\"\"\" @staticmethod def analyze_metrics(server: Server) -\u003e List[Issue]: messages = [ HumanMessage(content=f\"\"\" Analyze these server metrics for potential issues: Server Info: {json.dumps(asdict(server), indent=2)} Key Metrics: - CPU Usage: {server.current_metrics.cpu_usage}% - Memory Usage: {server.current_metrics.memory_usage}% - Disk Usage: {server.current_metrics.disk_usage}% - Network Latency: {server.current_metrics.network_latency}ms - Error Rate: {server.current_metrics.error_rate}% Historical Metrics: {json.dumps([asdict(m) for m in server.historical_metrics[-5:]], indent=2)} Identify: 1. Performance issues 2. Resource constraints 3. Service degradation 4. Anomalous behavior For each issue provide: 1. Issue type 2. Severity 3. Potential root causes 4. Initial resolution steps \"\"\") ] response = llm.invoke(messages) # Detect issues (simplified) issues = [] metrics = server.current_metrics # Check CPU if metrics.cpu_usage \u003e 90: issues.append(Issue( id=f\"issue_{len(issues)}\", server_id=server.id, type=IssueType.CPU_OVERLOAD, severity=min((metrics.cpu_usage - 90) / 10, 1.0), detected_time=datetime.now().isoformat(), description=\"CPU usage critically high\", root_cause=None, resolution_steps=[\"Scale up CPU\", \"Check runaway processes\"], status=\"DETECTED\" )) # Check Memory if metrics.memory_usage \u003e 85: issues.append(Issue( id=f\"issue_{len(issues)}\", server_id=server.id, type=IssueType.MEMORY_LEAK, severity=min((metrics.memory_usage - 85) / 15, 1.0), detected_time=datetime.now().isoformat(), description=\"Memory usage abnormally high\", root_cause=None, resolution_steps=[\"Analyze memory dumps\", \"Check memory leaks\"], status=\"DETECTED\" )) return issues class DiagnosticEngine: \"\"\"Analyzes issues and determines root causes\"\"\" @staticmethod def analyze_issue( issue: Issue, server: Server, system_health: Dict[str, float] ) -\u003e Issue: messages = [ HumanMessage(content=f\"\"\" Analyze this server issue and determine root cause: Issue Details: {json.dumps(asdict(issue), indent=2)} Server Information: {json.dumps(asdict(server), indent=2)} System Health Context: {json.dumps(system_health, indent=2)} Provide: 1. Detailed root cause analysis 2. Impact assessment 3. Recommended resolution steps 4. Risk evaluation \"\"\") ] response = llm.invoke(messages) # Update issue with analysis (simplified) if issue.type == IssueType.CPU_OVERLOAD: issue.root_cause = \"High application load causing CPU spikes\" issue.resolution_steps.extend([ \"Enable auto-scaling\", \"Optimize application code\", \"Add load balancing\" ]) elif issue.type == IssueType.MEMORY_LEAK: issue.root_cause = \"Application memory leak detected\" issue.resolution_steps.extend([ \"Restart problematic services\", \"Apply memory leak patches\", \"Monitor memory patterns\" ]) issue.status = \"ANALYZING\" return issue class RepairExecutor: \"\"\"Executes repair actions and monitors results\"\"\" @staticmethod def create_resolution_plan( issue: Issue, server: Server ) -\u003e Resolution: messages = [ HumanMessage(content=f\"\"\" Create a resolution plan for this issue: Issue: {json.dumps(asdict(issue), indent=2)} Server: {json.dumps(asdict(server), indent=2)} Provide: 1. Detailed action steps 2. Success criteria 3. Expected impacts 4. Rollback procedures 5. Risk mitigation strategies \"\"\") ] response = llm.invoke(messages) # Create resolution plan (simplified) return Resolution( issue_id=issue.id, server_id=server.id, actions=issue.resolution_steps, expected_impact={ \"cpu_usage\": -20 if issue.type == IssueType.CPU_OVERLOAD else 0, \"memory_usage\": -30 if issue.type == IssueType.MEMORY_LEAK else 0, \"response_time\": -50 }, success_criteria={ \"cpu_usage\": 70, \"memory_usage\": 70, \"error_rate\": 1 }, rollback_plan=[ \"Stop new resolution actions\", \"Restore from last known good configuration\", \"Reset affected services\" ] ) def monitor_health(state: CloudState) -\u003e CloudState: \"\"\" Monitor server health and detect issues \"\"\" # Convert data structures servers = { k: Server(**s) for k, s in state[\"servers\"].items() } # Check each server monitor = HealthMonitor() new_issues = [] for server in servers.values(): server_issues = monitor.analyze_metrics(server) new_issues.extend(server_issues) # Update state for issue in new_issues: state[\"issues\"][issue.id] = asdict(issue) # Calculate system health total_servers = len(servers) healthy_servers = sum(1 for s in servers.values() if s.status == ServerStatus.HEALTHY) state[\"system_health\"] = { \"overall_health\": healthy_servers / total_servers, \"total_issues\": len(state[\"issues\"]), \"critical_issues\": sum(1 for i in state[\"issues\"].values() if float(i[\"severity\"]) \u003e 0.7) } state[\"next_action\"] = \"DIAGNOSE\" if new_issues else \"END\" return state def diagnose_issues(state: CloudState) -\u003e CloudState: \"\"\" Analyze issues and determine root causes \"\"\" # Convert data structures issues = { k: Issue(**i) for k, i in state[\"issues\"].items() if i[\"status\"] == \"DETECTED\" } servers = { k: Server(**s) for k, s in state[\"servers\"].items() } # Analyze each issue engine = DiagnosticEngine() for issue_id, issue in issues.items(): server = servers[issue.server_id] updated_issue = engine.analyze_issue( issue, server, state[\"system_health\"] ) state[\"issues\"][issue_id] = asdict(updated_issue) state[\"next_action\"] = \"REPAIR\" if issues else \"END\" return state def execute_repairs(state: CloudState) -\u003e CloudState: \"\"\" Execute repair actions for analyzed issues \"\"\" # Convert data structures issues = { k: Issue(**i) for k, i in state[\"issues\"].items() if i[\"status\"] == \"ANALYZING\" } servers = { k: Server(**s) for k, s in state[\"servers\"].items() } # Create and execute repair plans executor = RepairExecutor() for issue_id, issue in issues.items(): server = servers[issue.server_id] resolution = executor.create_resolution_plan(issue, server) state[\"resolutions\"][issue_id] = asdict(resolution) # Update issue status issue.status = \"RESOLVING\" state[\"issues\"][issue_id] = asdict(issue) state[\"next_action\"] = \"END\" return state def router(state: CloudState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(CloudState) # Add nodes workflow.add_node(\"monitor\", monitor_health) workflow.add_node(\"diagnose\", diagnose_issues) workflow.add_node(\"repair\", execute_repairs) # Add edges workflow.add_edge(\"monitor\", router) workflow.add_edge(\"diagnose\", router) workflow.add_edge(\"repair\", router) # Set entry point workflow.set_entry_point(\"monitor\") # Create conditional edges workflow.add_conditional_edges( \"monitor\", router, { \"DIAGNOSE\": \"diagnose\", \"END\": END } ) workflow.add_conditional_edges( \"diagnose\", router, { \"REPAIR\": \"repair\", \"END\": END } ) workflow.add_conditional_edges( \"repair\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state initial_state = { \"messages\": [], \"servers\": { \"web1\": { \"id\": \"web1\", \"name\": \"Web Server 1\", \"status\": \"WARNING\", \"role\": \"web\", \"current_metrics\": { \"cpu_usage\": 95.0, \"memory_usage\": 87.0, \"disk_usage\": 75.0, \"network_latency\": 150.0, \"response_time\": 2.5, \"error_rate\": 2.0, \"uptime\": 15.5, \"timestamp\": datetime.now().isoformat() }, \"historical_metrics\": [], \"active_issues\": [], \"maintenance_history\": [] } }, \"issues\": {}, \"resolutions\": {}, \"system_health\": {}, \"next_action\": \"MONITOR\" } # Run the workflow app = workflow.compile() for output in app.stream(initial_state): print(\"\\nStep Output:\") print(json.dumps(output, indent=2)) 15. ระบบตัดสินใจตามหลักจริยธรรม (Ethical Decision-Making) รูปแบบนี้มีความสำคัญมากในยุคที่ AI มีบทบาทในการตัดสินใจที่ส่งผลกระทบต่อชีวิตมนุษย์ โดย:\nพิจารณาผลกระทบทางจริยธรรม ชั่งน้ำหนักระหว่างประโยชน์และความเสี่ยง ตัดสินใจบนพื้นฐานของค่านิยมและบรรทัดฐานของสังคม รถยนต์ไร้คนขับที่ต้องตัดสินใจในสถานการณ์ฉุกเฉินโดยคำนึงถึงความปลอดภัยของทุกฝ่ายเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้\nตัวอย่าง Ethical Decision-Making from typing import Dict, List, TypedDict, Optional, Tuple from datetime import datetime import json from dataclasses import dataclass, asdict from langgraph.graph import StateGraph, END from langchain_core.messages import HumanMessage, AIMessage from langchain.chat_models import ChatOpenRouter from enum import Enum import os # Define data structures class EntityType(str, Enum): VEHICLE = \"VEHICLE\" PEDESTRIAN = \"PEDESTRIAN\" CYCLIST = \"CYCLIST\" OBSTACLE = \"OBSTACLE\" TRAFFIC_LIGHT = \"TRAFFIC_LIGHT\" class RiskLevel(str, Enum): LOW = \"LOW\" MEDIUM = \"MEDIUM\" HIGH = \"HIGH\" CRITICAL = \"CRITICAL\" @dataclass class Position: x: float y: float speed: float direction: float @dataclass class Entity: id: str type: EntityType position: Position size: Tuple[float, float] # width, height velocity: Tuple[float, float] # vx, vy priority: int # 1 (highest) to 5 (lowest) vulnerability: float # 0-1 protected_status: bool # True for children, elderly, etc. @dataclass class Scenario: timestamp: str vehicle_state: Entity entities: List[Entity] road_conditions: Dict[str, float] # friction, visibility, etc. weather_conditions: Dict[str, str] time_to_impact: float possible_actions: List[str] @dataclass class EthicalPrinciple: id: str name: str description: str weight: float conditions: List[str] priority: int @dataclass class Decision: action: str reasoning: List[str] ethical_scores: Dict[str, float] risk_assessment: Dict[str, float] consequences: List[Dict] confidence: float class VehicleState(TypedDict): messages: List[str] current_scenario: Dict ethical_principles: Dict[str, Dict] available_actions: List[str] risk_assessments: Dict[str, Dict] decision: Optional[Dict] next_action: str # Initialize OpenRouter LLM llm = ChatOpenRouter( api_key=os.environ[\"OPENROUTER_API_KEY\"], model=\"openai/gpt-4-turbo\", temperature=0.2, headers={ \"HTTP-Referer\": \"http://localhost:8000\", \"X-Title\": \"Ethical Vehicle AI\" } ) # Define ethical principles ETHICAL_PRINCIPLES = { \"minimize_harm\": EthicalPrinciple( id=\"minimize_harm\", name=\"Minimize Harm\", description=\"Minimize overall harm to all entities involved\", weight=1.0, conditions=[\"Consider vulnerability\", \"Protect human life\"], priority=1 ), \"protect_vulnerable\": EthicalPrinciple( id=\"protect_vulnerable\", name=\"Protect Vulnerable\", description=\"Prioritize protection of vulnerable individuals\", weight=0.9, conditions=[\"Children\", \"Elderly\", \"Disabled\"], priority=2 ), \"fairness\": EthicalPrinciple( id=\"fairness\", name=\"Fairness\", description=\"Ensure fair treatment regardless of characteristics\", weight=0.8, conditions=[\"No discrimination\", \"Equal consideration\"], priority=3 ) } class RiskAnalyzer: \"\"\"Analyzes risks for different actions\"\"\" @staticmethod def calculate_collision_risk( vehicle: Entity, entity: Entity, time_to_impact: float ) -\u003e float: # Simple risk calculation based on time to impact and relative velocity relative_velocity = ( (vehicle.velocity[0] - entity.velocity[0])**2 + (vehicle.velocity[1] - entity.velocity[1])**2 )**0.5 distance = ( (vehicle.position.x - entity.position.x)**2 + (vehicle.position.y - entity.position.y)**2 )**0.5 # Higher risk for closer entities and higher relative velocities risk = (relative_velocity * entity.vulnerability) / (distance + 1) return min(risk, 1.0) @staticmethod def analyze_action_risks( scenario: Scenario, action: str ) -\u003e Dict[str, float]: messages = [ HumanMessage(content=f\"\"\" Analyze risks for this action in the current scenario: Scenario: {json.dumps(asdict(scenario), indent=2)} Proposed Action: {action} Consider: 1. Collision risks 2. Entity vulnerabilities 3. Environmental factors 4. Time constraints Provide risk assessment for: 1. Immediate safety 2. Secondary effects 3. Long-term consequences \"\"\") ] response = llm.invoke(messages) # Calculate risks (simplified) risks = { \"collision\": sum( RiskAnalyzer.calculate_collision_risk( scenario.vehicle_state, entity, scenario.time_to_impact ) for entity in scenario.entities ) / len(scenario.entities), \"environmental\": sum( v for v in scenario.road_conditions.values() ) / len(scenario.road_conditions), \"time_pressure\": 1.0 / (scenario.time_to_impact + 1) } return risks class EthicalEvaluator: \"\"\"Evaluates ethical implications of actions\"\"\" @staticmethod def evaluate_action( action: str, scenario: Scenario, principles: Dict[str, EthicalPrinciple], risks: Dict[str, float] ) -\u003e Dict[str, float]: messages = [ HumanMessage(content=f\"\"\" Evaluate ethical implications of this action: Action: {action} Scenario: {json.dumps(asdict(scenario), indent=2)} Ethical Principles: {json.dumps({k: asdict(v) for k, v in principles.items()}, indent=2)} Risk Assessment: {json.dumps(risks, indent=2)} Consider: 1. Impact on all entities 2. Adherence to ethical principles 3. Risk-benefit balance 4. Social values and norms Provide scores and explanations for each principle. \"\"\") ] response = llm.invoke(messages) # Calculate ethical scores (simplified) scores = {} for principle in principles.values(): if principle.id == \"minimize_harm\": scores[principle.id] = 1.0 - max(risks.values()) elif principle.id == \"protect_vulnerable\": vulnerable_entities = [ e for e in scenario.entities if e.protected_status ] if vulnerable_entities: avg_risk = sum( RiskAnalyzer.calculate_collision_risk( scenario.vehicle_state, entity, scenario.time_to_impact ) for entity in vulnerable_entities ) / len(vulnerable_entities) scores[principle.id] = 1.0 - avg_risk else: scores[principle.id] = 1.0 elif principle.id == \"fairness\": # Check if risks are evenly distributed risk_variance = max(risks.values()) - min(risks.values()) scores[principle.id] = 1.0 - risk_variance return scores class DecisionMaker: \"\"\"Makes final decisions based on ethical evaluation and risks\"\"\" @staticmethod def make_decision( scenario: Scenario, ethical_scores: Dict[str, Dict[str, float]], risk_assessments: Dict[str, Dict[str, float]] ) -\u003e Decision: messages = [ HumanMessage(content=f\"\"\" Make a decision based on ethical evaluation and risks: Scenario: {json.dumps(asdict(scenario), indent=2)} Ethical Scores: {json.dumps(ethical_scores, indent=2)} Risk Assessments: {json.dumps(risk_assessments, indent=2)} Consider: 1. Overall ethical alignment 2. Risk minimization 3. Time constraints 4. Practical feasibility Provide: 1. Chosen action 2. Detailed reasoning 3. Expected consequences 4. Confidence level \"\"\") ] response = llm.invoke(messages) # Select best action (simplified) action_scores = {} for action in scenario.possible_actions: # Combine ethical scores and risk assessments ethical_score = sum( score * ETHICAL_PRINCIPLES[principle].weight for principle, score in ethical_scores[action].items() ) risk_score = 1.0 - sum(risk_assessments[action].values()) / len(risk_assessments[action]) # Weight ethical considerations more heavily action_scores[action] = (ethical_score * 0.7) + (risk_score * 0.3) best_action = max(action_scores.items(), key=lambda x: x[1])[0] return Decision( action=best_action, reasoning=[ \"Highest combined ethical and safety score\", f\"Ethical score: {ethical_scores[best_action]}\", f\"Risk assessment: {risk_assessments[best_action]}\" ], ethical_scores=ethical_scores[best_action], risk_assessment=risk_assessments[best_action], consequences=[ {\"type\": \"immediate\", \"description\": \"Avoid collision\"}, {\"type\": \"secondary\", \"description\": \"Minimal disruption\"} ], confidence=action_scores[best_action] ) def analyze_risks(state: VehicleState) -\u003e VehicleState: \"\"\" Analyze risks for each possible action \"\"\" # Convert data structures scenario = Scenario(**state[\"current_scenario\"]) # Analyze risks for each action analyzer = RiskAnalyzer() risk_assessments = {} for action in state[\"available_actions\"]: risks = analyzer.analyze_action_risks(scenario, action) risk_assessments[action] = risks state[\"risk_assessments\"] = risk_assessments state[\"next_action\"] = \"EVALUATE\" return state def evaluate_ethics(state: VehicleState) -\u003e VehicleState: \"\"\" Evaluate ethical implications of each action \"\"\" # Convert data structures scenario = Scenario(**state[\"current_scenario\"]) principles = { k: EthicalPrinciple(**p) for k, p in state[\"ethical_principles\"].items() } # Evaluate each action evaluator = EthicalEvaluator() ethical_scores = {} for action in state[\"available_actions\"]: scores = evaluator.evaluate_action( action, scenario, principles, state[\"risk_assessments\"][action] ) ethical_scores[action] = scores state[\"ethical_scores\"] = ethical_scores state[\"next_action\"] = \"DECIDE\" return state def make_decision(state: VehicleState) -\u003e VehicleState: \"\"\" Make final decision based on ethical evaluation and risks \"\"\" # Convert data structures scenario = Scenario(**state[\"current_scenario\"]) # Make decision decision_maker = DecisionMaker() decision = decision_maker.make_decision( scenario, state[\"ethical_scores\"], state[\"risk_assessments\"] ) state[\"decision\"] = asdict(decision) state[\"next_action\"] = \"END\" return state def router(state: VehicleState) -\u003e str: \"\"\"Route to the next step based on the current state\"\"\" return state[\"next_action\"] # Create the graph workflow = StateGraph(VehicleState) # Add nodes workflow.add_node(\"analyze\", analyze_risks) workflow.add_node(\"evaluate\", evaluate_ethics) workflow.add_node(\"decide\", make_decision) # Add edges workflow.add_edge(\"analyze\", router) workflow.add_edge(\"evaluate\", router) workflow.add_edge(\"decide\", router) # Set entry point workflow.set_entry_point(\"analyze\") # Create conditional edges workflow.add_conditional_edges( \"analyze\", router, { \"EVALUATE\": \"evaluate\", \"END\": END } ) workflow.add_conditional_edges( \"evaluate\", router, { \"DECIDE\": \"decide\", \"END\": END } ) workflow.add_conditional_edges( \"decide\", router, { \"END\": END } ) # Example usage if __name__ == \"__main__\": # Initialize state with example emergency scenario initial_state = { \"messages\": [], \"current_scenario\": { \"timestamp\": datetime.now().isoformat(), \"vehicle_state\": { \"id\": \"ego_vehicle\", \"type\": \"VEHICLE\", \"position\": { \"x\": 0.0, \"y\": 0.0, \"speed\": 50.0, \"direction\": 0.0 }, \"size\": (2.0, 4.5), \"velocity\": (14.0, 0.0), \"priority\": 3, \"vulnerability\": 0.5, \"protected_status\": False }, \"entities\": [ { \"id\": \"pedestrian1\", \"type\": \"PEDESTRIAN\", \"position\": { \"x\": 10.0, \"y\": 0.0, \"speed\": 1.0, \"direction\": 90.0 }, \"size\": (0.5, 0.5), \"velocity\": (0.0, 1.0), \"priority\": 1, \"vulnerability\": 0.9, \"protected_status\": True } ], \"road_conditions\": { \"friction\": 0.8, \"visibility\": 0.9 }, \"weather_conditions\": { \"type\": \"CLEAR\", \"intensity\": \"NONE\" }, \"time_to_impact\": 0.5, \"possible_actions\": [ \"EMERGENCY_BRAKE\", \"SWERVE_LEFT\", \"SWERVE_RIGHT\" ] }, \"ethical_principles\": { k: asdict(v) for k, v in ETHICAL_PRINCIPLES.items() }, \"available_actions\": [ \"EMERGENCY_BRAKE\", \"SWERVE_LEFT\", \"SWERVE_RIGHT\" ], \"risk_assessments\": {}, \"ethical_scores\": {}, \"decision\": None, \"next_action\": \"ANALYZE\" } # Run the workflow app = workflow.compile() print(\"\\nInitial Scenario Analysis:\") print(\"=========================\") print(f\"Vehicle Speed: {initial_state['current_scenario']['vehicle_state']['position']['speed']} km/h\") print(f\"Time to Impact: {initial_state['current_scenario']['time_to_impact']} seconds\") print(f\"Available Actions: {', '.join(initial_state['available_actions'])}\") print(\"\\nStarting Decision Process...\") for output in app.stream(initial_state): step = output[\"next_action\"] if step == \"EVALUATE\": print(\"\\nRisk Assessment Results:\") print(\"=======================\") for action, risks in output[\"risk_assessments\"].items(): print(f\"\\nAction: {action}\") for risk_type, score in risks.items(): print(f\"- {risk_type}: {score:.2f}\") elif step == \"DECIDE\": print(\"\\nEthical Evaluation Results:\") print(\"=========================\") for action, scores in output[\"ethical_scores\"].items(): print(f\"\\nAction: {action}\") for principle, score in scores.items(): print(f\"- {principle}: {score:.2f}\") elif step == \"END\" and output[\"decision\"]: print(\"\\nFinal Decision:\") print(\"==============\") decision = output[\"decision\"] print(f\"Chosen Action: {decision['action']}\") print(\"\\nReasoning:\") for reason in decision[\"reasoning\"]: print(f\"- {reason}\") print(f\"\\nConfidence: {decision['confidence']:.2f}\") print(\"\\nExpected Consequences:\") for consequence in decision[\"consequences\"]: print(f\"- {consequence['type']}: {consequence['description']}\") The workflow will now execute with detailed outputs at each step\nExample Output Explanation:\n1. Risk Assessment Phase: - Analyzes collision risks for each possible action - Considers environmental factors (road conditions, weather) - Evaluates time pressure and response windows 2. Ethical Evaluation Phase: - Applies ethical principles to each action - Weighs protection of vulnerable entities - Considers fairness and harm minimization 3. Decision Making Phase: - Combines risk and ethical assessments - Selects action with best overall score - Provides detailed reasoning and expected outcomes The system prioritizes: - Protection of human life - Minimization of harm - Fairness in risk distribution - Consideration of vulnerable individuals - Practical feasibility of actions Key ethical principles like minimizing harm and protecting vulnerable individuals are given higher weights in the decision process, while still maintaining a balance with practical safety considerations. การนำ Agentic Design Patterns ไปใช้งาน การเลือกใช้รูปแบบการออกแบบที่เหมาะสมเป็นสิ่งสำคัญมาก เพราะแต่ละรูปแบบมีจุดแข็งและข้อจำกัดที่แตกต่างกัน ในการพัฒนาระบบ AI ควรพิจารณาปัจจัยต่างๆ ดังนี้:\nลักษณะของงาน: งานที่ต้องการการตอบสนองรวดเร็วอาจเหมาะกับ Reflexive Agent ในขณะที่งานที่ซับซ้อนอาจต้องใช้ Meta-Agent หรือ Collaborative Multi-Agent Systems\nทรัพยากรที่มี: บางรูปแบบต้องการทรัพยากรการประมวลผลมาก เช่น Self-Improvement หรือ Adaptive Workflow Orchestration ควรพิจารณาความพร้อมของระบบก่อนเลือกใช้\nความต้องการด้านความแม่นยำ: งานที่ต้องการความแม่นยำสูงอาจต้องใช้รูปแบบที่มีการตรวจสอบและยืนยันผลลัพธ์ เช่น ReACT หรือ Planner-Executor\nความต้องการด้านการปรับตัว: หากระบบต้องทำงานในสภาพแวดล้อมที่เปลี่ยนแปลงบ่อย ควรเลือกรูปแบบที่มีความยืดหยุ่นสูง เช่น Self-Improvement หรือ Interactive Learning\nบทสรุป Agentic Design Patterns เป็นแนวคิดที่น่าสนใจและมีประโยชน์มากในการพัฒนาระบบ AI ให้ทำงานได้อย่างชาญฉลาด การเข้าใจจุดแข็งและข้อจำกัดของแต่ละรูปแบบจะช่วยให้เราสามารถเลือกใช้และผสมผสานรูปแบบต่างๆ ได้อย่างเหมาะสม เพื่อสร้างระบบ AI ที่มีประสิทธิภาพและตอบโจทย์ความต้องการได้อย่างแท้จริง\nแหล่งข้อมูลเพิ่มเติม Agentic Design Patterns Cover image by AI Agentic Design Patterns with AutoGen\nปล. บทความนี้เขียนด้วย AI (^ . ^)\n",
  "wordCount" : "13557",
  "inLanguage": "en",
  "image":"https://raw.githubusercontent.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen/main/images/l1.png","datePublished": "2025-02-06T00:00:00Z",
  "dateModified": "2025-02-06T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Apiwat Ruangkanjanapaisarn"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/agentic-ai/agentic-design-patterns/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Toffysoft's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Toffysoft (Alt + H)">
                        
                    <img src="http://localhost:1313/images/toffysoft_hu_7003f3165263a7ac.jpeg" alt="" aria-label="logo"
                        height="35">Toffysoft</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/agentic-ai/">Agentic AI</a></div>
    <h1 class="post-title entry-hint-parent">
      ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด
    </h1>
    <div class="post-description">
      เจาะลึกรูปแบบการออกแบบ AI ที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ พร้อมตัวอย่างการประยุกต์ใช้งานในโลกจริง
    </div>
    <div class="post-meta"><span title='2025-02-06 00:00:00 +0000 UTC'>February 6, 2025</span>&nbsp;·&nbsp;64 min&nbsp;·&nbsp;Apiwat Ruangkanjanapaisarn

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="https://raw.githubusercontent.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen/main/images/l1.png" alt="Image from (https://github.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen)">
        <p>Image from (<a href="https://github.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen">https://github.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen</a>)</p>
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#agentic-design-patterns-%e0%b8%84%e0%b8%ad%e0%b8%ad%e0%b8%b0%e0%b9%84%e0%b8%a3" aria-label="Agentic Design Patterns คืออะไร?">Agentic Design Patterns คืออะไร?</a></li>
                <li>
                    <a href="#%e0%b8%a3%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%99%e0%b8%b2%e0%b8%aa%e0%b8%99%e0%b9%83%e0%b8%88" aria-label="รูปแบบการออกแบบที่น่าสนใจ">รูปแบบการออกแบบที่น่าสนใจ</a><ul>
                        
                <li>
                    <a href="#1-react---%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%9c%e0%b8%aa%e0%b8%a1%e0%b8%9c%e0%b8%aa%e0%b8%b2%e0%b8%99%e0%b8%a3%e0%b8%b0%e0%b8%ab%e0%b8%a7%e0%b8%b2%e0%b8%87%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%84%e0%b8%94%e0%b9%81%e0%b8%a5%e0%b8%b0%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%81%e0%b8%a3%e0%b8%b0%e0%b8%97%e0%b8%b3" aria-label="1. ReACT - การผสมผสานระหว่างการคิดและการกระทำ">1. ReACT - การผสมผสานระหว่างการคิดและการกระทำ</a></li>
                <li>
                    <a href="#2-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%9e%e0%b8%92%e0%b8%99%e0%b8%b2%e0%b8%95%e0%b8%a7%e0%b9%80%e0%b8%ad%e0%b8%87%e0%b9%84%e0%b8%94-self-improvement" aria-label="2. ระบบที่พัฒนาตัวเองได้ (Self-Improvement)">2. ระบบที่พัฒนาตัวเองได้ (Self-Improvement)</a></li>
                <li>
                    <a href="#3-agentic-rag---%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%9c%e0%b8%aa%e0%b8%a1%e0%b8%9c%e0%b8%aa%e0%b8%b2%e0%b8%99%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%84%e0%b8%99%e0%b8%ab%e0%b8%b2%e0%b9%81%e0%b8%a5%e0%b8%b0%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%aa%e0%b8%a3%e0%b8%b2%e0%b8%87%e0%b9%80%e0%b8%99%e0%b8%ad%e0%b8%ab%e0%b8%b2" aria-label="3. Agentic RAG - การผสมผสานการค้นหาและการสร้างเนื้อหา">3. Agentic RAG - การผสมผสานการค้นหาและการสร้างเนื้อหา</a></li>
                <li>
                    <a href="#4-meta-agent---%e0%b8%9c%e0%b8%88%e0%b8%94%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%ad%e0%b8%88%e0%b8%89%e0%b8%a3%e0%b8%a2%e0%b8%b0" aria-label="4. Meta-Agent - ผู้จัดการระบบอัจฉริยะ">4. Meta-Agent - ผู้จัดการระบบอัจฉริยะ</a></li>
                <li>
                    <a href="#5-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%a7%e0%b8%b2%e0%b8%87%e0%b9%81%e0%b8%9c%e0%b8%99%e0%b9%81%e0%b8%a5%e0%b8%b0%e0%b8%9b%e0%b8%8f%e0%b8%9a%e0%b8%95-planner-executor" aria-label="5. ระบบวางแผนและปฏิบัติ (Planner-Executor)">5. ระบบวางแผนและปฏิบัติ (Planner-Executor)</a></li>
                <li>
                    <a href="#6-reflexive-agent---%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%95%e0%b8%ad%e0%b8%9a%e0%b8%aa%e0%b8%99%e0%b8%ad%e0%b8%87%e0%b8%ad%e0%b8%95%e0%b9%82%e0%b8%99%e0%b8%a1%e0%b8%95" aria-label="6. Reflexive Agent - ระบบตอบสนองอัตโนมัติ">6. Reflexive Agent - ระบบตอบสนองอัตโนมัติ</a></li>
                <li>
                    <a href="#7-interactive-learning---%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b9%80%e0%b8%a3%e0%b8%a2%e0%b8%99%e0%b8%a3%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%a1%e0%b8%9b%e0%b8%8f%e0%b8%aa%e0%b8%a1%e0%b8%9e%e0%b8%99%e0%b8%98" aria-label="7. Interactive Learning - การเรียนรู้แบบมีปฏิสัมพันธ์">7. Interactive Learning - การเรียนรู้แบบมีปฏิสัมพันธ์</a></li>
                <li>
                    <a href="#8-%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b9%81%e0%b8%a2%e0%b8%81%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%80%e0%b8%9b%e0%b8%99%e0%b8%a5%e0%b8%b3%e0%b8%94%e0%b8%9a%e0%b8%8a%e0%b8%99-hierarchical-task-decomposition" aria-label="8. การแยกงานเป็นลำดับชั้น (Hierarchical Task Decomposition)">8. การแยกงานเป็นลำดับชั้น (Hierarchical Task Decomposition)</a></li>
                <li>
                    <a href="#9-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b8%95%e0%b8%b2%e0%b8%a1%e0%b9%80%e0%b8%9b%e0%b8%b2%e0%b8%ab%e0%b8%a1%e0%b8%b2%e0%b8%a2-goal-oriented-agent" aria-label="9. ระบบที่ทำงานตามเป้าหมาย (Goal-Oriented Agent)">9. ระบบที่ทำงานตามเป้าหมาย (Goal-Oriented Agent)</a></li>
                <li>
                    <a href="#10-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%88%e0%b8%94%e0%b8%88%e0%b8%b3%e0%b8%9a%e0%b8%a3%e0%b8%9a%e0%b8%97-contextual-memory" aria-label="10. ระบบจดจำบริบท (Contextual Memory)">10. ระบบจดจำบริบท (Contextual Memory)</a></li>
                <li>
                    <a href="#11-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%ab%e0%b8%a5%e0%b8%b2%e0%b8%a2%e0%b8%95%e0%b8%a7%e0%b9%81%e0%b8%97%e0%b8%99%e0%b8%97%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b8%a3%e0%b8%a7%e0%b8%a1%e0%b8%81%e0%b8%99-collaborative-multi-agent-systems" aria-label="11. ระบบหลายตัวแทนที่ทำงานร่วมกัน (Collaborative Multi-Agent Systems)">11. ระบบหลายตัวแทนที่ทำงานร่วมกัน (Collaborative Multi-Agent Systems)</a></li>
                <li>
                    <a href="#12-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%aa%e0%b8%b3%e0%b8%a3%e0%b8%a7%e0%b8%88-exploratory-agent" aria-label="12. ระบบสำรวจ (Exploratory Agent)">12. ระบบสำรวจ (Exploratory Agent)</a></li>
                <li>
                    <a href="#13-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%88%e0%b8%94%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%82%e0%b8%99%e0%b8%95%e0%b8%ad%e0%b8%99%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%9b%e0%b8%a3%e0%b8%9a%e0%b8%95%e0%b8%a7%e0%b9%84%e0%b8%94-adaptive-workflow-orchestration" aria-label="13. ระบบจัดการขั้นตอนการทำงานแบบปรับตัวได้ (Adaptive Workflow Orchestration)">13. ระบบจัดการขั้นตอนการทำงานแบบปรับตัวได้ (Adaptive Workflow Orchestration)</a></li>
                <li>
                    <a href="#14-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%8b%e0%b8%ad%e0%b8%a1%e0%b9%81%e0%b8%8b%e0%b8%a1%e0%b8%95%e0%b8%a7%e0%b9%80%e0%b8%ad%e0%b8%87-self-healing-systems" aria-label="14. ระบบซ่อมแซมตัวเอง (Self-Healing Systems)">14. ระบบซ่อมแซมตัวเอง (Self-Healing Systems)</a></li>
                <li>
                    <a href="#15-%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%95%e0%b8%94%e0%b8%aa%e0%b8%99%e0%b9%83%e0%b8%88%e0%b8%95%e0%b8%b2%e0%b8%a1%e0%b8%ab%e0%b8%a5%e0%b8%81%e0%b8%88%e0%b8%a3%e0%b8%a2%e0%b8%98%e0%b8%a3%e0%b8%a3%e0%b8%a1-ethical-decision-making" aria-label="15. ระบบตัดสินใจตามหลักจริยธรรม (Ethical Decision-Making)">15. ระบบตัดสินใจตามหลักจริยธรรม (Ethical Decision-Making)</a></li></ul>
                </li>
                <li>
                    <a href="#%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%99%e0%b8%b3-agentic-design-patterns-%e0%b9%84%e0%b8%9b%e0%b9%83%e0%b8%8a%e0%b8%87%e0%b8%b2%e0%b8%99" aria-label="การนำ Agentic Design Patterns ไปใช้งาน">การนำ Agentic Design Patterns ไปใช้งาน</a></li>
                <li>
                    <a href="#%e0%b8%9a%e0%b8%97%e0%b8%aa%e0%b8%a3%e0%b8%9b" aria-label="บทสรุป">บทสรุป</a></li>
                <li>
                    <a href="#%e0%b9%81%e0%b8%ab%e0%b8%a5%e0%b8%87%e0%b8%82%e0%b8%ad%e0%b8%a1%e0%b8%a5%e0%b9%80%e0%b8%9e%e0%b8%a1%e0%b9%80%e0%b8%95%e0%b8%a1" aria-label="แหล่งข้อมูลเพิ่มเติม">แหล่งข้อมูลเพิ่มเติม</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>ในยุคที่ AI กำลังเข้ามามีบทบาทสำคัญในชีวิตประจำวันของเรามากขึ้น การออกแบบระบบ AI ให้สามารถทำงานได้อย่างชาญฉลาดและมีประสิทธิภาพจึงเป็นเรื่องที่สำคัญมาก หนึ่งในแนวคิดที่น่าสนใจคือ &ldquo;Agentic Design Patterns&rdquo; หรือรูปแบบการออกแบบที่ช่วยให้ระบบ AI สามารถคิด ตัดสินใจ และทำงานได้อย่างอิสระ มาทำความรู้จักกับแนวคิดนี้กันให้ลึกซึ้งยิ่งขึ้น</p>
<h2 id="agentic-design-patterns-คออะไร">Agentic Design Patterns คืออะไร?<a hidden class="anchor" aria-hidden="true" href="#agentic-design-patterns-คออะไร">#</a></h2>
<p>Agentic Design Patterns เป็นแนวทางการออกแบบที่ใช้ในการสร้างระบบ AI ที่สามารถทำงานได้อย่างอิสระ (Autonomous) โดยไม่ต้องพึ่งพาการควบคุมจากมนุษย์ตลอดเวลา รูปแบบการออกแบบเหล่านี้ช่วยกำหนดวิธีการที่ระบบ AI จะคิด ตัดสินใจ และมีปฏิสัมพันธ์กับสภาพแวดล้อม รวมถึงระบบอื่นๆ เพื่อให้บรรลุเป้าหมายที่ต้องการ</p>
<h2 id="รปแบบการออกแบบทนาสนใจ">รูปแบบการออกแบบที่น่าสนใจ<a hidden class="anchor" aria-hidden="true" href="#รปแบบการออกแบบทนาสนใจ">#</a></h2>
<h3 id="1-react---การผสมผสานระหวางการคดและการกระทำ">1. ReACT - การผสมผสานระหว่างการคิดและการกระทำ<a hidden class="anchor" aria-hidden="true" href="#1-react---การผสมผสานระหวางการคดและการกระทำ">#</a></h3>
<p>ReACT (Reasoning and Acting) เป็นรูปแบบที่น่าสนใจมาก เพราะจำลองการทำงานคล้ายกับวิธีที่มนุษย์เราคิดและตัดสินใจ โดยระบบจะ:</p>
<ol>
<li>วิเคราะห์สถานการณ์และคิดหาทางแก้ไข</li>
<li>ลงมือทำตามแผนที่วางไว้</li>
<li>ประเมินผลลัพธ์และปรับปรุงการตัดสินใจในรอบถัดไป</li>
</ol>
<p>ตัวอย่างที่เห็นได้ชัดคือ ระบบวางแผนการเดินทาง ที่จะสลับไปมาระหว่างการค้นหาเที่ยวบิน (การคิด) และการจองตั๋ว (การกระทำ) โดยปรับเปลี่ยนแผนตามราคาและความพร้อมของเที่ยวบินที่พบ</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง ReACT</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Annotated</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define our state structure</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AgentState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_plan</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">flight_data</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">booking_status</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Mock flight database</span>
</span></span><span class="line"><span class="cl"><span class="n">MOCK_FLIGHTS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;BKK-NRT&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;flight&#34;</span><span class="p">:</span> <span class="s2">&#34;TG676&#34;</span><span class="p">,</span> <span class="s2">&#34;departure&#34;</span><span class="p">:</span> <span class="s2">&#34;10:30&#34;</span><span class="p">,</span> <span class="s2">&#34;arrival&#34;</span><span class="p">:</span> <span class="s2">&#34;18:45&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;flight&#34;</span><span class="p">:</span> <span class="s2">&#34;JL708&#34;</span><span class="p">,</span> <span class="s2">&#34;departure&#34;</span><span class="p">:</span> <span class="s2">&#34;08:00&#34;</span><span class="p">,</span> <span class="s2">&#34;arrival&#34;</span><span class="p">:</span> <span class="s2">&#34;15:30&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mi">18000</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;NRT-BKK&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;flight&#34;</span><span class="p">:</span> <span class="s2">&#34;TG677&#34;</span><span class="p">,</span> <span class="s2">&#34;departure&#34;</span><span class="p">:</span> <span class="s2">&#34;19:30&#34;</span><span class="p">,</span> <span class="s2">&#34;arrival&#34;</span><span class="p">:</span> <span class="s2">&#34;00:45&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;flight&#34;</span><span class="p">:</span> <span class="s2">&#34;JL709&#34;</span><span class="p">,</span> <span class="s2">&#34;departure&#34;</span><span class="p">:</span> <span class="s2">&#34;16:30&#34;</span><span class="p">,</span> <span class="s2">&#34;arrival&#34;</span><span class="p">:</span> <span class="s2">&#34;22:00&#34;</span><span class="p">,</span> <span class="s2">&#34;price&#34;</span><span class="p">:</span> <span class="mi">17000</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>  <span class="c1"># หรือใช้โมเดลอื่นที่ OpenRouter รองรับ</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>  <span class="c1"># your website URL</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Flight Booking Assistant&#34;</span>  <span class="c1"># your app name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reasoning_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze the current situation and plan next steps
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Create a prompt for the LLM to analyze the situation</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Current situation:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Planning status: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_plan&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Available flight data: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;flight_data&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Booking status: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;booking_status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        What should be the next action? Choose from:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. SEARCH_FLIGHTS - If we need to look for flights
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. BOOK_FLIGHT - If we found a suitable flight and should book it
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. END - If we&#39;ve completed the booking
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Provide your reasoning and the next action.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Get LLM response</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Extract next action from response</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;SEARCH_FLIGHTS&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;SEARCH_FLIGHTS&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;BOOK_FLIGHT&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;BOOK_FLIGHT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;END&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Reasoning: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">search_flights</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Search for available flights based on the current plan
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_plan&#39;</span><span class="p">][</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_plan&#39;</span><span class="p">][</span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">MOCK_FLIGHTS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;flight_data&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MOCK_FLIGHTS</span><span class="p">[</span><span class="n">route</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">MOCK_FLIGHTS</span><span class="p">[</span><span class="n">route</span><span class="p">])</span><span class="si">}</span><span class="s2"> flights for </span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;flight_data&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;No flights found for </span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">book_flight</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Attempt to book the selected flight
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;flight_data&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Find the cheapest flight</span>
</span></span><span class="line"><span class="cl">        <span class="n">selected_flight</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;flight_data&#34;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&#34;price&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;booking_status&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;CONFIRMED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;Booked flight </span><span class="si">{</span><span class="n">selected_flight</span><span class="p">[</span><span class="s1">&#39;flight&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">selected_flight</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> THB&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;booking_status&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;FAILED&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;Booking failed - no flights available&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Route to the next step based on the reasoning outcome
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AgentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;reasoning&#34;</span><span class="p">,</span> <span class="n">reasoning_step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;search_flights&#34;</span><span class="p">,</span> <span class="n">search_flights</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;book_flight&#34;</span><span class="p">,</span> <span class="n">book_flight</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;reasoning&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;search_flights&#34;</span><span class="p">,</span> <span class="s2">&#34;reasoning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;book_flight&#34;</span><span class="p">,</span> <span class="s2">&#34;reasoning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;reasoning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;reasoning&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SEARCH_FLIGHTS&#34;</span><span class="p">:</span> <span class="s2">&#34;search_flights&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;BOOK_FLIGHT&#34;</span><span class="p">:</span> <span class="s2">&#34;book_flight&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_plan&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;BKK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;destination&#34;</span><span class="p">:</span> <span class="s2">&#34;NRT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-02-15&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;flight_data&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;booking_status&#34;</span><span class="p">:</span> <span class="s2">&#34;NOT_STARTED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;SEARCH_FLIGHTS&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="2-ระบบทพฒนาตวเองได-self-improvement">2. ระบบที่พัฒนาตัวเองได้ (Self-Improvement)<a hidden class="anchor" aria-hidden="true" href="#2-ระบบทพฒนาตวเองได-self-improvement">#</a></h3>
<p>ความน่าสนใจของรูปแบบนี้อยู่ที่ความสามารถในการเรียนรู้และพัฒนาตัวเองอย่างต่อเนื่อง เหมือนกับที่มนุษย์เราเรียนรู้จากประสบการณ์ ระบบจะ:</p>
<ul>
<li>ประเมินผลการทำงานของตัวเอง</li>
<li>เรียนรู้จากข้อมูลใหม่ๆ</li>
<li>ปรับปรุงกระบวนการทำงานภายใน</li>
</ul>
<p>ตัวอย่างที่เห็นได้บ่อยคือ ผู้ช่วยเขียนโค้ด ที่จะปรับปรุงคำแนะนำให้ดีขึ้นจากการวิเคราะห์ผลตอบรับของผู้ใช้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Self-Improvement</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define our state and data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CodeSuggestion</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">explanation</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback_score</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AssistantState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_query</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">suggestions_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">improvement_metrics</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_suggestion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>  <span class="c1"># หรือโมเดลอื่นที่ OpenRouter รองรับ</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>  <span class="c1"># your website URL</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Code Assistant&#34;</span>  <span class="c1"># your app name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Knowledge base for code patterns (would be expanded in real implementation)</span>
</span></span><span class="line"><span class="cl"><span class="n">CODE_PATTERNS_DB</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;error_handling&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;examples&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;try-except blocks&#34;</span><span class="p">,</span> <span class="s2">&#34;error logging&#34;</span><span class="p">,</span> <span class="s2">&#34;graceful degradation&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;code_style&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;examples&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;PEP8 compliance&#34;</span><span class="p">,</span> <span class="s2">&#34;meaningful variable names&#34;</span><span class="p">,</span> <span class="s2">&#34;proper indentation&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;performance&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;examples&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;algorithmic efficiency&#34;</span><span class="p">,</span> <span class="s2">&#34;memory usage&#34;</span><span class="p">,</span> <span class="s2">&#34;optimization techniques&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_code_suggestion</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AssistantState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssistantState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Generate code suggestions based on current knowledge and past feedback
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Task: Generate Python code based on the following:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Query: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Consider past feedback patterns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;improvement_metrics&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. Code suggestion (in ```python code blocks)
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. Explanation:
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. Confidence: (a number between 0-1)
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Parse LLM response (in real implementation, would use more robust parsing)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suggestion</span> <span class="o">=</span> <span class="n">CodeSuggestion</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;```python&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;```&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">explanation</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Explanation:&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Confidence:&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">confidence</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Confidence:&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_suggestion&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">suggestion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;suggestions_history&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">suggestion</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;EVALUATE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate_feedback</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AssistantState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssistantState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze user feedback and update improvement metrics
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;feedback_history&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">recent_feedback</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;feedback_history&#34;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze feedback and update metrics</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback_score</span> <span class="o">=</span> <span class="n">recent_feedback</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;score&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback_comments</span> <span class="o">=</span> <span class="n">recent_feedback</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;comments&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update improvement metrics based on feedback</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Analyze this feedback and identify which patterns need adjustment:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Score: </span><span class="si">{</span><span class="n">feedback_score</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Comments: </span><span class="si">{</span><span class="n">feedback_comments</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Current metrics: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;improvement_metrics&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Analyze which patterns (error_handling, code_style, performance) are mentioned
</span></span></span><span class="line"><span class="cl"><span class="s2">        in the feedback and should be adjusted.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update metrics (simplified version)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">CODE_PATTERNS_DB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;improvement_metrics&#34;</span><span class="p">][</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&#34;weight&#34;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">feedback_score</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Normalize weights</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&#34;weight&#34;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;improvement_metrics&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;improvement_metrics&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;improvement_metrics&#34;</span><span class="p">][</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&#34;weight&#34;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total_weight</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;REFLECT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">self_reflection</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AssistantState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssistantState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Periodic self-reflection to identify areas for improvement
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;suggestions_history&#34;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Need more data for meaningful reflection</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze recent performance</span>
</span></span><span class="line"><span class="cl">    <span class="n">recent_suggestions</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;suggestions_history&#34;</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">avg_confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s2">&#34;confidence&#34;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">recent_suggestions</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Analyze recent performance and suggest improvements:
</span></span></span><span class="line"><span class="cl"><span class="s2">        Average confidence: </span><span class="si">{</span><span class="n">avg_confidence</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Recent suggestions: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">recent_suggestions</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Current metrics: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;improvement_metrics&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Please provide specific suggestions for improving:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. Code quality
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. Explanation clarity
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. Confidence estimation accuracy
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state with reflection insights</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Self-reflection insights: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AssistantState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Route to the next step based on the current state
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AssistantState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;generate&#34;</span><span class="p">,</span> <span class="n">generate_code_suggestion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;evaluate&#34;</span><span class="p">,</span> <span class="n">evaluate_feedback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;reflect&#34;</span><span class="p">,</span> <span class="n">self_reflection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;generate&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;evaluate&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;reflect&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;generate&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;generate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;EVALUATE&#34;</span><span class="p">:</span> <span class="s2">&#34;evaluate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;evaluate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;REFLECT&#34;</span><span class="p">:</span> <span class="s2">&#34;reflect&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;reflect&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_query&#34;</span><span class="p">:</span> <span class="s2">&#34;Write a function to find the nth Fibonacci number with memoization&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;suggestions_history&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;feedback_history&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;score&#34;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;comments&#34;</span><span class="p">:</span> <span class="s2">&#34;Good use of memoization, but could improve error handling&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;improvement_metrics&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;error_handling&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&#34;count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;code_style&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s2">&#34;count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;performance&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&#34;count&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;GENERATE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_suggestion&#34;</span><span class="p">:</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="3-agentic-rag---การผสมผสานการคนหาและการสรางเนอหา">3. Agentic RAG - การผสมผสานการค้นหาและการสร้างเนื้อหา<a hidden class="anchor" aria-hidden="true" href="#3-agentic-rag---การผสมผสานการคนหาและการสรางเนอหา">#</a></h3>
<p>รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบ AI สามารถใช้ข้อมูลจากแหล่งภายนอกมาประกอบการตัดสินใจได้ โดย:</p>
<ul>
<li>ค้นหาข้อมูลที่เกี่ยวข้องจากฐานข้อมูล</li>
<li>นำข้อมูลมาประมวลผลและสร้างเป็นคำตอบ</li>
<li>ตรวจสอบความถูกต้องของข้อมูลก่อนนำไปใช้</li>
</ul>
<p>ระบบแชทบอทให้บริการลูกค้าที่สามารถค้นหาข้อมูลจากเอกสารนโยบายและสร้างคำตอบที่เหมาะสมเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Agentic RAG</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_community.vectorstores</span> <span class="kn">import</span> <span class="n">FAISS</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_community.embeddings</span> <span class="kn">import</span> <span class="n">OllamaEmbeddings</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.text_splitter</span> <span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RetrievedDocument</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">relevance_score</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GeneratedResponse</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ChatbotState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_query</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">retrieved_docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">generated_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">verification_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Mock policy database</span>
</span></span><span class="line"><span class="cl"><span class="n">POLICY_DOCUMENTS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;returns&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Return Policy:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Items can be returned within 30 days of purchase
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Must have original receipt
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Items must be unused and in original packaging
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Shipping costs are non-refundable
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Store credit or refund will be issued within 7 business days
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;shipping&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Shipping Policy:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Free shipping on orders over 1000 THB
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Standard shipping: 3-5 business days
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Express shipping: 1-2 business days (additional fee)
</span></span></span><span class="line"><span class="cl"><span class="s2">    - International shipping available to select countries
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Tracking number provided for all shipments
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;warranty&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Warranty Policy:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - 1-year manufacturer warranty on all products
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Covers defects in materials and workmanship
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Does not cover damage from misuse or accidents
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Warranty claims require proof of purchase
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Replacement or repair decision at company discretion
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize components</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Policy Assistant&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize Ollama embeddings</span>
</span></span><span class="line"><span class="cl"><span class="n">embeddings</span> <span class="o">=</span> <span class="n">OllamaEmbeddings</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;nomic-embed-text&#34;</span><span class="p">,</span>  <span class="c1"># หรือจะใช้โมเดลอื่นที่ Ollama รองรับ</span>
</span></span><span class="line"><span class="cl">    <span class="n">base_url</span><span class="o">=</span><span class="s2">&#34;http://localhost:11434&#34;</span>  <span class="c1"># ปรับ URL ตาม Ollama server</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create vector store from policy documents</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">initialize_vector_store</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">policy_type</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">POLICY_DOCUMENTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">texts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">metadatas</span><span class="o">.</span><span class="n">extend</span><span class="p">([{</span><span class="s2">&#34;source&#34;</span><span class="p">:</span> <span class="n">policy_type</span><span class="p">}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FAISS</span><span class="o">.</span><span class="n">from_texts</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">vector_store</span> <span class="o">=</span> <span class="n">initialize_vector_store</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">retrieve_relevant_docs</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Retrieve relevant documents based on the user query
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Search vector store</span>
</span></span><span class="line"><span class="cl">    <span class="n">docs</span> <span class="o">=</span> <span class="n">vector_store</span><span class="o">.</span><span class="n">similarity_search_with_score</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_query&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Process and store retrieved documents</span>
</span></span><span class="line"><span class="cl">    <span class="n">retrieved_docs</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">asdict</span><span class="p">(</span><span class="n">RetrievedDocument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span><span class="o">=</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="o">=</span><span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&#34;source&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">relevance_score</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;retrieved_docs&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retrieved_docs</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;GENERATE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Generate response using retrieved documents
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Prepare context from retrieved documents</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;Document from </span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;retrieved_docs&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Based on the following context and user query, generate a helpful response.
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Context:
</span></span></span><span class="line"><span class="cl"><span class="s2">        </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        User Query:
</span></span></span><span class="line"><span class="cl"><span class="s2">        </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_query&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Generate a response that:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. Directly answers the user&#39;s question
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. References specific policies when relevant
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. Is clear and easy to understand
</span></span></span><span class="line"><span class="cl"><span class="s2">        4. Uses bullet points for important information
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">generated_response</span> <span class="o">=</span> <span class="n">GeneratedResponse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>  <span class="c1"># In real implementation, would calculate based on relevance scores</span>
</span></span><span class="line"><span class="cl">        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&#34;source&#34;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;retrieved_docs&#34;</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;generated_response&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">generated_response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;VERIFY&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify_response</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Verify the generated response against policy documents
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;generated_response&#34;</span><span class="p">][</span><span class="s2">&#34;response&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">sources</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;retrieved_docs&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Verify this response against the source documents for accuracy:
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Response:
</span></span></span><span class="line"><span class="cl"><span class="s2">        </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Source Documents:
</span></span></span><span class="line"><span class="cl"><span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Check for:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. Factual accuracy
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. Completeness
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. Consistency with policies
</span></span></span><span class="line"><span class="cl"><span class="s2">        4. Any missing important information
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. Verification result (verified/not verified)
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. Confidence score (0-1)
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. Detailed notes about any issues found
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">verification</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;verification_result&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;verified&#34;</span><span class="p">:</span> <span class="s2">&#34;incorrect information&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">verification</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;confidence&#34;</span><span class="p">:</span> <span class="mf">0.9</span> <span class="k">if</span> <span class="s2">&#34;high confidence&#34;</span> <span class="ow">in</span> <span class="n">verification</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;notes&#34;</span><span class="p">:</span> <span class="n">verification</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span> <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;verification_result&#34;</span><span class="p">][</span><span class="s2">&#34;verified&#34;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&#34;GENERATE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Route to the next step based on the current state
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ChatbotState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;retrieve&#34;</span><span class="p">,</span> <span class="n">retrieve_relevant_docs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;generate&#34;</span><span class="p">,</span> <span class="n">generate_response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;verify&#34;</span><span class="p">,</span> <span class="n">verify_response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;retrieve&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;generate&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;verify&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;retrieve&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;retrieve&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;GENERATE&#34;</span><span class="p">:</span> <span class="s2">&#34;generate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;generate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;VERIFY&#34;</span><span class="p">:</span> <span class="s2">&#34;verify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;verify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;GENERATE&#34;</span><span class="p">:</span> <span class="s2">&#34;generate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_query&#34;</span><span class="p">:</span> <span class="s2">&#34;What is your return policy for unused items?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;retrieved_docs&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;generated_response&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;verification_result&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;RETRIEVE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="4-meta-agent---ผจดการระบบอจฉรยะ">4. Meta-Agent - ผู้จัดการระบบอัจฉริยะ<a hidden class="anchor" aria-hidden="true" href="#4-meta-agent---ผจดการระบบอจฉรยะ">#</a></h3>
<p>เปรียบเสมือนผู้จัดการโครงการที่คอยประสานงานระหว่างทีมย่อยต่างๆ Meta-Agent จะ:</p>
<ul>
<li>แบ่งงานให้ระบบย่อยที่เชี่ยวชาญเฉพาะด้าน</li>
<li>ประสานงานให้ทุกส่วนทำงานสอดคล้องกัน</li>
<li>ติดตามและควบคุมคุณภาพของงาน</li>
</ul>
<p>ตัวอย่างเช่น ระบบบริหารโครงการที่แบ่งงานให้ระบบย่อยดูแลเรื่องการจัดตารางเวลา งบประมาณ และการรายงานผล</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Meta-Agent</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># in days</span>
</span></span><span class="line"><span class="cl">    <span class="n">dependencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">assigned_to</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_cost</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ScheduleReport</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">critical_path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">milestone_dates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BudgetReport</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_cost</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">cost_breakdown</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">budget_status</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">warnings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ProjectState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">quality_metrics</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_request</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>  <span class="c1"># your website URL</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Project Management Assistant&#34;</span>  <span class="c1"># your app name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SchedulingAgent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Agent responsible for project scheduling&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_schedule</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Task</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ScheduleReport</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Create schedule based on task dependencies and durations</span>
</span></span><span class="line"><span class="cl">        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">schedule</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">scheduled_tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">can_schedule</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">dep</span> <span class="ow">in</span> <span class="n">scheduled_tasks</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">current_date</span> <span class="o">=</span> <span class="n">today</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">scheduled_tasks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scheduled_tasks</span> <span class="ow">and</span> <span class="n">can_schedule</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">schedule</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">current_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">current_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">duration</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ScheduleReport</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">start_date</span><span class="o">=</span><span class="n">today</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">end_date</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">schedule</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="n">critical_path</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">schedule</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>  <span class="c1"># Simplified critical path</span>
</span></span><span class="line"><span class="cl">            <span class="n">milestone_dates</span><span class="o">=</span><span class="n">schedule</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BudgetingAgent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Agent responsible for budget management&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_budget</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Task</span><span class="p">],</span> <span class="n">schedule</span><span class="p">:</span> <span class="n">ScheduleReport</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BudgetReport</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">estimated_cost</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate cost breakdown by category</span>
</span></span><span class="line"><span class="cl">        <span class="n">cost_breakdown</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">category</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">assigned_to</span>
</span></span><span class="line"><span class="cl">            <span class="n">cost_breakdown</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_breakdown</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">estimated_cost</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Determine budget status and warnings</span>
</span></span><span class="line"><span class="cl">        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">total_cost</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>  <span class="c1"># Example budget threshold</span>
</span></span><span class="line"><span class="cl">            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;Project exceeds recommended budget&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;GREEN&#34;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">warnings</span> <span class="k">else</span> <span class="s2">&#34;YELLOW&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">BudgetReport</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_cost</span><span class="o">=</span><span class="n">total_cost</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">cost_breakdown</span><span class="o">=</span><span class="n">cost_breakdown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">budget_status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">warnings</span><span class="o">=</span><span class="n">warnings</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">QualityAgent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Agent responsible for quality control&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">assess_quality</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ProjectState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze the project quality and provide assessment:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Schedule Information:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Budget Information:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;budget&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Task Information:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Quality score (0-100)
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Risk level assessment (LOW/MEDIUM/HIGH)
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Specific improvement recommendations
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Areas of concern, if any
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Format your response with clear sections and bullet points.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Parse LLM response (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">quality_metrics</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;quality_score&#34;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>  <span class="c1"># Would be parsed from response</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;risk_level&#34;</span><span class="p">:</span> <span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;recommendations&#34;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">quality_metrics</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">meta_agent_coordinator</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ProjectState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProjectState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Main coordination function that delegates tasks to specialized agents
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Analyze this project management request and determine the next action:
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Current Request: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_request&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Current State: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Available actions:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. SCHEDULE - Create or update project schedule
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. BUDGET - Analyze project budget and costs
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. QUALITY - Assess project quality and risks
</span></span></span><span class="line"><span class="cl"><span class="s2">        4. END - Complete the workflow
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Dependencies between tasks
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Resource allocation
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Timeline constraints
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Budget requirements
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Provide your reasoning and recommended next action.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Determine next action based on LLM response</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;SCHEDULE&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;SCHEDULE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;BUDGET&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;BUDGET&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;QUALITY&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;QUALITY&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_scheduling</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ProjectState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProjectState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Handle scheduling tasks&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Task</span><span class="p">(</span><span class="o">**</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">schedule</span> <span class="o">=</span> <span class="n">SchedulingAgent</span><span class="o">.</span><span class="n">create_schedule</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;schedule&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;BUDGET&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_budgeting</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ProjectState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProjectState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Handle budget analysis&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">Task</span><span class="p">(</span><span class="o">**</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">budget</span> <span class="o">=</span> <span class="n">BudgetingAgent</span><span class="o">.</span><span class="n">analyze_budget</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">ScheduleReport</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;schedule&#34;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;budget&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;QUALITY&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">handle_quality</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ProjectState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProjectState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Handle quality assessment&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">quality_metrics</span> <span class="o">=</span> <span class="n">QualityAgent</span><span class="o">.</span><span class="n">assess_quality</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;quality_metrics&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quality_metrics</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ProjectState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ProjectState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;coordinate&#34;</span><span class="p">,</span> <span class="n">meta_agent_coordinator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;schedule&#34;</span><span class="p">,</span> <span class="n">handle_scheduling</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;budget&#34;</span><span class="p">,</span> <span class="n">handle_budgeting</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;quality&#34;</span><span class="p">,</span> <span class="n">handle_quality</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;coordinate&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;schedule&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;budget&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;quality&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;coordinate&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;coordinate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCHEDULE&#34;</span><span class="p">:</span> <span class="s2">&#34;schedule&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;BUDGET&#34;</span><span class="p">:</span> <span class="s2">&#34;budget&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;QUALITY&#34;</span><span class="p">:</span> <span class="s2">&#34;quality&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;schedule&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;BUDGET&#34;</span><span class="p">:</span> <span class="s2">&#34;budget&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;budget&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;QUALITY&#34;</span><span class="p">:</span> <span class="s2">&#34;quality&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;quality&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state with example project tasks</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_request&#34;</span><span class="p">:</span> <span class="s2">&#34;Create project schedule and analyze budget&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;tasks&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;T1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Requirements Analysis&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Gather and analyze project requirements&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;assigned_to&#34;</span><span class="p">:</span> <span class="s2">&#34;Analysis Team&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;Not Started&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;estimated_cost&#34;</span><span class="p">:</span> <span class="mi">20000</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;T2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;System Design&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Create system architecture and design&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;T1&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;assigned_to&#34;</span><span class="p">:</span> <span class="s2">&#34;Design Team&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;Not Started&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;estimated_cost&#34;</span><span class="p">:</span> <span class="mi">30000</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;T3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Implementation&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Develop the system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;duration&#34;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;T2&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;assigned_to&#34;</span><span class="p">:</span> <span class="s2">&#34;Development Team&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;Not Started&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;estimated_cost&#34;</span><span class="p">:</span> <span class="mi">50000</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;schedule&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;budget&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;quality_metrics&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;COORDINATE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="5-ระบบวางแผนและปฏบต-planner-executor">5. ระบบวางแผนและปฏิบัติ (Planner-Executor)<a hidden class="anchor" aria-hidden="true" href="#5-ระบบวางแผนและปฏบต-planner-executor">#</a></h3>
<p>รูปแบบนี้แยกการทำงานเป็นสองส่วนชัดเจน คือ:</p>
<p>ส่วนวางแผน:</p>
<ul>
<li>วิเคราะห์สถานการณ์</li>
<li>กำหนดกลยุทธ์</li>
<li>จัดลำดับความสำคัญของงาน</li>
</ul>
<p>ส่วนปฏิบัติ:</p>
<ul>
<li>ดำเนินการตามแผน</li>
<li>รายงานความคืบหน้า</li>
<li>แจ้งเตือนเมื่อพบปัญหา</li>
</ul>
<p>ระบบ AI ที่เล่นเกมเป็นตัวอย่างที่ดี โดยส่วนวางแผนจะคิดกลยุทธ์การเล่น และส่วนปฏิบัติจะควบคุมการเคลื่อนไหวในเกม</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Planner-Executor</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define game-specific structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GameState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">board</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>  <span class="c1"># tic-tac-toe board</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_player</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">moves_made</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">game_over</span><span class="p">:</span> <span class="nb">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Strategy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_goal</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">fallback_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">expected_outcome</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Move</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">position</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">player</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">reasoning</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AIState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">game_state</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_strategy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">planned_move</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">execution_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>  <span class="c1"># หรือโมเดลอื่นที่ OpenRouter รองรับ</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>  <span class="c1"># your website URL</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Tic-Tac-Toe AI&#34;</span>  <span class="c1"># your app name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GameManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Manages the game state and rules&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_empty_board</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[[</span><span class="s2">&#34; &#34;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_valid_move</span><span class="p">(</span><span class="n">board</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">position</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">position</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">row</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34; &#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">make_move</span><span class="p">(</span><span class="n">board</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">position</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">player</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_board</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">board</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">position</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">player</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">new_board</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_winner</span><span class="p">(</span><span class="n">board</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Check rows</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">board</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34; &#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check columns</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34; &#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check diagonals</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34; &#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34; &#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Planner</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Strategic planner for the game&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_game_state</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">board_str</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&#34;|&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">board</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze this Tic-Tac-Toe board and create a strategic plan:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Board:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">board_str</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Player: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">current_player</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            Moves Made: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">moves_made</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please provide a structured strategy with:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Main Goal: [win/block/develop]
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Priority Positions: Provide coordinates as tuples (row, col), 0-2
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Fallback Positions: Provide alternative coordinates
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Expected Outcome: [Victory/Draw/Continue]
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Winning opportunities
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Blocking opponent&#39;s winning moves
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Center and corner control
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Development of winning patterns
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Parse response to create strategy (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># In real implementation, would use more robust parsing</span>
</span></span><span class="line"><span class="cl">        <span class="n">strategy</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">main_goal</span><span class="o">=</span><span class="s2">&#34;Win in next move&#34;</span> <span class="k">if</span> <span class="s2">&#34;win&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;Block opponent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">priority_positions</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>  <span class="c1"># Example positions</span>
</span></span><span class="line"><span class="cl">            <span class="n">fallback_positions</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">            <span class="n">expected_outcome</span><span class="o">=</span><span class="s2">&#34;Victory&#34;</span> <span class="k">if</span> <span class="s2">&#34;victory&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;Continue&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">strategy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Tactical executor of planned moves&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">execute_move</span><span class="p">(</span><span class="n">game_state</span><span class="p">:</span> <span class="n">GameState</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Move</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Try priority positions first</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="n">priority_positions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">GameManager</span><span class="o">.</span><span class="n">is_valid_move</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Move</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">position</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">player</span><span class="o">=</span><span class="n">game_state</span><span class="o">.</span><span class="n">current_player</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">reasoning</span><span class="o">=</span><span class="s2">&#34;Priority position available&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Try fallback positions</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="n">fallback_positions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">GameManager</span><span class="o">.</span><span class="n">is_valid_move</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Move</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">position</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">player</span><span class="o">=</span><span class="n">game_state</span><span class="o">.</span><span class="n">current_player</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">reasoning</span><span class="o">=</span><span class="s2">&#34;Fallback position used&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Find any valid move if nothing else is available</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">GameManager</span><span class="o">.</span><span class="n">is_valid_move</span><span class="p">(</span><span class="n">game_state</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">Move</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">player</span><span class="o">=</span><span class="n">game_state</span><span class="o">.</span><span class="n">current_player</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">priority</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">reasoning</span><span class="o">=</span><span class="s2">&#34;Last resort move&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;No valid moves available&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strategic_planning</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AIState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AIState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Strategic planning phase
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">game_state</span> <span class="o">=</span> <span class="n">GameState</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;game_state&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">Planner</span><span class="o">.</span><span class="n">analyze_game_state</span><span class="p">(</span><span class="n">game_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_strategy&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;EXECUTE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">tactical_execution</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AIState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AIState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Tactical execution phase
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">game_state</span> <span class="o">=</span> <span class="n">GameState</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;game_state&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">strategy</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_strategy&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Execute the planned move</span>
</span></span><span class="line"><span class="cl">    <span class="n">move</span> <span class="o">=</span> <span class="n">Executor</span><span class="o">.</span><span class="n">execute_move</span><span class="p">(</span><span class="n">game_state</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update game state with the executed move</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_board</span> <span class="o">=</span> <span class="n">GameManager</span><span class="o">.</span><span class="n">make_move</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">game_state</span><span class="o">.</span><span class="n">board</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">move</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">game_state</span><span class="o">.</span><span class="n">current_player</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;game_state&#34;</span><span class="p">][</span><span class="s2">&#34;board&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_board</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;game_state&#34;</span><span class="p">][</span><span class="s2">&#34;moves_made&#34;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;execution_result&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">move</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Check for game end conditions</span>
</span></span><span class="line"><span class="cl">    <span class="n">winner</span> <span class="o">=</span> <span class="n">GameManager</span><span class="o">.</span><span class="n">check_winner</span><span class="p">(</span><span class="n">new_board</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">winner</span> <span class="ow">or</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;game_state&#34;</span><span class="p">][</span><span class="s2">&#34;moves_made&#34;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;game_state&#34;</span><span class="p">][</span><span class="s2">&#34;game_over&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;PLAN&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AIState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Route to the next step based on the current state
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AIState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">,</span> <span class="n">strategic_planning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;execute&#34;</span><span class="p">,</span> <span class="n">tactical_execution</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;execute&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;plan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;EXECUTE&#34;</span><span class="p">:</span> <span class="s2">&#34;execute&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;execute&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PLAN&#34;</span><span class="p">:</span> <span class="s2">&#34;plan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state with empty game</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;game_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;board&#34;</span><span class="p">:</span> <span class="n">GameManager</span><span class="o">.</span><span class="n">create_empty_board</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;current_player&#34;</span><span class="p">:</span> <span class="s2">&#34;X&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;moves_made&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;game_over&#34;</span><span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_strategy&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;planned_move&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;execution_result&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;PLAN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="6-reflexive-agent---ระบบตอบสนองอตโนมต">6. Reflexive Agent - ระบบตอบสนองอัตโนมัติ<a hidden class="anchor" aria-hidden="true" href="#6-reflexive-agent---ระบบตอบสนองอตโนมต">#</a></h3>
<p>รูปแบบนี้เน้นการตอบสนองที่รวดเร็วต่อการเปลี่ยนแปลง โดย:</p>
<ul>
<li>ตรวจจับการเปลี่ยนแปลงในสภาพแวดล้อม</li>
<li>ตอบสนองทันทีตามกฎที่กำหนดไว้</li>
<li>ไม่ต้องใช้เวลาคิดวิเคราะห์มาก</li>
</ul>
<p>หุ่นยนต์ดูดฝุ่นที่หลบสิ่งกีดขวางอัตโนมัติเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Reflexive Agent</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define enums for direction and action</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Direction</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">NORTH</span> <span class="o">=</span> <span class="s2">&#34;NORTH&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SOUTH</span> <span class="o">=</span> <span class="s2">&#34;SOUTH&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EAST</span> <span class="o">=</span> <span class="s2">&#34;EAST&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WEST</span> <span class="o">=</span> <span class="s2">&#34;WEST&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Action</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVE_FORWARD</span> <span class="o">=</span> <span class="s2">&#34;MOVE_FORWARD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TURN_LEFT</span> <span class="o">=</span> <span class="s2">&#34;TURN_LEFT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TURN_RIGHT</span> <span class="o">=</span> <span class="s2">&#34;TURN_RIGHT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CLEAN</span> <span class="o">=</span> <span class="s2">&#34;CLEAN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">RETURN_HOME</span> <span class="o">=</span> <span class="s2">&#34;RETURN_HOME&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Position</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SensorData</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">front_obstacle</span><span class="p">:</span> <span class="nb">bool</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_obstacle</span><span class="p">:</span> <span class="nb">bool</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_obstacle</span><span class="p">:</span> <span class="nb">bool</span>
</span></span><span class="line"><span class="cl">    <span class="n">dirt_detected</span><span class="p">:</span> <span class="nb">bool</span>
</span></span><span class="line"><span class="cl">    <span class="n">battery_level</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RobotState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">position</span><span class="p">:</span> <span class="n">Position</span>
</span></span><span class="line"><span class="cl">    <span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span>
</span></span><span class="line"><span class="cl">    <span class="n">battery_level</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">cleaned_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AgentState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">robot_state</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">sensor_data</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">action_taken</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Simulated environment</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Environment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">obstacles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_obstacles</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dirt_locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_dirt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_obstacles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Generate random obstacles</span>
</span></span><span class="line"><span class="cl">        <span class="n">obstacles</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_obstacles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_obstacles</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># Keep starting position clear</span>
</span></span><span class="line"><span class="cl">                <span class="n">obstacles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">obstacles</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_generate_dirt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Generate random dirt locations</span>
</span></span><span class="line"><span class="cl">        <span class="n">dirt</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_dirt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_dirt</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstacles</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dirt</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_sensor_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Position</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SensorData</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Check for obstacles in adjacent positions</span>
</span></span><span class="line"><span class="cl">        <span class="n">front_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adjacent_position</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">left_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adjacent_position</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_turn_left</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">right_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_adjacent_position</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_turn_right</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SensorData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">front_obstacle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_obstacle</span><span class="p">(</span><span class="n">front_pos</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">left_obstacle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_obstacle</span><span class="p">(</span><span class="n">left_pos</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">right_obstacle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_obstacle</span><span class="p">(</span><span class="n">right_pos</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">dirt_detected</span><span class="o">=</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirt_locations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">battery_level</span><span class="o">=</span><span class="mi">100</span>  <span class="c1"># Simplified battery simulation</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_is_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Position</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Check if position is obstacle or out of bounds</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> 
</span></span><span class="line"><span class="cl">            <span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstacles</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_get_adjacent_position</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="n">Position</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Position</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Position</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">SOUTH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Position</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">EAST</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Position</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># WEST</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Position</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_turn_left</span><span class="p">(</span><span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Direction</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">turns</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">WEST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">WEST</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">SOUTH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">SOUTH</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">EAST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">EAST</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">turns</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_turn_right</span><span class="p">(</span><span class="n">direction</span><span class="p">:</span> <span class="n">Direction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Direction</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">turns</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">EAST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">EAST</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">SOUTH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">SOUTH</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">WEST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Direction</span><span class="o">.</span><span class="n">WEST</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">turns</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Robot Vacuum AI&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">StrategicAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes environment and suggests optimal strategies&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_situation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">sensor_data</span><span class="p">:</span> <span class="n">SensorData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">robot_state</span><span class="p">:</span> <span class="n">RobotState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">env_size</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Create a map representation</span>
</span></span><span class="line"><span class="cl">        <span class="n">map_data</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&#34;?&#34;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">env_size</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">env_size</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">map_data</span><span class="p">[</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">][</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;R&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">robot_state</span><span class="o">.</span><span class="n">cleaned_positions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">map_data</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34;R&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">map_data</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">map_str</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">map_data</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze the robot vacuum&#39;s situation and suggest a strategy:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Map (R=Robot, C=Cleaned, ?=Unknown):
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">map_str</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Sensor Data:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Front obstacle: </span><span class="si">{</span><span class="n">sensor_data</span><span class="o">.</span><span class="n">front_obstacle</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Left obstacle: </span><span class="si">{</span><span class="n">sensor_data</span><span class="o">.</span><span class="n">left_obstacle</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Right obstacle: </span><span class="si">{</span><span class="n">sensor_data</span><span class="o">.</span><span class="n">right_obstacle</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Dirt detected: </span><span class="si">{</span><span class="n">sensor_data</span><span class="o">.</span><span class="n">dirt_detected</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Battery level: </span><span class="si">{</span><span class="n">sensor_data</span><span class="o">.</span><span class="n">battery_level</span><span class="si">}</span><span class="s2">%
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Robot State:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Position: (</span><span class="si">{</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">)
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Direction: </span><span class="si">{</span><span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Cleaned positions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">robot_state</span><span class="o">.</span><span class="n">cleaned_positions</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Suggest:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Primary objective
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Movement pattern
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Risk assessment
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Efficiency recommendations
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Parse LLM response (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;strategy&#34;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;risk_level&#34;</span><span class="p">:</span> <span class="s2">&#34;LOW&#34;</span> <span class="k">if</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">battery_level</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;recommended_pattern&#34;</span><span class="p">:</span> <span class="s2">&#34;SPIRAL&#34;</span> <span class="k">if</span> <span class="s2">&#34;spiral&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;ZIGZAG&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ReflexiveRules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Define reflexive rules for the robot vacuum&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">StrategicAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">determine_action</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">sensor_data</span><span class="p">:</span> <span class="n">SensorData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">robot_state</span><span class="p">:</span> <span class="n">RobotState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">env_size</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Get strategic analysis for complex decisions</span>
</span></span><span class="line"><span class="cl">        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_situation</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">,</span> <span class="n">robot_state</span><span class="p">,</span> <span class="n">env_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Priority 1: Handle low battery</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">battery_level</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">RETURN_HOME</span><span class="p">,</span> <span class="s2">&#34;Low battery, returning to charging station&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Priority 2: Clean dirt if detected</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">dirt_detected</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">CLEAN</span><span class="p">,</span> <span class="s2">&#34;Dirt detected, cleaning current position&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Priority 3: Navigate based on strategic analysis and obstacles</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;SPIRAL&#34;</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&#34;recommended_pattern&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">right_obstacle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">,</span> <span class="s2">&#34;Following spiral pattern&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">front_obstacle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">MOVE_FORWARD</span><span class="p">,</span> <span class="s2">&#34;Following spiral pattern&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Default obstacle avoidance</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">front_obstacle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">right_obstacle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Avoiding obstacle: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">sensor_data</span><span class="o">.</span><span class="n">left_obstacle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Avoiding obstacle: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">,</span> <span class="s2">&#34;Surrounded by obstacles, turning around&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Default: Move forward</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="n">MOVE_FORWARD</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;Following </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommended_pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pattern&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sense_and_act</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Main function for the reflexive agent - sense environment and act immediately
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Get current state</span>
</span></span><span class="line"><span class="cl">    <span class="n">robot_state</span> <span class="o">=</span> <span class="n">RobotState</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;robot_state&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">sensor_data</span> <span class="o">=</span> <span class="n">SensorData</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;sensor_data&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create rules engine and determine action</span>
</span></span><span class="line"><span class="cl">    <span class="n">rules</span> <span class="o">=</span> <span class="n">ReflexiveRules</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">action</span><span class="p">,</span> <span class="n">reasoning</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">determine_action</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">,</span> <span class="n">robot_state</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10 is env_size</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Execute action and update state</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">Action</span><span class="o">.</span><span class="n">MOVE_FORWARD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_position</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">_get_adjacent_position</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">Environment</span><span class="o">.</span><span class="n">_is_obstacle</span><span class="p">(</span><span class="n">Position</span><span class="p">(</span><span class="n">new_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">new_position</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">robot_state</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">new_position</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">Action</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">_turn_left</span><span class="p">(</span><span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">Action</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">_turn_right</span><span class="p">(</span><span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">Action</span><span class="o">.</span><span class="n">CLEAN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">robot_state</span><span class="o">.</span><span class="n">cleaned_positions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">robot_state</span><span class="o">.</span><span class="n">cleaned_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;robot_state&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">robot_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;action_taken&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reasoning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Determine if we should continue or end</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">Action</span><span class="o">.</span><span class="n">RETURN_HOME</span> <span class="ow">and</span> <span class="p">(</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;CONTINUE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AgentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add node</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;sense_and_act&#34;</span><span class="p">,</span> <span class="n">sense_and_act</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edge</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;sense_and_act&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;sense_and_act&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;sense_and_act&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;CONTINUE&#34;</span><span class="p">:</span> <span class="s2">&#34;sense_and_act&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize environment</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;robot_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;position&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;direction&#34;</span><span class="p">:</span> <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;battery_level&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;cleaned_positions&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;sensor_data&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get_sensor_data</span><span class="p">(</span><span class="n">Position</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Direction</span><span class="o">.</span><span class="n">NORTH</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;action_taken&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;CONTINUE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update sensor data for next iteration</span>
</span></span><span class="line"><span class="cl">        <span class="n">robot_state</span> <span class="o">=</span> <span class="n">RobotState</span><span class="p">(</span><span class="o">**</span><span class="n">output</span><span class="p">[</span><span class="s2">&#34;robot_state&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="p">[</span><span class="s2">&#34;sensor_data&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get_sensor_data</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Position</span><span class="p">(</span><span class="o">**</span><span class="n">robot_state</span><span class="o">.</span><span class="n">position</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">robot_state</span><span class="o">.</span><span class="n">direction</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="7-interactive-learning---การเรยนรแบบมปฏสมพนธ">7. Interactive Learning - การเรียนรู้แบบมีปฏิสัมพันธ์<a hidden class="anchor" aria-hidden="true" href="#7-interactive-learning---การเรยนรแบบมปฏสมพนธ">#</a></h3>
<p>รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบพัฒนาได้จากการมีปฏิสัมพันธ์กับผู้ใช้ โดย:</p>
<ul>
<li>รับข้อเสนอแนะจากผู้ใช้</li>
<li>วิเคราะห์และเรียนรู้จากข้อมูลป้อนกลับ</li>
<li>ปรับปรุงพฤติกรรมให้ตรงกับความต้องการ</li>
</ul>
<p>ระบบแปลภาษาที่เรียนรู้จากการแก้ไขของผู้ใช้เป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Interactive Learning</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures (dataclasses remain the same)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Translation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">original_text</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">translated_text</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">source_language</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_language</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">confidence_score</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserFeedback</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">translation_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">corrected_text</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># GRAMMAR, CONTEXT, STYLE, etc.</span>
</span></span><span class="line"><span class="cl">    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LearningPattern</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">pattern_type</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">original_phrase</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">corrected_phrase</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">frequency</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TranslatorState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_text</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">source_language</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_language</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">translation_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">learning_patterns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>  <span class="c1"># your website URL</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Translation Assistant&#34;</span>  <span class="c1"># your app name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TranslationMemory</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Manages translation patterns and corrections&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="n">LearningPattern</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">pattern</span><span class="o">.</span><span class="n">pattern_type</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">pattern</span><span class="o">.</span><span class="n">original_phrase</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">existing</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&#34;corrected_phrase&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pattern</span><span class="o">.</span><span class="n">corrected_phrase</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">existing</span><span class="p">[</span><span class="s2">&#34;frequency&#34;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">existing</span><span class="p">[</span><span class="s2">&#34;confidence&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">existing</span><span class="p">[</span><span class="s2">&#34;confidence&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_relevant_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pattern_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">relevant</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">pattern_type</span><span class="si">}</span><span class="s2">:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">original</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">relevant</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">relevant</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FeedbackAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes user feedback to extract learning patterns&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_feedback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">original</span><span class="p">:</span> <span class="n">Translation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">feedback</span><span class="p">:</span> <span class="n">UserFeedback</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LearningPattern</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze this translation pair and identify improvement patterns:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Original Text: </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">original_text</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            Initial Translation: </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">translated_text</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            Corrected Translation: </span><span class="si">{</span><span class="n">feedback</span><span class="o">.</span><span class="n">corrected_text</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            Feedback Type: </span><span class="si">{</span><span class="n">feedback</span><span class="o">.</span><span class="n">feedback_type</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            User Comment: </span><span class="si">{</span><span class="n">feedback</span><span class="o">.</span><span class="n">comment</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please identify patterns in these categories:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. GRAMMAR: Grammar rules and structures
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. CONTEXT: Context-specific word choices
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. STYLE: Writing style and natural expression
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            For each identified pattern, provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Pattern type (GRAMMAR/CONTEXT/STYLE)
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Original phrase
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Corrected phrase
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Explanation of the improvement
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract patterns (simplified version)</span>
</span></span><span class="line"><span class="cl">        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">feedback_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;GRAMMAR&#34;</span><span class="p">,</span> <span class="s2">&#34;CONTEXT&#34;</span><span class="p">,</span> <span class="s2">&#34;STYLE&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">feedback_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">pattern</span> <span class="o">=</span> <span class="n">LearningPattern</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pattern_type</span><span class="o">=</span><span class="n">feedback_type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">original_phrase</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">translated_text</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">corrected_phrase</span><span class="o">=</span><span class="n">feedback</span><span class="o">.</span><span class="n">corrected_text</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">original_text</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">patterns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">translate_with_memory</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TranslatorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TranslatorState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Translate text using learned patterns and translation memory
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory</span> <span class="o">=</span> <span class="n">TranslationMemory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Load patterns from state</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pattern_type</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">memory</span><span class="o">.</span><span class="n">add_pattern</span><span class="p">(</span><span class="n">LearningPattern</span><span class="p">(</span><span class="o">**</span><span class="n">pattern</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Get relevant patterns</span>
</span></span><span class="line"><span class="cl">    <span class="n">relevant_patterns</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pattern_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;GRAMMAR&#34;</span><span class="p">,</span> <span class="s2">&#34;CONTEXT&#34;</span><span class="p">,</span> <span class="s2">&#34;STYLE&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">relevant_patterns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">memory</span><span class="o">.</span><span class="n">get_relevant_patterns</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_text&#34;</span><span class="p">],</span> <span class="n">pattern_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create translation prompt with patterns</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Translate the following text from </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;source_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;target_language&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Text to translate: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Consider these learned patterns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">relevant_patterns</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Please provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">        1. Translation: (your translation)
</span></span></span><span class="line"><span class="cl"><span class="s2">        2. Confidence: (score between 0-1)
</span></span></span><span class="line"><span class="cl"><span class="s2">        3. Applied Patterns: (list which patterns were used)
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Format your response with clear sections.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create translation object (with improved parsing)</span>
</span></span><span class="line"><span class="cl">    <span class="n">translation</span> <span class="o">=</span> <span class="n">Translation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">original_text</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_text&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">translated_text</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Translation:&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Confidence:&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">source_language</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;source_language&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_language</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;target_language&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">confidence_score</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Confidence:&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_translation&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;translation_history&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">translation</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;AWAIT_FEEDBACK&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_feedback</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TranslatorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TranslatorState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Process user feedback and update learning patterns
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;feedback_history&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Get latest feedback</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback</span> <span class="o">=</span> <span class="n">UserFeedback</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;feedback_history&#34;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">original</span> <span class="o">=</span> <span class="n">Translation</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_translation&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze feedback</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">FeedbackAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_patterns</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_feedback</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">feedback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update learning patterns</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory</span> <span class="o">=</span> <span class="n">TranslationMemory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">new_patterns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pattern_type</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">pattern_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pattern_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">][</span><span class="n">pattern_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">memory</span><span class="o">.</span><span class="n">add_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">][</span><span class="n">pattern_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_feedback</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TranslatorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TranslatorState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Process user feedback and update learning patterns
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;feedback_history&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Get latest feedback</span>
</span></span><span class="line"><span class="cl">    <span class="n">feedback</span> <span class="o">=</span> <span class="n">UserFeedback</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;feedback_history&#34;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">original</span> <span class="o">=</span> <span class="n">Translation</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_translation&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze feedback</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">FeedbackAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_patterns</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_feedback</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">feedback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update learning patterns</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory</span> <span class="o">=</span> <span class="n">TranslationMemory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">new_patterns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pattern_type</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">pattern_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pattern_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">][</span><span class="n">pattern_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">memory</span><span class="o">.</span><span class="n">add_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;learning_patterns&#34;</span><span class="p">][</span><span class="n">pattern_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TranslatorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Route to the next step based on the current state
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">TranslatorState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;translate&#34;</span><span class="p">,</span> <span class="n">translate_with_memory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;feedback&#34;</span><span class="p">,</span> <span class="n">process_feedback</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;translate&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;feedback&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;translate&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;translate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;AWAIT_FEEDBACK&#34;</span><span class="p">:</span> <span class="s2">&#34;feedback&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;feedback&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_text&#34;</span><span class="p">:</span> <span class="s2">&#34;The cat sat on the mat.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;source_language&#34;</span><span class="p">:</span> <span class="s2">&#34;English&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;target_language&#34;</span><span class="p">:</span> <span class="s2">&#34;Thai&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;translation_history&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;feedback_history&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;translation_id&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;corrected_text&#34;</span><span class="p">:</span> <span class="s2">&#34;แมวนั่งอยู่บนเสื่อ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;feedback_type&#34;</span><span class="p">:</span> <span class="s2">&#34;STYLE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;comment&#34;</span><span class="p">:</span> <span class="s2">&#34;More natural Thai expression&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;learning_patterns&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_translation&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;TRANSLATE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="8-การแยกงานเปนลำดบชน-hierarchical-task-decomposition">8. การแยกงานเป็นลำดับชั้น (Hierarchical Task Decomposition)<a hidden class="anchor" aria-hidden="true" href="#8-การแยกงานเปนลำดบชน-hierarchical-task-decomposition">#</a></h3>
<p>รูปแบบนี้ช่วยจัดการงานที่ซับซ้อนได้อย่างมีประสิทธิภาพ โดย:</p>
<ul>
<li>แยกงานใหญ่เป็นงานย่อยที่จัดการได้ง่ายขึ้น</li>
<li>จัดลำดับความสำคัญของงานย่อย</li>
<li>ติดตามความคืบหน้าในแต่ละระดับ</li>
</ul>
<p>ผู้ช่วย AI ที่ช่วยจัดงานอีเวนต์ โดยแบ่งเป็นการจองสถานที่ ส่งการ์ดเชิญ และจัดตารางงาน เป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Hierarchical Task Decomposition</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 1 (highest) to 5 (lowest)</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># NOT_STARTED, IN_PROGRESS, COMPLETED</span>
</span></span><span class="line"><span class="cl">    <span class="n">parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">subtasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">dependencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">assigned_to</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">deadline</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 0-100%</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TaskUpdate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PlannerState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_details</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">updates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_focus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>  <span class="c1"># your website URL</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Event Planning Assistant&#34;</span>  <span class="c1"># your app name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TaskDecomposer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Handles breaking down complex tasks into subtasks&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decompose_event_planning</span><span class="p">(</span><span class="n">event_details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please decompose this event into a structured task hierarchy:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            EVENT DETAILS:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event_details</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            MAIN CATEGORIES:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Venue Management
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Guest Management
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Logistics &amp; Schedule
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Budget &amp; Contracts
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            For each task, provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Task ID (unique identifier)
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Task Name
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Description (clear and actionable)
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Priority (1-5, where 1 is highest)
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Dependencies (list of task IDs)
</span></span></span><span class="line"><span class="cl"><span class="s2">            6. Timeline and deadlines
</span></span></span><span class="line"><span class="cl"><span class="s2">            7. Team assignment
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ensure tasks are:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Well-defined and measurable
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Properly sequenced with dependencies
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Assigned appropriate priorities
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Given realistic timelines
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Format each task in a structured way.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create task hierarchy (simplified version - would parse LLM response in full implementation)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">Task</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;VENUE_MAIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Venue Management&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Overall venue selection and management&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="o">=</span><span class="s2">&#34;NOT_STARTED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">subtasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;VENUE_SEARCH&#34;</span><span class="p">,</span> <span class="s2">&#34;VENUE_BOOK&#34;</span><span class="p">,</span> <span class="s2">&#34;VENUE_SETUP&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">dependencies</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="n">assigned_to</span><span class="o">=</span><span class="s2">&#34;Venue Team&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">deadline</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">Task</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;VENUE_SEARCH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Venue Search&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Research and visit potential venues&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="o">=</span><span class="s2">&#34;NOT_STARTED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">parent_id</span><span class="o">=</span><span class="s2">&#34;VENUE_MAIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">subtasks</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="n">dependencies</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="n">assigned_to</span><span class="o">=</span><span class="s2">&#34;Venue Team&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">deadline</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Additional tasks would be parsed from LLM response</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tasks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TaskPrioritizer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Manages task priorities and dependencies&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">calculate_critical_path</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">critical_tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">remaining_tasks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">remaining_tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">remaining_tasks</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">dep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remaining_tasks</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">critical_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">remaining_tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">critical_tasks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_priorities</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">critical_path</span> <span class="o">=</span> <span class="n">TaskPrioritizer</span><span class="o">.</span><span class="n">calculate_critical_path</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Adjust priorities based on critical path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">critical_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tasks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ProgressTracker</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Tracks and updates task progress&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_task_progress</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">update</span><span class="p">:</span> <span class="n">TaskUpdate</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">tasks</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update specific task</span>
</span></span><span class="line"><span class="cl">        <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="n">update</span><span class="o">.</span><span class="n">task_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">status</span>
</span></span><span class="line"><span class="cl">        <span class="n">task</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">progress</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update parent task progress</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">parent_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">subtask_progress</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">tasks</span><span class="p">[</span><span class="n">subtask_id</span><span class="p">]</span><span class="o">.</span><span class="n">progress</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">subtask_id</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">subtasks</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subtask_progress</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtask_progress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tasks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_status_report</span><span class="p">(</span><span class="n">tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Task</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;total_tasks&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;completed&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&#34;COMPLETED&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;in_progress&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&#34;IN_PROGRESS&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;not_started&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&#34;NOT_STARTED&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;overall_progress&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">progress</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decompose_tasks</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlannerState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Initial task decomposition
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">decomposer</span> <span class="o">=</span> <span class="n">TaskDecomposer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="n">decomposer</span><span class="o">.</span><span class="n">decompose_event_planning</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;event_details&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert tasks to dictionary format</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;PRIORITIZE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">prioritize_tasks</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlannerState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Prioritize tasks and calculate critical path
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert dict back to Task objects</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">task_id</span><span class="p">:</span> <span class="n">Task</span><span class="p">(</span><span class="o">**</span><span class="n">task_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update priorities</span>
</span></span><span class="line"><span class="cl">    <span class="n">prioritizer</span> <span class="o">=</span> <span class="n">TaskPrioritizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="n">prioritizer</span><span class="o">.</span><span class="n">update_priorities</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert back to dict format</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">task_id</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;UPDATE_PROGRESS&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlannerState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Update task progress based on recent updates
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;updates&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert dict back to Task objects</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">task_id</span><span class="p">:</span> <span class="n">Task</span><span class="p">(</span><span class="o">**</span><span class="n">task_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Process each update</span>
</span></span><span class="line"><span class="cl">    <span class="n">tracker</span> <span class="o">=</span> <span class="n">ProgressTracker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">update_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;updates&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">update</span> <span class="o">=</span> <span class="n">TaskUpdate</span><span class="p">(</span><span class="o">**</span><span class="n">update_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">update_task_progress</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Get status report</span>
</span></span><span class="line"><span class="cl">    <span class="n">status_report</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_status_report</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;tasks&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">task_id</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;status_report&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status_report</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Route to the next step based on the current state
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">PlannerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;decompose&#34;</span><span class="p">,</span> <span class="n">decompose_tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;prioritize&#34;</span><span class="p">,</span> <span class="n">prioritize_tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;progress&#34;</span><span class="p">,</span> <span class="n">update_progress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;decompose&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;prioritize&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;progress&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;decompose&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;decompose&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PRIORITIZE&#34;</span><span class="p">:</span> <span class="s2">&#34;prioritize&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;prioritize&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;UPDATE_PROGRESS&#34;</span><span class="p">:</span> <span class="s2">&#34;progress&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;progress&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state with example event</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;event_details&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Tech Conference 2025&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;date&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-06-15&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;expected_attendees&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;Conference&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;location_preference&#34;</span><span class="p">:</span> <span class="s2">&#34;City Center&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;special_requirements&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;AV Equipment&#34;</span><span class="p">,</span> <span class="s2">&#34;Catering&#34;</span><span class="p">,</span> <span class="s2">&#34;Registration Desk&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;tasks&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;updates&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;task_id&#34;</span><span class="p">:</span> <span class="s2">&#34;VENUE_SEARCH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;COMPLETED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;progress&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;notes&#34;</span><span class="p">:</span> <span class="s2">&#34;Selected Convention Center A&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_focus&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;DECOMPOSE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="9-ระบบททำงานตามเปาหมาย-goal-oriented-agent">9. ระบบที่ทำงานตามเป้าหมาย (Goal-Oriented Agent)<a hidden class="anchor" aria-hidden="true" href="#9-ระบบททำงานตามเปาหมาย-goal-oriented-agent">#</a></h3>
<p>รูปแบบนี้เน้นการทำงานที่มีจุดมุ่งหมายชัดเจน โดย:</p>
<ul>
<li>กำหนดเป้าหมายที่ต้องการ</li>
<li>วางแผนการทำงานเพื่อให้บรรลุเป้าหมาย</li>
<li>ปรับเปลี่ยนกลยุทธ์ตามสถานการณ์</li>
</ul>
<p>ระบบวางแผนการเงินที่ปรับกลยุทธ์การลงทุนเพื่อให้บรรลุเป้าหมายการออมเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Goal-Oriented Agent</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FinancialGoal</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_amount</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_amount</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_date</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 1 (highest) to 5 (lowest)</span>
</span></span><span class="line"><span class="cl">    <span class="n">risk_tolerance</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># LOW, MEDIUM, HIGH</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Percentage</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Investment</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># STOCKS, BONDS, SAVINGS, etc.</span>
</span></span><span class="line"><span class="cl">    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">expected_return</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">risk_level</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">liquidity</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocation_percentage</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Strategy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">goal_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">investments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Investment</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">monthly_contribution</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">expected_timeline</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># months</span>
</span></span><span class="line"><span class="cl">    <span class="n">risk_assessment</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">contingency_plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PlannerState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">financial_goals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_portfolio</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">market_conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">analysis_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Financial Planning Assistant&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GoalAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes financial goals and current progress&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_goal_progress</span><span class="p">(</span><span class="n">goal</span><span class="p">:</span> <span class="n">FinancialGoal</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze progress towards this financial goal:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Goal Details:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Name: </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Target: $</span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">target_amount</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Current: $</span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">current_amount</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Deadline: </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">target_date</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Risk Tolerance: </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">risk_tolerance</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Strategy:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Monthly Contribution: $</span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">monthly_contribution</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Timeline: </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">expected_timeline</span><span class="si">}</span><span class="s2"> months
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Investment Mix: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span> <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="n">investments</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please analyze:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Progress status and likelihood of achievement
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Risk alignment
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Required adjustments
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Recommendations for optimization
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Parse response for analysis results</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;ON_TRACK&#34;</span> <span class="k">if</span> <span class="n">goal</span><span class="o">.</span><span class="n">progress</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">goal</span><span class="o">.</span><span class="n">current_amount</span> <span class="o">/</span> <span class="n">goal</span><span class="o">.</span><span class="n">target_amount</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&#34;NEEDS_ADJUSTMENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;analysis&#34;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;requires_strategy_update&#34;</span><span class="p">:</span> <span class="s2">&#34;adjustment&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">StrategyPlanner</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Plans and adjusts investment strategies&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_strategy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">goal</span><span class="p">:</span> <span class="n">FinancialGoal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_portfolio</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">market_conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Create an investment strategy for this financial goal:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Goal:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">goal</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Portfolio:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_portfolio</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Market Conditions:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">market_conditions</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide a comprehensive strategy including:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Asset allocation
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Monthly contribution requirements
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Risk management approach
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Timeline and milestones
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Contingency plans
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Risk tolerance level
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Time horizon
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Current market conditions
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Liquidity needs
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create strategy (simplified version - would parse LLM response in real implementation)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Strategy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">goal_id</span><span class="o">=</span><span class="n">goal</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">investments</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">Investment</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">type</span><span class="o">=</span><span class="s2">&#34;STOCKS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">amount</span><span class="o">=</span><span class="n">goal</span><span class="o">.</span><span class="n">target_amount</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">expected_return</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">risk_level</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">liquidity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">allocation_percentage</span><span class="o">=</span><span class="mi">60</span>
</span></span><span class="line"><span class="cl">                <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">Investment</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">type</span><span class="o">=</span><span class="s2">&#34;BONDS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">amount</span><span class="o">=</span><span class="n">goal</span><span class="o">.</span><span class="n">target_amount</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">expected_return</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">risk_level</span><span class="o">=</span><span class="s2">&#34;LOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">liquidity</span><span class="o">=</span><span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">allocation_percentage</span><span class="o">=</span><span class="mi">30</span>
</span></span><span class="line"><span class="cl">                <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">Investment</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">type</span><span class="o">=</span><span class="s2">&#34;SAVINGS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">amount</span><span class="o">=</span><span class="n">goal</span><span class="o">.</span><span class="n">target_amount</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">expected_return</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">risk_level</span><span class="o">=</span><span class="s2">&#34;LOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">liquidity</span><span class="o">=</span><span class="s2">&#34;HIGH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">allocation_percentage</span><span class="o">=</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">monthly_contribution</span><span class="o">=</span><span class="p">(</span><span class="n">goal</span><span class="o">.</span><span class="n">target_amount</span> <span class="o">-</span> <span class="n">goal</span><span class="o">.</span><span class="n">current_amount</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">expected_timeline</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">risk_assessment</span><span class="o">=</span><span class="s2">&#34;MODERATE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">contingency_plans</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Increase contributions if falling behind&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Adjust allocation if market conditions change&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Extended timeline option available&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">StrategyOptimizer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Optimizes and adjusts strategies based on performance&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">optimize_strategy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">goal</span><span class="p">:</span> <span class="n">FinancialGoal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">market_conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Optimize this investment strategy based on current conditions:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Strategy:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">strategy</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Goal Progress:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">goal</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Market Conditions:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">market_conditions</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please recommend:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Allocation adjustments
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Contribution modifications
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Risk management updates
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Timeline revisions
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Explain the reasoning for each recommendation.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update strategy based on recommendations</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># (Simplified - would parse LLM response in real implementation)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">goal</span><span class="o">.</span><span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># If behind schedule</span>
</span></span><span class="line"><span class="cl">            <span class="n">strategy</span><span class="o">.</span><span class="n">monthly_contribution</span> <span class="o">*=</span> <span class="mf">1.2</span>  <span class="c1"># Increase contributions by 20%</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Adjust allocations for more aggressive growth</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="n">investments</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&#34;STOCKS&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">inv</span><span class="o">.</span><span class="n">allocation_percentage</span> <span class="o">+=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">inv</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&#34;SAVINGS&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">inv</span><span class="o">.</span><span class="n">allocation_percentage</span> <span class="o">-=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">strategy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analyze_goals</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlannerState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze progress towards financial goals
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">analysis_results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">goal_id</span><span class="p">,</span> <span class="n">goal_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;financial_goals&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">goal</span> <span class="o">=</span> <span class="n">FinancialGoal</span><span class="p">(</span><span class="o">**</span><span class="n">goal_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">strategy</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;strategies&#34;</span><span class="p">][</span><span class="n">goal_id</span><span class="p">])</span> <span class="k">if</span> <span class="n">goal_id</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;strategies&#34;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">strategy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">GoalAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">analysis_results</span><span class="p">[</span><span class="n">goal_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_goal_progress</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;analysis_results&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis_results</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;PLAN&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">plan_strategies</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlannerState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Create or update investment strategies
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">planner</span> <span class="o">=</span> <span class="n">StrategyPlanner</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">StrategyOptimizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">goal_id</span><span class="p">,</span> <span class="n">goal_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;financial_goals&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">goal</span> <span class="o">=</span> <span class="n">FinancialGoal</span><span class="p">(</span><span class="o">**</span><span class="n">goal_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">goal_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;strategies&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Create new strategy</span>
</span></span><span class="line"><span class="cl">            <span class="n">strategy</span> <span class="o">=</span> <span class="n">planner</span><span class="o">.</span><span class="n">create_strategy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">goal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_portfolio&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span><span class="p">[</span><span class="s2">&#34;market_conditions&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;strategies&#34;</span><span class="p">][</span><span class="n">goal_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;analysis_results&#34;</span><span class="p">][</span><span class="n">goal_id</span><span class="p">][</span><span class="s2">&#34;requires_strategy_update&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Optimize existing strategy</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_strategy</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;strategies&#34;</span><span class="p">][</span><span class="n">goal_id</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">optimized_strategy</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_strategy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">current_strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">goal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span><span class="p">[</span><span class="s2">&#34;market_conditions&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;strategies&#34;</span><span class="p">][</span><span class="n">goal_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">optimized_strategy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlannerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">PlannerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">analyze_goals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">,</span> <span class="n">plan_strategies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;analyze&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;PLAN&#34;</span><span class="p">:</span> <span class="s2">&#34;plan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;plan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;financial_goals&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;RETIREMENT&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;RETIREMENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Retirement Fund&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;target_amount&#34;</span><span class="p">:</span> <span class="mf">2000000.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_amount&#34;</span><span class="p">:</span> <span class="mf">500000.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;target_date&#34;</span><span class="p">:</span> <span class="s2">&#34;2045-01-01&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;priority&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;risk_tolerance&#34;</span><span class="p">:</span> <span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;progress&#34;</span><span class="p">:</span> <span class="mf">25.0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_portfolio&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;STOCKS&#34;</span><span class="p">:</span> <span class="mf">300000.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;BONDS&#34;</span><span class="p">:</span> <span class="mf">150000.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SAVINGS&#34;</span><span class="p">:</span> <span class="mf">50000.0</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;market_conditions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;stocks_outlook&#34;</span><span class="p">:</span> <span class="s2">&#34;POSITIVE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;interest_rates&#34;</span><span class="p">:</span> <span class="s2">&#34;RISING&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;economic_indicators&#34;</span><span class="p">:</span> <span class="s2">&#34;STABLE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;market_volatility&#34;</span><span class="p">:</span> <span class="s2">&#34;MODERATE&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;strategies&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;analysis_results&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;ANALYZE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="10-ระบบจดจำบรบท-contextual-memory">10. ระบบจดจำบริบท (Contextual Memory)<a hidden class="anchor" aria-hidden="true" href="#10-ระบบจดจำบรบท-contextual-memory">#</a></h3>
<p>รูปแบบนี้ช่วยให้ระบบสามารถจดจำและใช้ประโยชน์จากข้อมูลในอดีต โดย:</p>
<ul>
<li>เก็บข้อมูลการโต้ตอบกับผู้ใช้</li>
<li>วิเคราะห์รูปแบบการใช้งาน</li>
<li>ปรับการทำงานให้เหมาะกับแต่ละผู้ใช้</li>
</ul>
<p>ระบบแชทบอทที่จำความชอบของผู้ใช้และปรับการสนทนาให้เหมาะสมเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Contextual Memory</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UserPreference</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">sentiment</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># -1 to 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">frequency</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_discussed</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConversationStyle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">formality_level</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># CASUAL, FORMAL, PROFESSIONAL</span>
</span></span><span class="line"><span class="cl">    <span class="n">preferred_language</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">communication_pace</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># BRIEF, DETAILED</span>
</span></span><span class="line"><span class="cl">    <span class="n">interests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">special_notes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Interaction</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_message</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">bot_response</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">sentiment</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_feedback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ChatbotState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_input</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_preferences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">conversation_style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">interaction_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">context_analysis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Contextual Chatbot&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PreferenceAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes and maintains user preferences&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_preferences</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_prefs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UserPreference</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">interaction</span><span class="p">:</span> <span class="n">Interaction</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UserPreference</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze this interaction and update user preferences:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            User Message: </span><span class="si">{</span><span class="n">interaction</span><span class="o">.</span><span class="n">user_message</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            Bot Response: </span><span class="si">{</span><span class="n">interaction</span><span class="o">.</span><span class="n">bot_response</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Topics: </span><span class="si">{</span><span class="n">interaction</span><span class="o">.</span><span class="n">topics</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Preferences:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">current_prefs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please identify:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. New topics/interests
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Sentiment towards topics
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Key preferences or dislikes
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Patterns in communication style
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update preferences based on analysis</span>
</span></span><span class="line"><span class="cl">        <span class="n">updated_prefs</span> <span class="o">=</span> <span class="n">current_prefs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Add new topics or update existing ones</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">interaction</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">topic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">updated_prefs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">updated_prefs</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span> <span class="o">=</span> <span class="n">UserPreference</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sentiment</span><span class="o">=</span><span class="n">interaction</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">last_discussed</span><span class="o">=</span><span class="n">interaction</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">keywords</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pref</span> <span class="o">=</span> <span class="n">updated_prefs</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">pref</span><span class="o">.</span><span class="n">frequency</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">pref</span><span class="o">.</span><span class="n">last_discussed</span> <span class="o">=</span> <span class="n">interaction</span><span class="o">.</span><span class="n">timestamp</span>
</span></span><span class="line"><span class="cl">                <span class="n">pref</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">=</span> <span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">sentiment</span> <span class="o">*</span> <span class="p">(</span><span class="n">pref</span><span class="o">.</span><span class="n">frequency</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">interaction</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)</span> <span class="o">/</span> <span class="n">pref</span><span class="o">.</span><span class="n">frequency</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">updated_prefs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConversationAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes conversation patterns and style&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_style</span><span class="p">(</span><span class="n">interactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Interaction</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ConversationStyle</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze these interactions to determine conversation style:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Recent Interactions:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Please determine:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Preferred formality level
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Communication style (brief/detailed)
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Key interests and themes
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Special considerations
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create conversation style (simplified - would parse LLM response in real implementation)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ConversationStyle</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">formality_level</span><span class="o">=</span><span class="s2">&#34;CASUAL&#34;</span> <span class="k">if</span> <span class="s2">&#34;casual&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;FORMAL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">preferred_language</span><span class="o">=</span><span class="s2">&#34;English&#34;</span><span class="p">,</span>  <span class="c1"># Would be detected from interactions</span>
</span></span><span class="line"><span class="cl">            <span class="n">communication_pace</span><span class="o">=</span><span class="s2">&#34;BRIEF&#34;</span> <span class="k">if</span> <span class="s2">&#34;brief&#34;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&#34;DETAILED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">interests</span><span class="o">=</span><span class="p">[</span><span class="n">topic</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">interactions</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">topics</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">special_notes</span><span class="o">=</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ContextManager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Manages contextual memory and retrieval&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Interaction</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">long_term_memory</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Interaction</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interaction</span><span class="p">:</span> <span class="n">Interaction</span><span class="p">,</span> <span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Add to short-term memory</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Keep last 10 interactions</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Add to long-term memory by topic</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">long_term_memory</span><span class="p">[</span><span class="n">topic</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_relevant_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_preferences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UserPreference</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Interaction</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Find relevant context for this input:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Input: </span><span class="si">{</span><span class="n">current_input</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            User Preferences: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">user_preferences</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Return relevant topics and importance scores.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Get relevant interactions (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">relevant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>  <span class="c1"># Last 3 interactions</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">user_preferences</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">current_input</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">relevant</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_term_memory</span><span class="p">[</span><span class="n">topic</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>  <span class="c1"># Last 2 topic-specific interactions</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">relevant</span><span class="p">))</span>  <span class="c1"># Remove duplicates</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResponseGenerator</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Generates contextually aware responses&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">relevant_context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Interaction</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">conversation_style</span><span class="p">:</span> <span class="n">ConversationStyle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_preferences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">UserPreference</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">context_str</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="sa">f</span><span class="s2">&#34;Previous interaction: </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">user_message</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">bot_response</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">relevant_context</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>  <span class="c1"># Last 3 relevant interactions</span>
</span></span><span class="line"><span class="cl">        <span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Generate a response considering this context:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Input: </span><span class="si">{</span><span class="n">current_input</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Previous Context:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">context_str</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Conversation Style:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">conversation_style</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            User Preferences:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">user_preferences</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Generate a response that:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Matches the user&#39;s preferred style
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. References relevant past interactions
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Shows awareness of user preferences
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Maintains conversation continuity
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analyze_context</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze context and user preferences
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;interaction_history&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Convert recent interactions to objects</span>
</span></span><span class="line"><span class="cl">        <span class="n">recent_interactions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">Interaction</span><span class="p">(</span><span class="o">**</span><span class="n">interaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">interaction</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;interaction_history&#34;</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Analyze conversation style</span>
</span></span><span class="line"><span class="cl">        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">ConversationAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">conversation_style</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_style</span><span class="p">(</span><span class="n">recent_interactions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;conversation_style&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">conversation_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Get relevant context</span>
</span></span><span class="line"><span class="cl">        <span class="n">context_manager</span> <span class="o">=</span> <span class="n">ContextManager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">interaction</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;interaction_history&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">context_manager</span><span class="o">.</span><span class="n">add_interaction</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interaction</span><span class="p">(</span><span class="o">**</span><span class="n">interaction</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">interaction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;topics&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">current_prefs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span><span class="p">:</span> <span class="n">UserPreference</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;user_preferences&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">relevant_context</span> <span class="o">=</span> <span class="n">context_manager</span><span class="o">.</span><span class="n">get_relevant_context</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_input&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_prefs</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;context_analysis&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;relevant_interactions&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">relevant_context</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;conversation_style&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">conversation_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;RESPOND&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_response</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatbotState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Generate contextually aware response
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">conversation_style</span> <span class="o">=</span> <span class="n">ConversationStyle</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;conversation_style&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_preferences</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">UserPreference</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;user_preferences&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">relevant_context</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Interaction</span><span class="p">(</span><span class="o">**</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;context_analysis&#34;</span><span class="p">][</span><span class="s2">&#34;relevant_interactions&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Generate response</span>
</span></span><span class="line"><span class="cl">    <span class="n">generator</span> <span class="o">=</span> <span class="n">ResponseGenerator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_response</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_input&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">relevant_context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">conversation_style</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_preferences</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create new interaction</span>
</span></span><span class="line"><span class="cl">    <span class="n">interaction</span> <span class="o">=</span> <span class="n">Interaction</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_message</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_input&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">bot_response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">topics</span><span class="o">=</span><span class="p">[],</span>  <span class="c1"># Would be extracted from response</span>
</span></span><span class="line"><span class="cl">        <span class="n">sentiment</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># Would be analyzed</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_feedback</span><span class="o">=</span><span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;messages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;interaction_history&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">interaction</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatbotState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ChatbotState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">analyze_context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;respond&#34;</span><span class="p">,</span> <span class="n">generate_response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;respond&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;analyze&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;RESPOND&#34;</span><span class="p">:</span> <span class="s2">&#34;respond&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;respond&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_input&#34;</span><span class="p">:</span> <span class="s2">&#34;What restaurants do you recommend?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;user123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user_preferences&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;cuisine&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;cuisine&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;sentiment&#34;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;frequency&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;last_discussed&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-02-05T10:00:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Thai&#34;</span><span class="p">,</span> <span class="s2">&#34;Italian&#34;</span><span class="p">,</span> <span class="s2">&#34;vegetarian&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;conversation_style&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;formality_level&#34;</span><span class="p">:</span> <span class="s2">&#34;CASUAL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;preferred_language&#34;</span><span class="p">:</span> <span class="s2">&#34;English&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;communication_pace&#34;</span><span class="p">:</span> <span class="s2">&#34;DETAILED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;interests&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;food&#34;</span><span class="p">,</span> <span class="s2">&#34;travel&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;special_notes&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Prefers detailed explanations&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;interaction_history&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-02-05T09:00:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;user_message&#34;</span><span class="p">:</span> <span class="s2">&#34;I love Thai food&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;bot_response&#34;</span><span class="p">:</span> <span class="s2">&#34;Thai cuisine is amazing! Do you have a favorite dish?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;topics&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;cuisine&#34;</span><span class="p">,</span> <span class="s2">&#34;Thai&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;sentiment&#34;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;user_feedback&#34;</span><span class="p">:</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;context_analysis&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;ANALYZE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="11-ระบบหลายตวแทนททำงานรวมกน-collaborative-multi-agent-systems">11. ระบบหลายตัวแทนที่ทำงานร่วมกัน (Collaborative Multi-Agent Systems)<a hidden class="anchor" aria-hidden="true" href="#11-ระบบหลายตวแทนททำงานรวมกน-collaborative-multi-agent-systems">#</a></h3>
<p>รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบย่อยหลายๆ ระบบทำงานร่วมกันได้อย่างมีประสิทธิภาพ โดย:</p>
<ul>
<li>แบ่งงานตามความเชี่ยวชาญ</li>
<li>ประสานงานระหว่างระบบย่อย</li>
<li>แก้ไขความขัดแย้งที่อาจเกิดขึ้น</li>
</ul>
<p>โดรนขนส่งที่ทำงานประสานกันเพื่อส่งพัสดุในเมืองเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Collaborative Multi-Agent Systems</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DroneStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">IDLE</span> <span class="o">=</span> <span class="s2">&#34;IDLE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOADING</span> <span class="o">=</span> <span class="s2">&#34;LOADING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DELIVERING</span> <span class="o">=</span> <span class="s2">&#34;DELIVERING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">RETURNING</span> <span class="o">=</span> <span class="s2">&#34;RETURNING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHARGING</span> <span class="o">=</span> <span class="s2">&#34;CHARGING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MAINTENANCE</span> <span class="o">=</span> <span class="s2">&#34;MAINTENANCE&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Location</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_charging_station</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_depot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Package</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">pickup_location</span><span class="p">:</span> <span class="n">Location</span>
</span></span><span class="line"><span class="cl">    <span class="n">delivery_location</span><span class="p">:</span> <span class="n">Location</span>
</span></span><span class="line"><span class="cl">    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 1 (highest) to 5 (lowest)</span>
</span></span><span class="line"><span class="cl">    <span class="n">deadline</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># PENDING, ASSIGNED, IN_TRANSIT, DELIVERED</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Drone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_location</span><span class="p">:</span> <span class="n">Location</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="n">DroneStatus</span>
</span></span><span class="line"><span class="cl">    <span class="n">battery_level</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_payload</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_package</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">assigned_zone</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>  <span class="c1"># [x_min, y_min, x_max, y_max]</span>
</span></span><span class="line"><span class="cl">    <span class="n">delivery_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DeliveryPlan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">drone_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">package_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_battery_usage</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_completion_time</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority_score</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">drones</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">packages</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">delivery_plans</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">conflict_resolutions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Drone Fleet Manager&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RouteOptimizer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Optimizes delivery routes for each drone&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">calculate_distance</span><span class="p">(</span><span class="n">loc1</span><span class="p">:</span> <span class="n">Location</span><span class="p">,</span> <span class="n">loc2</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">((</span><span class="n">loc1</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">loc2</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">loc1</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">loc2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">estimate_battery_usage</span><span class="p">(</span><span class="n">route</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Location</span><span class="p">],</span> <span class="n">package_weight</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_distance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">RouteOptimizer</span><span class="o">.</span><span class="n">calculate_distance</span><span class="p">(</span><span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">route</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple battery usage model: distance + weight factor</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">total_distance</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">package_weight</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">optimize_route</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">drone</span><span class="p">:</span> <span class="n">Drone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">packages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Package</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">charging_stations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeliveryPlan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Optimize delivery route for drone considering:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Drone Status:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">drone</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Available Packages:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Charging Stations:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">charging_stations</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Battery efficiency
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Package priorities
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Deadlines
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Drone zone restrictions
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Charging station locations
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Optimized package sequence
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Complete route with charging stops
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Estimated battery usage
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Expected completion time
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create delivery plan (simplified - would parse LLM response in real implementation)</span>
</span></span><span class="line"><span class="cl">        <span class="n">route</span> <span class="o">=</span> <span class="p">[</span><span class="n">drone</span><span class="o">.</span><span class="n">current_location</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">packages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">route</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="n">packages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pickup_location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">packages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">delivery_location</span>
</span></span><span class="line"><span class="cl">            <span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">battery_level</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">route</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">charging_stations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">RouteOptimizer</span><span class="o">.</span><span class="n">calculate_distance</span><span class="p">(</span><span class="n">route</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DeliveryPlan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">drone_id</span><span class="o">=</span><span class="n">drone</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">package_ids</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">route</span><span class="o">=</span><span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">estimated_battery_usage</span><span class="o">=</span><span class="n">RouteOptimizer</span><span class="o">.</span><span class="n">estimate_battery_usage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">estimated_completion_time</span><span class="o">=</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">route</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">priority_score</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">p</span><span class="o">.</span><span class="n">priority</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConflictResolver</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Resolves conflicts between drone delivery plans&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">detect_conflicts</span><span class="p">(</span><span class="n">plans</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DeliveryPlan</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze these delivery plans for potential conflicts:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Delivery Plans:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Check for:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Path intersections
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Resource conflicts (charging stations)
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Timing conflicts
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Zone violations
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Identify specific conflicts and suggest resolutions.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Process conflicts (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conflicts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">plan1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plans</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">plan2</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Check for path intersections</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">loc1</span> <span class="ow">in</span> <span class="n">plan1</span><span class="o">.</span><span class="n">route</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">loc2</span> <span class="ow">in</span> <span class="n">plan2</span><span class="o">.</span><span class="n">route</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">loc1</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">loc2</span><span class="o">.</span><span class="n">x</span> <span class="ow">and</span> <span class="n">loc1</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">loc2</span><span class="o">.</span><span class="n">y</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">                            <span class="n">loc1</span><span class="o">.</span><span class="n">is_charging_station</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;CHARGING_STATION_CONFLICT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;drones&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">plan1</span><span class="o">.</span><span class="n">drone_id</span><span class="p">,</span> <span class="n">plan2</span><span class="o">.</span><span class="n">drone_id</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">loc1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                <span class="s2">&#34;resolution&#34;</span><span class="p">:</span> <span class="s2">&#34;RESEQUENCE&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conflicts</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">resolve_conflicts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">conflicts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">plans</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DeliveryPlan</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DeliveryPlan</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Resolve these delivery plan conflicts:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Conflicts:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">conflicts</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Plans:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">plans</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Modified routes
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Updated timing
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Rationale for changes
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Resolve conflicts (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">updated_plans</span> <span class="o">=</span> <span class="n">plans</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">conflict</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conflict</span><span class="p">[</span><span class="s2">&#34;type&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;CHARGING_STATION_CONFLICT&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Add delay to second drone&#39;s plan</span>
</span></span><span class="line"><span class="cl">                <span class="n">drone_id</span> <span class="o">=</span> <span class="n">conflict</span><span class="p">[</span><span class="s2">&#34;drones&#34;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">plan</span> <span class="o">=</span> <span class="n">updated_plans</span><span class="p">[</span><span class="n">drone_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">plan</span><span class="o">.</span><span class="n">estimated_completion_time</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">estimated_completion_time</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">updated_plans</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FleetCoordinator</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Coordinates overall fleet operations&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">assign_packages</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">drones</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Drone</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">packages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Package</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">charging_stations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DeliveryPlan</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Assign packages to drones optimally:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Available Drones:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">drones</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Pending Packages:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Drone locations and zones
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Package priorities and deadlines
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Battery levels
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Load balancing
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide assignment plan with rationale.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create delivery plans (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">RouteOptimizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">plans</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">drone</span> <span class="ow">in</span> <span class="n">drones</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">drone</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DroneStatus</span><span class="o">.</span><span class="n">IDLE</span><span class="p">,</span> <span class="n">DroneStatus</span><span class="o">.</span><span class="n">RETURNING</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Find packages in drone&#39;s zone</span>
</span></span><span class="line"><span class="cl">                <span class="n">zone_packages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packages</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">drone</span><span class="o">.</span><span class="n">assigned_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">delivery_location</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">drone</span><span class="o">.</span><span class="n">assigned_zone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">                        <span class="n">drone</span><span class="o">.</span><span class="n">assigned_zone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">delivery_location</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">drone</span><span class="o">.</span><span class="n">assigned_zone</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">zone_packages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">plans</span><span class="p">[</span><span class="n">drone</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_route</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">drone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">sorted</span><span class="p">(</span><span class="n">zone_packages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">priority</span><span class="p">)[:</span><span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="n">charging_stations</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plans</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">plan_deliveries</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SystemState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SystemState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Plan and optimize delivery routes
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">drones</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Drone</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;drones&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Package</span><span class="p">(</span><span class="o">**</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;packages&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;PENDING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">charging_stations</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Location</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Station 1&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">Location</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&#34;Station 2&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create delivery plans</span>
</span></span><span class="line"><span class="cl">    <span class="n">coordinator</span> <span class="o">=</span> <span class="n">FleetCoordinator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">plans</span> <span class="o">=</span> <span class="n">coordinator</span><span class="o">.</span><span class="n">assign_packages</span><span class="p">(</span><span class="n">drones</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">charging_stations</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert to dict format</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;delivery_plans&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">plans</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;RESOLVE_CONFLICTS&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">resolve_conflicts</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SystemState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SystemState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Detect and resolve conflicts between delivery plans
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;delivery_plans&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert plans to objects</span>
</span></span><span class="line"><span class="cl">    <span class="n">plans</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">DeliveryPlan</span><span class="p">(</span><span class="o">**</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;delivery_plans&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Detect and resolve conflicts</span>
</span></span><span class="line"><span class="cl">    <span class="n">resolver</span> <span class="o">=</span> <span class="n">ConflictResolver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">conflicts</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">detect_conflicts</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">plans</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">updated_plans</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve_conflicts</span><span class="p">(</span><span class="n">conflicts</span><span class="p">,</span> <span class="n">plans</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;delivery_plans&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">updated_plans</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;conflict_resolutions&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conflicts</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SystemState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SystemState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">,</span> <span class="n">plan_deliveries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;resolve&#34;</span><span class="p">,</span> <span class="n">resolve_conflicts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;resolve&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;plan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;plan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;RESOLVE_CONFLICTS&#34;</span><span class="p">:</span> <span class="s2">&#34;resolve&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;resolve&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;drones&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;drone1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;drone1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Depot&#34;</span><span class="p">,</span> <span class="n">is_depot</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;IDLE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;battery_level&#34;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;max_payload&#34;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_package&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;assigned_zone&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;delivery_history&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;drone2&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;drone2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;Depot 2&#34;</span><span class="p">,</span> <span class="n">is_depot</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;IDLE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;battery_level&#34;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;max_payload&#34;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_package&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;assigned_zone&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;delivery_history&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;packages&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;pkg1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;pkg1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;pickup_location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;Warehouse A&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;delivery_location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;Customer 1&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;priority&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;deadline&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;PENDING&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;pkg2&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;pkg2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;pickup_location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&#34;Warehouse B&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;delivery_location&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">Location</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;Customer 2&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;weight&#34;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;priority&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;deadline&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;PENDING&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;delivery_plans&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;conflict_resolutions&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;PLAN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="12-ระบบสำรวจ-exploratory-agent">12. ระบบสำรวจ (Exploratory Agent)<a hidden class="anchor" aria-hidden="true" href="#12-ระบบสำรวจ-exploratory-agent">#</a></h3>
<p>รูปแบบนี้เหมาะกับการค้นหาข้อมูลและโอกาสใหม่ๆ โดย:</p>
<ul>
<li>สำรวจสภาพแวดล้อมหรือข้อมูลที่ไม่คุ้นเคย</li>
<li>วิเคราะห์และจัดเก็บข้อมูลที่พบ</li>
<li>ระบุรูปแบบหรือโอกาสที่น่าสนใจ</li>
</ul>
<p>ผู้ช่วยวิจัยที่สแกนวารสารวิชาการเพื่อค้นหาแนวโน้มใหม่ๆ เป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Exploratory Agent</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResearchPaper</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">authors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">abstract</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">publication_date</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">journal</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">citations</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">research_areas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResearchTrend</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">emerging_keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_papers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">growth_rate</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Trend growth rate</span>
</span></span><span class="line"><span class="cl">    <span class="n">relevance_score</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_observed</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_updated</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Insight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">trend_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">supporting_evidence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">potential_impact</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">confidence_score</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResearchState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">papers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">identified_trends</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">insights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">research_focus</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">analysis_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Research Assistant&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TrendAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes research papers to identify trends&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">identify_trends</span><span class="p">(</span><span class="n">papers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResearchPaper</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ResearchTrend</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Group papers by research areas</span>
</span></span><span class="line"><span class="cl">        <span class="n">area_papers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">paper</span> <span class="ow">in</span> <span class="n">papers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">paper</span><span class="o">.</span><span class="n">research_areas</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">area_papers</span><span class="p">[</span><span class="n">area</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paper</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze these research papers and identify emerging trends:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Papers by Research Area:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">area</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">papers</span><span class="p">]</span> <span class="k">for</span> <span class="n">area</span><span class="p">,</span> <span class="n">papers</span> <span class="ow">in</span> <span class="n">area_papers</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            For each trend, identify:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Core topic and theme
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Key emerging keywords
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Most influential papers
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Growth trajectory
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Potential impact
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Focus on:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Novel research directions
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Emerging methodologies
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Cross-disciplinary connections
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Technology applications
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Process trends (simplified - would parse LLM response in real implementation)</span>
</span></span><span class="line"><span class="cl">        <span class="n">trends</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">area</span><span class="p">,</span> <span class="n">area_paper_list</span> <span class="ow">in</span> <span class="n">area_papers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">area_paper_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Minimum papers to identify trend</span>
</span></span><span class="line"><span class="cl">                <span class="n">recent_papers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">area_paper_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">publication_date</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">trend</span> <span class="o">=</span> <span class="n">ResearchTrend</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">topic</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">emerging_keywords</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">kw</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">recent_papers</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keywords</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">key_papers</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">recent_papers</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">growth_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Would calculate from citation patterns</span>
</span></span><span class="line"><span class="cl">                    <span class="n">relevance_score</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>  <span class="c1"># Would calculate based on analysis</span>
</span></span><span class="line"><span class="cl">                    <span class="n">first_observed</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">publication_date</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">area_paper_list</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">last_updated</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">publication_date</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">area_paper_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">trends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">trends</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InsightGenerator</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Generates insights from identified trends&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">generate_insights</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">trends</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResearchTrend</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">papers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResearchPaper</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Insight</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Generate research insights based on these trends:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Research Trends:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trends</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Supporting Papers:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">papers</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            For each insight:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Describe the key finding
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Provide supporting evidence
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Assess potential impact
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Estimate confidence level
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Cross-trend patterns
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Unexpected connections
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Research gaps
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Future implications
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Generate insights (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">insights</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">trend</span> <span class="ow">in</span> <span class="n">trends</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">insight</span> <span class="o">=</span> <span class="n">Insight</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">trend_id</span><span class="o">=</span><span class="n">trend</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;Emerging trend in </span><span class="si">{</span><span class="n">trend</span><span class="o">.</span><span class="n">topic</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">supporting_evidence</span><span class="o">=</span><span class="n">trend</span><span class="o">.</span><span class="n">key_papers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">potential_impact</span><span class="o">=</span><span class="s2">&#34;HIGH&#34;</span> <span class="k">if</span> <span class="n">trend</span><span class="o">.</span><span class="n">growth_rate</span> <span class="o">&gt;</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="s2">&#34;MEDIUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">confidence_score</span><span class="o">=</span><span class="n">trend</span><span class="o">.</span><span class="n">relevance_score</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">insights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insight</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">insights</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PatternMatcher</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Identifies patterns and connections across research areas&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_patterns</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">trends</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResearchTrend</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">insights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Insight</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Identify patterns and connections across research trends:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Trends:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trends</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Insights:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">insights</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Look for:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Common themes across areas
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Complementary research directions
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Technology convergence
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Methodology patterns
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Highlight:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Strong connections
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Research opportunities
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Potential collaborations
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Analyze patterns (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;theme_clusters&#34;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;methodology_patterns&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;research_opportunities&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Group related trends</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">trend</span> <span class="ow">in</span> <span class="n">trends</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">trend</span><span class="o">.</span><span class="n">emerging_keywords</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">patterns</span><span class="p">[</span><span class="s2">&#34;theme_clusters&#34;</span><span class="p">][</span><span class="n">keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trend</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">patterns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analyze_trends</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResearchState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Identify and analyze research trends
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert papers to objects</span>
</span></span><span class="line"><span class="cl">    <span class="n">papers</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResearchPaper</span><span class="p">(</span><span class="o">**</span><span class="n">paper_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">paper_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;papers&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Identify trends</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">TrendAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">trends</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">identify_trends</span><span class="p">(</span><span class="n">papers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Store trends</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;identified_trends&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">trend</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">trend</span> <span class="ow">in</span> <span class="n">trends</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;GENERATE_INSIGHTS&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_insights</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResearchState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Generate insights from identified trends
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">trends</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResearchTrend</span><span class="p">(</span><span class="o">**</span><span class="n">trend_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">trend_data</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;identified_trends&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">papers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">ResearchPaper</span><span class="p">(</span><span class="o">**</span><span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;papers&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Generate insights</span>
</span></span><span class="line"><span class="cl">    <span class="n">generator</span> <span class="o">=</span> <span class="n">InsightGenerator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">insights</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_insights</span><span class="p">(</span><span class="n">trends</span><span class="p">,</span> <span class="n">papers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Find patterns</span>
</span></span><span class="line"><span class="cl">    <span class="n">matcher</span> <span class="o">=</span> <span class="n">PatternMatcher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">patterns</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">find_patterns</span><span class="p">(</span><span class="n">trends</span><span class="p">,</span> <span class="n">insights</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;insights&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">insight</span><span class="p">)</span> <span class="k">for</span> <span class="n">insight</span> <span class="ow">in</span> <span class="n">insights</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;analysis_results&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patterns</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ResearchState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">analyze_trends</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;insights&#34;</span><span class="p">,</span> <span class="n">generate_insights</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;insights&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;analyze&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;GENERATE_INSIGHTS&#34;</span><span class="p">:</span> <span class="s2">&#34;insights&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;insights&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state with example papers</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;papers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;paper1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;Deep Learning in Medical Imaging&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;authors&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Smith, J.&#34;</span><span class="p">,</span> <span class="s2">&#34;Jones, K.&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;abstract&#34;</span><span class="p">:</span> <span class="s2">&#34;This paper explores applications of deep learning...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;deep learning&#34;</span><span class="p">,</span> <span class="s2">&#34;medical imaging&#34;</span><span class="p">,</span> <span class="s2">&#34;AI&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;publication_date&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-01-15&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;journal&#34;</span><span class="p">:</span> <span class="s2">&#34;AI in Medicine&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;citations&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;research_areas&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;AI&#34;</span><span class="p">,</span> <span class="s2">&#34;Healthcare&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;paper2&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;Advances in Quantum Computing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;authors&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Brown, R.&#34;</span><span class="p">,</span> <span class="s2">&#34;Lee, M.&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;abstract&#34;</span><span class="p">:</span> <span class="s2">&#34;Recent developments in quantum computing...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;quantum computing&#34;</span><span class="p">,</span> <span class="s2">&#34;qubits&#34;</span><span class="p">,</span> <span class="s2">&#34;algorithms&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;publication_date&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-01-20&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;journal&#34;</span><span class="p">:</span> <span class="s2">&#34;Quantum Computing Review&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;citations&#34;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;research_areas&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Quantum Computing&#34;</span><span class="p">,</span> <span class="s2">&#34;Computer Science&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;identified_trends&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;insights&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;research_focus&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;AI&#34;</span><span class="p">,</span> <span class="s2">&#34;Quantum Computing&#34;</span><span class="p">,</span> <span class="s2">&#34;Healthcare&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;analysis_results&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;ANALYZE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="13-ระบบจดการขนตอนการทำงานแบบปรบตวได-adaptive-workflow-orchestration">13. ระบบจัดการขั้นตอนการทำงานแบบปรับตัวได้ (Adaptive Workflow Orchestration)<a hidden class="anchor" aria-hidden="true" href="#13-ระบบจดการขนตอนการทำงานแบบปรบตวได-adaptive-workflow-orchestration">#</a></h3>
<p>รูปแบบนี้ช่วยให้ระบบปรับเปลี่ยนการทำงานตามสถานการณ์ได้อย่างยืดหยุ่น โดย:</p>
<ul>
<li>ติดตามการเปลี่ยนแปลงของสภาพแวดล้อม</li>
<li>ปรับลำดับความสำคัญของงาน</li>
<li>จัดสรรทรัพยากรใหม่ตามความจำเป็น</li>
</ul>
<p>ระบบบริหารจัดการโรงพยาบาลที่ปรับการจัดสรรทรัพยากรตามจำนวนผู้ป่วยที่เข้ามาเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Adaptive Workflow Orchestration</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResourceType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">DOCTOR</span> <span class="o">=</span> <span class="s2">&#34;DOCTOR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">NURSE</span> <span class="o">=</span> <span class="s2">&#34;NURSE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BED</span> <span class="o">=</span> <span class="s2">&#34;BED&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EQUIPMENT</span> <span class="o">=</span> <span class="s2">&#34;EQUIPMENT&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ICU</span> <span class="o">=</span> <span class="s2">&#34;ICU&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">EMERGENCY</span> <span class="o">=</span> <span class="s2">&#34;EMERGENCY&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PatientPriority</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&#34;CRITICAL&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HIGH</span> <span class="o">=</span> <span class="s2">&#34;HIGH&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="s2">&#34;MEDIUM&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOW</span> <span class="o">=</span> <span class="s2">&#34;LOW&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Resource</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="nb">type</span><span class="p">:</span> <span class="n">ResourceType</span>
</span></span><span class="line"><span class="cl">    <span class="n">department</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># AVAILABLE, BUSY, MAINTENANCE</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_assignment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">capacity</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 for utilization</span>
</span></span><span class="line"><span class="cl">    <span class="n">skills</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Department</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_load</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1 for utilization</span>
</span></span><span class="line"><span class="cl">    <span class="n">patient_count</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ResourceType</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait_time</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># minutes</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># NORMAL, HIGH_LOAD, CRITICAL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Patient</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="n">PatientPriority</span>
</span></span><span class="line"><span class="cl">    <span class="n">department</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">required_resources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ResourceType</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">arrival_time</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># WAITING, IN_TREATMENT, DISCHARGED</span>
</span></span><span class="line"><span class="cl">    <span class="n">estimated_duration</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># minutes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResourceAllocation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">resource_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">department</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="n">PatientPriority</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HospitalState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">departments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">patients</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Hospital Resource Manager&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LoadAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes department loads and resource utilization&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_department_loads</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">departments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Department</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">patients</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Patient</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze hospital department loads:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Departments:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">departments</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Current Patients:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">patients</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Current patient count vs capacity
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Patient priorities and types
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Wait times
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Resource utilization
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide load analysis and recommendations.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate loads (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loads</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dept_name</span><span class="p">,</span> <span class="n">dept</span> <span class="ow">in</span> <span class="n">departments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">dept_patients</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">department</span> <span class="o">==</span> <span class="n">dept_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">critical_patients</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">department</span> <span class="o">==</span> <span class="n">dept_name</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="n">PatientPriority</span><span class="o">.</span><span class="n">CRITICAL</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Calculate load score (0-1)</span>
</span></span><span class="line"><span class="cl">            <span class="n">base_load</span> <span class="o">=</span> <span class="n">dept_patients</span> <span class="o">/</span> <span class="mi">20</span>  <span class="c1"># Assuming 20 patients is max capacity</span>
</span></span><span class="line"><span class="cl">            <span class="n">critical_factor</span> <span class="o">=</span> <span class="n">critical_patients</span> <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># Extra 10% load per critical patient</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait_time_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dept</span><span class="o">.</span><span class="n">wait_time</span> <span class="o">/</span> <span class="mi">120</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Max 50% impact from wait time</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">loads</span><span class="p">[</span><span class="n">dept_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">base_load</span> <span class="o">+</span> <span class="n">critical_factor</span> <span class="o">+</span> <span class="n">wait_time_factor</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">loads</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResourceOptimizer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Optimizes resource allocation based on loads and priorities&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">optimize_resources</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">departments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Department</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Resource</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">patients</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Patient</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_loads</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ResourceAllocation</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Optimize resource allocation based on current situation:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Department Loads:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_loads</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Available Resources:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Waiting Patients:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">patients</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&#34;WAITING&#34;</span><span class="p">},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Patient priorities
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Department loads
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Resource capabilities
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Wait times
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Resource utilization balance
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide optimal resource allocation plan.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create allocations (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">allocations</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">waiting_patients</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&#34;WAITING&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">available_resources</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&#34;AVAILABLE&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Prioritize patients by severity and wait time</span>
</span></span><span class="line"><span class="cl">        <span class="n">sorted_patients</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">waiting_patients</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">PatientPriority</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">priority</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">arrival_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">sorted_patients</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Find available required resources</span>
</span></span><span class="line"><span class="cl">            <span class="n">needed_resources</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">required_resources</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">matching_resources</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">available_resources</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">resource_type</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">department</span> <span class="o">==</span> <span class="n">patient</span><span class="o">.</span><span class="n">department</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">matching_resources</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">needed_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matching_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">del</span> <span class="n">available_resources</span><span class="p">[</span><span class="n">matching_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">needed_resources</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">required_resources</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">allocation</span> <span class="o">=</span> <span class="n">ResourceAllocation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">patient_id</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">resource_ids</span><span class="o">=</span><span class="n">needed_resources</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">department</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">department</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">start_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">duration</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">estimated_duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">priority</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">priority</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allocation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">allocations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">WorkflowAdjuster</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Adjusts workflows based on current situation&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">adjust_workflows</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">departments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Department</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">loads</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">resources</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Resource</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Recommend workflow adjustments based on current situation:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Department Status:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">departments</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Department Loads:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">loads</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Available Resources:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Load balancing opportunities
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Resource reallocation needs
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Process optimization
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Emergency protocols
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide specific workflow adjustment recommendations.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Generate adjustments (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">adjustments</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dept_name</span><span class="p">,</span> <span class="n">load</span> <span class="ow">in</span> <span class="n">loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">load</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># High load</span>
</span></span><span class="line"><span class="cl">                <span class="n">adjustments</span><span class="p">[</span><span class="n">dept_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;ACTIVATE_EMERGENCY_PROTOCOL&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;REQUEST_ADDITIONAL_STAFF&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;EXPEDITE_DISCHARGES&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">load</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>  <span class="c1"># Moderate load</span>
</span></span><span class="line"><span class="cl">                <span class="n">adjustments</span><span class="p">[</span><span class="n">dept_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;OPTIMIZE_RESOURCE_ALLOCATION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;REVIEW_WAIT_TIMES&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">adjustments</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analyze_situation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">HospitalState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HospitalState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze current hospital situation
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">departments</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Department</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;departments&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">patients</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Patient</span><span class="p">(</span><span class="o">**</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;patients&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze loads</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">LoadAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">loads</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_department_loads</span><span class="p">(</span><span class="n">departments</span><span class="p">,</span> <span class="n">patients</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Store analysis results</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;metrics&#34;</span><span class="p">][</span><span class="s2">&#34;department_loads&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loads</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;OPTIMIZE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">optimize_resources</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">HospitalState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HospitalState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Optimize resource allocation
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">departments</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Department</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;departments&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Resource</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;resources&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">patients</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Patient</span><span class="p">(</span><span class="o">**</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;patients&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Optimize resources</span>
</span></span><span class="line"><span class="cl">    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">ResourceOptimizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocations</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize_resources</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">departments</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">resources</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">patients</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;metrics&#34;</span><span class="p">][</span><span class="s2">&#34;department_loads&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update allocations</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;allocations&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;alloc_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">alloc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">alloc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allocations</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;ADJUST&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">adjust_workflows</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">HospitalState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HospitalState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Adjust workflows based on current situation
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">departments</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Department</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;departments&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Resource</span><span class="p">(</span><span class="o">**</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;resources&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Adjust workflows</span>
</span></span><span class="line"><span class="cl">    <span class="n">adjuster</span> <span class="o">=</span> <span class="n">WorkflowAdjuster</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">adjustments</span> <span class="o">=</span> <span class="n">adjuster</span><span class="o">.</span><span class="n">adjust_workflows</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">departments</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;metrics&#34;</span><span class="p">][</span><span class="s2">&#34;department_loads&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">resources</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Store adjustments</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;metrics&#34;</span><span class="p">][</span><span class="s2">&#34;workflow_adjustments&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjustments</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">HospitalState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">HospitalState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">analyze_situation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;optimize&#34;</span><span class="p">,</span> <span class="n">optimize_resources</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;adjust&#34;</span><span class="p">,</span> <span class="n">adjust_workflows</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;optimize&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;adjust&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;analyze&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;OPTIMIZE&#34;</span><span class="p">:</span> <span class="s2">&#34;optimize&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;optimize&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ADJUST&#34;</span><span class="p">:</span> <span class="s2">&#34;adjust&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;adjust&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;departments&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;emergency&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Emergency&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_load&#34;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;patient_count&#34;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;resources&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;DOCTOR&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;doc1&#34;</span><span class="p">,</span> <span class="s2">&#34;doc2&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;NURSE&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;nurse1&#34;</span><span class="p">,</span> <span class="s2">&#34;nurse2&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;BED&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;bed1&#34;</span><span class="p">,</span> <span class="s2">&#34;bed2&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;wait_time&#34;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;HIGH_LOAD&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;resources&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;doc1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;doc1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;DOCTOR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;department&#34;</span><span class="p">:</span> <span class="s2">&#34;emergency&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;BUSY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_assignment&#34;</span><span class="p">:</span> <span class="s2">&#34;patient1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;capacity&#34;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;skills&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;emergency&#34;</span><span class="p">,</span> <span class="s2">&#34;general&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;patients&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;patient1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;patient1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;priority&#34;</span><span class="p">:</span> <span class="s2">&#34;HIGH&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;department&#34;</span><span class="p">:</span> <span class="s2">&#34;emergency&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required_resources&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;DOCTOR&#34;</span><span class="p">,</span> <span class="s2">&#34;BED&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;arrival_time&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-02-06T10:00:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;IN_TREATMENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;estimated_duration&#34;</span><span class="p">:</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;allocations&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;metrics&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;ANALYZE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="14-ระบบซอมแซมตวเอง-self-healing-systems">14. ระบบซ่อมแซมตัวเอง (Self-Healing Systems)<a hidden class="anchor" aria-hidden="true" href="#14-ระบบซอมแซมตวเอง-self-healing-systems">#</a></h3>
<p>รูปแบบนี้น่าสนใจเพราะช่วยให้ระบบสามารถรักษาเสถียรภาพการทำงานได้ด้วยตัวเอง โดย:</p>
<ul>
<li>ตรวจจับปัญหาหรือข้อผิดพลาด</li>
<li>วิเคราะห์สาเหตุของปัญหา</li>
<li>ดำเนินการแก้ไขโดยอัตโนมัติ</li>
</ul>
<p>ระบบจัดการคลาวด์ที่สามารถตรวจจับและแก้ไขปัญหาเซิร์ฟเวอร์ที่ทำงานผิดปกติเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Self-Healing Systems</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ServerStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">HEALTHY</span> <span class="o">=</span> <span class="s2">&#34;HEALTHY&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WARNING</span> <span class="o">=</span> <span class="s2">&#34;WARNING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&#34;CRITICAL&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MAINTENANCE</span> <span class="o">=</span> <span class="s2">&#34;MAINTENANCE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OFFLINE</span> <span class="o">=</span> <span class="s2">&#34;OFFLINE&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">IssueType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">CPU_OVERLOAD</span> <span class="o">=</span> <span class="s2">&#34;CPU_OVERLOAD&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MEMORY_LEAK</span> <span class="o">=</span> <span class="s2">&#34;MEMORY_LEAK&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DISK_FULL</span> <span class="o">=</span> <span class="s2">&#34;DISK_FULL&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">NETWORK_LATENCY</span> <span class="o">=</span> <span class="s2">&#34;NETWORK_LATENCY&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SERVICE_DOWN</span> <span class="o">=</span> <span class="s2">&#34;SERVICE_DOWN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DATABASE_SLOW</span> <span class="o">=</span> <span class="s2">&#34;DATABASE_SLOW&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ServerMetrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">cpu_usage</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">memory_usage</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">disk_usage</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">network_latency</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">response_time</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">error_rate</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">uptime</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Server</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="n">ServerStatus</span>
</span></span><span class="line"><span class="cl">    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># web, database, cache, etc.</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_metrics</span><span class="p">:</span> <span class="n">ServerMetrics</span>
</span></span><span class="line"><span class="cl">    <span class="n">historical_metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ServerMetrics</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">active_issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">maintenance_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Issue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="nb">type</span><span class="p">:</span> <span class="n">IssueType</span>
</span></span><span class="line"><span class="cl">    <span class="n">severity</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1</span>
</span></span><span class="line"><span class="cl">    <span class="n">detected_time</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_cause</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">resolution_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># DETECTED, ANALYZING, RESOLVING, RESOLVED</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Resolution</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">issue_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">expected_impact</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">success_criteria</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">rollback_plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CloudState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">servers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">issues</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">resolutions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">system_health</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Cloud Health Monitor&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HealthMonitor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Monitors server health and detects issues&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_metrics</span><span class="p">(</span><span class="n">server</span><span class="p">:</span> <span class="n">Server</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Issue</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze these server metrics for potential issues:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Server Info:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Key Metrics:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - CPU Usage: </span><span class="si">{</span><span class="n">server</span><span class="o">.</span><span class="n">current_metrics</span><span class="o">.</span><span class="n">cpu_usage</span><span class="si">}</span><span class="s2">%
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Memory Usage: </span><span class="si">{</span><span class="n">server</span><span class="o">.</span><span class="n">current_metrics</span><span class="o">.</span><span class="n">memory_usage</span><span class="si">}</span><span class="s2">%
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Disk Usage: </span><span class="si">{</span><span class="n">server</span><span class="o">.</span><span class="n">current_metrics</span><span class="o">.</span><span class="n">disk_usage</span><span class="si">}</span><span class="s2">%
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Network Latency: </span><span class="si">{</span><span class="n">server</span><span class="o">.</span><span class="n">current_metrics</span><span class="o">.</span><span class="n">network_latency</span><span class="si">}</span><span class="s2">ms
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Error Rate: </span><span class="si">{</span><span class="n">server</span><span class="o">.</span><span class="n">current_metrics</span><span class="o">.</span><span class="n">error_rate</span><span class="si">}</span><span class="s2">%
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Historical Metrics:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">asdict</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">historical_metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Identify:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Performance issues
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Resource constraints
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Service degradation
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Anomalous behavior
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            For each issue provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Issue type
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Severity
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Potential root causes
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Initial resolution steps
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Detect issues (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">metrics</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">current_metrics</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check CPU</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">cpu_usage</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Issue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;issue_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">server_id</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">type</span><span class="o">=</span><span class="n">IssueType</span><span class="o">.</span><span class="n">CPU_OVERLOAD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">severity</span><span class="o">=</span><span class="nb">min</span><span class="p">((</span><span class="n">metrics</span><span class="o">.</span><span class="n">cpu_usage</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">detected_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;CPU usage critically high&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">root_cause</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">resolution_steps</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Scale up CPU&#34;</span><span class="p">,</span> <span class="s2">&#34;Check runaway processes&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="o">=</span><span class="s2">&#34;DETECTED&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check Memory</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">metrics</span><span class="o">.</span><span class="n">memory_usage</span> <span class="o">&gt;</span> <span class="mi">85</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Issue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;issue_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">server_id</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nb">type</span><span class="o">=</span><span class="n">IssueType</span><span class="o">.</span><span class="n">MEMORY_LEAK</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">severity</span><span class="o">=</span><span class="nb">min</span><span class="p">((</span><span class="n">metrics</span><span class="o">.</span><span class="n">memory_usage</span> <span class="o">-</span> <span class="mi">85</span><span class="p">)</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">detected_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Memory usage abnormally high&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">root_cause</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">resolution_steps</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Analyze memory dumps&#34;</span><span class="p">,</span> <span class="s2">&#34;Check memory leaks&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="o">=</span><span class="s2">&#34;DETECTED&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">issues</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DiagnosticEngine</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes issues and determines root causes&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_issue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">issue</span><span class="p">:</span> <span class="n">Issue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">:</span> <span class="n">Server</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">system_health</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Issue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze this server issue and determine root cause:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Issue Details:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">issue</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Server Information:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            System Health Context:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">system_health</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Detailed root cause analysis
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Impact assessment
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Recommended resolution steps
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Risk evaluation
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update issue with analysis (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IssueType</span><span class="o">.</span><span class="n">CPU_OVERLOAD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issue</span><span class="o">.</span><span class="n">root_cause</span> <span class="o">=</span> <span class="s2">&#34;High application load causing CPU spikes&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">issue</span><span class="o">.</span><span class="n">resolution_steps</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Enable auto-scaling&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Optimize application code&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Add load balancing&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">issue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IssueType</span><span class="o">.</span><span class="n">MEMORY_LEAK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">issue</span><span class="o">.</span><span class="n">root_cause</span> <span class="o">=</span> <span class="s2">&#34;Application memory leak detected&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">issue</span><span class="o">.</span><span class="n">resolution_steps</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Restart problematic services&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Apply memory leak patches&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Monitor memory patterns&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">issue</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;ANALYZING&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">issue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RepairExecutor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Executes repair actions and monitors results&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_resolution_plan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">issue</span><span class="p">:</span> <span class="n">Issue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">:</span> <span class="n">Server</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Resolution</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Create a resolution plan for this issue:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Issue:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">issue</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Server:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">server</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Detailed action steps
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Success criteria
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Expected impacts
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Rollback procedures
</span></span></span><span class="line"><span class="cl"><span class="s2">            5. Risk mitigation strategies
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Create resolution plan (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Resolution</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">issue_id</span><span class="o">=</span><span class="n">issue</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">server_id</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">actions</span><span class="o">=</span><span class="n">issue</span><span class="o">.</span><span class="n">resolution_steps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">expected_impact</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;cpu_usage&#34;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span> <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IssueType</span><span class="o">.</span><span class="n">CPU_OVERLOAD</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;memory_usage&#34;</span><span class="p">:</span> <span class="o">-</span><span class="mi">30</span> <span class="k">if</span> <span class="n">issue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">IssueType</span><span class="o">.</span><span class="n">MEMORY_LEAK</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;response_time&#34;</span><span class="p">:</span> <span class="o">-</span><span class="mi">50</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">success_criteria</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;cpu_usage&#34;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;memory_usage&#34;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;error_rate&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">rollback_plan</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Stop new resolution actions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Restore from last known good configuration&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Reset affected services&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">monitor_health</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">CloudState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CloudState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Monitor server health and detect issues
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Server</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;servers&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Check each server</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span> <span class="o">=</span> <span class="n">HealthMonitor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_issues</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="n">servers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">server_issues</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">analyze_metrics</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_issues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">server_issues</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Update state</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">new_issues</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">][</span><span class="n">issue</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate system health</span>
</span></span><span class="line"><span class="cl">    <span class="n">total_servers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">servers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">healthy_servers</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">servers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ServerStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;system_health&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;overall_health&#34;</span><span class="p">:</span> <span class="n">healthy_servers</span> <span class="o">/</span> <span class="n">total_servers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;total_issues&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;critical_issues&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s2">&#34;severity&#34;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;DIAGNOSE&#34;</span> <span class="k">if</span> <span class="n">new_issues</span> <span class="k">else</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">diagnose_issues</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">CloudState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CloudState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze issues and determine root causes
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">issues</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Issue</span><span class="p">(</span><span class="o">**</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;DETECTED&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Server</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;servers&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze each issue</span>
</span></span><span class="line"><span class="cl">    <span class="n">engine</span> <span class="o">=</span> <span class="n">DiagnosticEngine</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">issue_id</span><span class="p">,</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">issue</span><span class="o">.</span><span class="n">server_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">updated_issue</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">analyze_issue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">issue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">server</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;system_health&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">][</span><span class="n">issue_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">updated_issue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;REPAIR&#34;</span> <span class="k">if</span> <span class="n">issues</span> <span class="k">else</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">execute_repairs</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">CloudState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CloudState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Execute repair actions for analyzed issues
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">issues</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Issue</span><span class="p">(</span><span class="o">**</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;ANALYZING&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">Server</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;servers&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create and execute repair plans</span>
</span></span><span class="line"><span class="cl">    <span class="n">executor</span> <span class="o">=</span> <span class="n">RepairExecutor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">issue_id</span><span class="p">,</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">issues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">issue</span><span class="o">.</span><span class="n">server_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">resolution</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">create_resolution_plan</span><span class="p">(</span><span class="n">issue</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;resolutions&#34;</span><span class="p">][</span><span class="n">issue_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Update issue status</span>
</span></span><span class="line"><span class="cl">        <span class="n">issue</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;RESOLVING&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;issues&#34;</span><span class="p">][</span><span class="n">issue_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">CloudState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">CloudState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;monitor&#34;</span><span class="p">,</span> <span class="n">monitor_health</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;diagnose&#34;</span><span class="p">,</span> <span class="n">diagnose_issues</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;repair&#34;</span><span class="p">,</span> <span class="n">execute_repairs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;monitor&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;diagnose&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;repair&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;monitor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;monitor&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;DIAGNOSE&#34;</span><span class="p">:</span> <span class="s2">&#34;diagnose&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;diagnose&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;REPAIR&#34;</span><span class="p">:</span> <span class="s2">&#34;repair&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;repair&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;servers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;web1&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;web1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Web Server 1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;WARNING&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;web&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;current_metrics&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;cpu_usage&#34;</span><span class="p">:</span> <span class="mf">95.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;memory_usage&#34;</span><span class="p">:</span> <span class="mf">87.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;disk_usage&#34;</span><span class="p">:</span> <span class="mf">75.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;network_latency&#34;</span><span class="p">:</span> <span class="mf">150.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;response_time&#34;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;error_rate&#34;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;uptime&#34;</span><span class="p">:</span> <span class="mf">15.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;historical_metrics&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;active_issues&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;maintenance_history&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;issues&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;resolutions&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;system_health&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;MONITOR&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Step Output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></div>
</details></p>
</blockquote>
<h3 id="15-ระบบตดสนใจตามหลกจรยธรรม-ethical-decision-making">15. ระบบตัดสินใจตามหลักจริยธรรม (Ethical Decision-Making)<a hidden class="anchor" aria-hidden="true" href="#15-ระบบตดสนใจตามหลกจรยธรรม-ethical-decision-making">#</a></h3>
<p>รูปแบบนี้มีความสำคัญมากในยุคที่ AI มีบทบาทในการตัดสินใจที่ส่งผลกระทบต่อชีวิตมนุษย์ โดย:</p>
<ul>
<li>พิจารณาผลกระทบทางจริยธรรม</li>
<li>ชั่งน้ำหนักระหว่างประโยชน์และความเสี่ยง</li>
<li>ตัดสินใจบนพื้นฐานของค่านิยมและบรรทัดฐานของสังคม</li>
</ul>
<p>รถยนต์ไร้คนขับที่ต้องตัดสินใจในสถานการณ์ฉุกเฉินโดยคำนึงถึงความปลอดภัยของทุกฝ่ายเป็นตัวอย่างที่ดีของการใช้งานรูปแบบนี้</p>
<blockquote>


<p><details >
  <summary markdown="span"><em><strong>ตัวอย่าง Ethical Decision-Making</strong></em></summary>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langgraph.graph</span> <span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenRouter</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define data structures</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EntityType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">VEHICLE</span> <span class="o">=</span> <span class="s2">&#34;VEHICLE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PEDESTRIAN</span> <span class="o">=</span> <span class="s2">&#34;PEDESTRIAN&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CYCLIST</span> <span class="o">=</span> <span class="s2">&#34;CYCLIST&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OBSTACLE</span> <span class="o">=</span> <span class="s2">&#34;OBSTACLE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRAFFIC_LIGHT</span> <span class="o">=</span> <span class="s2">&#34;TRAFFIC_LIGHT&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RiskLevel</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOW</span> <span class="o">=</span> <span class="s2">&#34;LOW&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="s2">&#34;MEDIUM&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HIGH</span> <span class="o">=</span> <span class="s2">&#34;HIGH&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&#34;CRITICAL&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Position</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">speed</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">direction</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Entity</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="nb">type</span><span class="p">:</span> <span class="n">EntityType</span>
</span></span><span class="line"><span class="cl">    <span class="n">position</span><span class="p">:</span> <span class="n">Position</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>  <span class="c1"># width, height</span>
</span></span><span class="line"><span class="cl">    <span class="n">velocity</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>  <span class="c1"># vx, vy</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 1 (highest) to 5 (lowest)</span>
</span></span><span class="line"><span class="cl">    <span class="n">vulnerability</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1</span>
</span></span><span class="line"><span class="cl">    <span class="n">protected_status</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1"># True for children, elderly, etc.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Scenario</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">vehicle_state</span><span class="p">:</span> <span class="n">Entity</span>
</span></span><span class="line"><span class="cl">    <span class="n">entities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Entity</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">road_conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>  <span class="c1"># friction, visibility, etc.</span>
</span></span><span class="line"><span class="cl">    <span class="n">weather_conditions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">time_to_impact</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">possible_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EthicalPrinciple</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@dataclass</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Decision</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">reasoning</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ethical_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">risk_assessment</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">consequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">VehicleState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_scenario</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl">    <span class="n">ethical_principles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">available_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">risk_assessments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">decision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize OpenRouter LLM</span>
</span></span><span class="line"><span class="cl"><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenRouter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENROUTER_API_KEY&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;openai/gpt-4-turbo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP-Referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;X-Title&#34;</span><span class="p">:</span> <span class="s2">&#34;Ethical Vehicle AI&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define ethical principles</span>
</span></span><span class="line"><span class="cl"><span class="n">ETHICAL_PRINCIPLES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;minimize_harm&#34;</span><span class="p">:</span> <span class="n">EthicalPrinciple</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;minimize_harm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Minimize Harm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Minimize overall harm to all entities involved&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Consider vulnerability&#34;</span><span class="p">,</span> <span class="s2">&#34;Protect human life&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">priority</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;protect_vulnerable&#34;</span><span class="p">:</span> <span class="n">EthicalPrinciple</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;protect_vulnerable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Protect Vulnerable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Prioritize protection of vulnerable individuals&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">weight</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;Children&#34;</span><span class="p">,</span> <span class="s2">&#34;Elderly&#34;</span><span class="p">,</span> <span class="s2">&#34;Disabled&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">priority</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fairness&#34;</span><span class="p">:</span> <span class="n">EthicalPrinciple</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;fairness&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Fairness&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Ensure fair treatment regardless of characteristics&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">weight</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;No discrimination&#34;</span><span class="p">,</span> <span class="s2">&#34;Equal consideration&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">priority</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RiskAnalyzer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Analyzes risks for different actions&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">calculate_collision_risk</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">vehicle</span><span class="p">:</span> <span class="n">Entity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">entity</span><span class="p">:</span> <span class="n">Entity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">time_to_impact</span><span class="p">:</span> <span class="nb">float</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple risk calculation based on time to impact and relative velocity</span>
</span></span><span class="line"><span class="cl">        <span class="n">relative_velocity</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">entity</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">entity</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">entity</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">entity</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Higher risk for closer entities and higher relative velocities</span>
</span></span><span class="line"><span class="cl">        <span class="n">risk</span> <span class="o">=</span> <span class="p">(</span><span class="n">relative_velocity</span> <span class="o">*</span> <span class="n">entity</span><span class="o">.</span><span class="n">vulnerability</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">distance</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">analyze_action_risks</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Analyze risks for this action in the current scenario:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Scenario:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">scenario</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Proposed Action:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Collision risks
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Entity vulnerabilities
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Environmental factors
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Time constraints
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide risk assessment for:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Immediate safety
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Secondary effects
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Long-term consequences
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate risks (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">risks</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;collision&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">RiskAnalyzer</span><span class="o">.</span><span class="n">calculate_collision_risk</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">scenario</span><span class="o">.</span><span class="n">vehicle_state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">entity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">scenario</span><span class="o">.</span><span class="n">time_to_impact</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">entities</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">entities</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;environmental&#34;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">road_conditions</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">road_conditions</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;time_pressure&#34;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">time_to_impact</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">risks</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EthicalEvaluator</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Evaluates ethical implications of actions&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">evaluate_action</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">principles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EthicalPrinciple</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">risks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Evaluate ethical implications of this action:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Action:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Scenario:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">scenario</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ethical Principles:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">principles</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Risk Assessment:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">risks</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Impact on all entities
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Adherence to ethical principles
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Risk-benefit balance
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Social values and norms
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide scores and explanations for each principle.
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate ethical scores (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">principle</span> <span class="ow">in</span> <span class="n">principles</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">principle</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&#34;minimize_harm&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">scores</span><span class="p">[</span><span class="n">principle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">risks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">principle</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&#34;protect_vulnerable&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">vulnerable_entities</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">entities</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">protected_status</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">vulnerable_entities</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">avg_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">RiskAnalyzer</span><span class="o">.</span><span class="n">calculate_collision_risk</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">scenario</span><span class="o">.</span><span class="n">vehicle_state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">entity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">scenario</span><span class="o">.</span><span class="n">time_to_impact</span>
</span></span><span class="line"><span class="cl">                        <span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">vulnerable_entities</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">vulnerable_entities</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">scores</span><span class="p">[</span><span class="n">principle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">avg_risk</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">scores</span><span class="p">[</span><span class="n">principle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">principle</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&#34;fairness&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Check if risks are evenly distributed</span>
</span></span><span class="line"><span class="cl">                <span class="n">risk_variance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">risks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">risks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">scores</span><span class="p">[</span><span class="n">principle</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">risk_variance</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">scores</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DecisionMaker</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Makes final decisions based on ethical evaluation and risks&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">make_decision</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ethical_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">        <span class="n">risk_assessments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decision</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            Make a decision based on ethical evaluation and risks:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Scenario:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">scenario</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Ethical Scores:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ethical_scores</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Risk Assessments:
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">risk_assessments</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Consider:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Overall ethical alignment
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Risk minimization
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Time constraints
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Practical feasibility
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">            Provide:
</span></span></span><span class="line"><span class="cl"><span class="s2">            1. Chosen action
</span></span></span><span class="line"><span class="cl"><span class="s2">            2. Detailed reasoning
</span></span></span><span class="line"><span class="cl"><span class="s2">            3. Expected consequences
</span></span></span><span class="line"><span class="cl"><span class="s2">            4. Confidence level
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Select best action (simplified)</span>
</span></span><span class="line"><span class="cl">        <span class="n">action_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">possible_actions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Combine ethical scores and risk assessments</span>
</span></span><span class="line"><span class="cl">            <span class="n">ethical_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">score</span> <span class="o">*</span> <span class="n">ETHICAL_PRINCIPLES</span><span class="p">[</span><span class="n">principle</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">principle</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">ethical_scores</span><span class="p">[</span><span class="n">action</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">risk_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">risk_assessments</span><span class="p">[</span><span class="n">action</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">risk_assessments</span><span class="p">[</span><span class="n">action</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Weight ethical considerations more heavily</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_scores</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ethical_score</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">risk_score</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">best_action</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">action_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Decision</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="o">=</span><span class="n">best_action</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">reasoning</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;Highest combined ethical and safety score&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;Ethical score: </span><span class="si">{</span><span class="n">ethical_scores</span><span class="p">[</span><span class="n">best_action</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34;Risk assessment: </span><span class="si">{</span><span class="n">risk_assessments</span><span class="p">[</span><span class="n">best_action</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">ethical_scores</span><span class="o">=</span><span class="n">ethical_scores</span><span class="p">[</span><span class="n">best_action</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">risk_assessment</span><span class="o">=</span><span class="n">risk_assessments</span><span class="p">[</span><span class="n">best_action</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">consequences</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;immediate&#34;</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Avoid collision&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;secondary&#34;</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Minimal disruption&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">confidence</span><span class="o">=</span><span class="n">action_scores</span><span class="p">[</span><span class="n">best_action</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">analyze_risks</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">VehicleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VehicleState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Analyze risks for each possible action
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">scenario</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_scenario&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Analyze risks for each action</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RiskAnalyzer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">risk_assessments</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;available_actions&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">risks</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_action_risks</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">risk_assessments</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">risks</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;risk_assessments&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">risk_assessments</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;EVALUATE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate_ethics</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">VehicleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VehicleState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Evaluate ethical implications of each action
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">scenario</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_scenario&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">principles</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">k</span><span class="p">:</span> <span class="n">EthicalPrinciple</span><span class="p">(</span><span class="o">**</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;ethical_principles&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Evaluate each action</span>
</span></span><span class="line"><span class="cl">    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">EthicalEvaluator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ethical_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;available_actions&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">scores</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate_action</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">action</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">scenario</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">principles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">[</span><span class="s2">&#34;risk_assessments&#34;</span><span class="p">][</span><span class="n">action</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ethical_scores</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;ethical_scores&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ethical_scores</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;DECIDE&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_decision</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">VehicleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VehicleState</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Make final decision based on ethical evaluation and risks
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert data structures</span>
</span></span><span class="line"><span class="cl">    <span class="n">scenario</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;current_scenario&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Make decision</span>
</span></span><span class="line"><span class="cl">    <span class="n">decision_maker</span> <span class="o">=</span> <span class="n">DecisionMaker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">decision</span> <span class="o">=</span> <span class="n">decision_maker</span><span class="o">.</span><span class="n">make_decision</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">scenario</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;ethical_scores&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">[</span><span class="s2">&#34;risk_assessments&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;decision&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="n">decision</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;END&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">VehicleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Route to the next step based on the current state&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create the graph</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">VehicleState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">analyze_risks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;evaluate&#34;</span><span class="p">,</span> <span class="n">evaluate_ethics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&#34;decide&#34;</span><span class="p">,</span> <span class="n">make_decision</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;evaluate&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&#34;decide&#34;</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set entry point</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&#34;analyze&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create conditional edges</span>
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;analyze&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;EVALUATE&#34;</span><span class="p">:</span> <span class="s2">&#34;evaluate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;evaluate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;DECIDE&#34;</span><span class="p">:</span> <span class="s2">&#34;decide&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;decide&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;END&#34;</span><span class="p">:</span> <span class="n">END</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize state with example emergency scenario</span>
</span></span><span class="line"><span class="cl">    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;messages&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;current_scenario&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;vehicle_state&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;ego_vehicle&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;VEHICLE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;position&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;x&#34;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;y&#34;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;speed&#34;</span><span class="p">:</span> <span class="mf">50.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;direction&#34;</span><span class="p">:</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;size&#34;</span><span class="p">:</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;velocity&#34;</span><span class="p">:</span> <span class="p">(</span><span class="mf">14.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;priority&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;vulnerability&#34;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;protected_status&#34;</span><span class="p">:</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;entities&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;pedestrian1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;PEDESTRIAN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;position&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;x&#34;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;y&#34;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;speed&#34;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;direction&#34;</span><span class="p">:</span> <span class="mf">90.0</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;size&#34;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;velocity&#34;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;priority&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;vulnerability&#34;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;protected_status&#34;</span><span class="p">:</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;road_conditions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;friction&#34;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;visibility&#34;</span><span class="p">:</span> <span class="mf">0.9</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;weather_conditions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;CLEAR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;intensity&#34;</span><span class="p">:</span> <span class="s2">&#34;NONE&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;time_to_impact&#34;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;possible_actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;EMERGENCY_BRAKE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;SWERVE_LEFT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;SWERVE_RIGHT&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ethical_principles&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span><span class="p">:</span> <span class="n">asdict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ETHICAL_PRINCIPLES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;available_actions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;EMERGENCY_BRAKE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SWERVE_LEFT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;SWERVE_RIGHT&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;risk_assessments&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ethical_scores&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;decision&#34;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;next_action&#34;</span><span class="p">:</span> <span class="s2">&#34;ANALYZE&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Run the workflow</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Initial Scenario Analysis:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=========================&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Vehicle Speed: </span><span class="si">{</span><span class="n">initial_state</span><span class="p">[</span><span class="s1">&#39;current_scenario&#39;</span><span class="p">][</span><span class="s1">&#39;vehicle_state&#39;</span><span class="p">][</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;speed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> km/h&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Time to Impact: </span><span class="si">{</span><span class="n">initial_state</span><span class="p">[</span><span class="s1">&#39;current_scenario&#39;</span><span class="p">][</span><span class="s1">&#39;time_to_impact&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> seconds&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Available Actions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">initial_state</span><span class="p">[</span><span class="s1">&#39;available_actions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Starting Decision Process...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">initial_state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">step</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&#34;next_action&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="s2">&#34;EVALUATE&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Risk Assessment Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=======================&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">risks</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s2">&#34;risk_assessments&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">risk_type</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">risks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- </span><span class="si">{</span><span class="n">risk_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">step</span> <span class="o">==</span> <span class="s2">&#34;DECIDE&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Ethical Evaluation Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=========================&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s2">&#34;ethical_scores&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">principle</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- </span><span class="si">{</span><span class="n">principle</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">step</span> <span class="o">==</span> <span class="s2">&#34;END&#34;</span> <span class="ow">and</span> <span class="n">output</span><span class="p">[</span><span class="s2">&#34;decision&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Final Decision:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;==============&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">decision</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&#34;decision&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Chosen Action: </span><span class="si">{</span><span class="n">decision</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Reasoning:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">decision</span><span class="p">[</span><span class="s2">&#34;reasoning&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Confidence: </span><span class="si">{</span><span class="n">decision</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Expected Consequences:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">consequence</span> <span class="ow">in</span> <span class="n">decision</span><span class="p">[</span><span class="s2">&#34;consequences&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;- </span><span class="si">{</span><span class="n">consequence</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">consequence</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>The workflow will now execute with detailed outputs at each step</p>
<p>Example Output Explanation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">1. Risk Assessment Phase:
</span></span><span class="line"><span class="cl">   - Analyzes collision risks for each possible action
</span></span><span class="line"><span class="cl">   - Considers environmental factors (road conditions, weather)
</span></span><span class="line"><span class="cl">   - Evaluates time pressure and response windows
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">2. Ethical Evaluation Phase:
</span></span><span class="line"><span class="cl">   - Applies ethical principles to each action
</span></span><span class="line"><span class="cl">   - Weighs protection of vulnerable entities
</span></span><span class="line"><span class="cl">   - Considers fairness and harm minimization
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">3. Decision Making Phase:
</span></span><span class="line"><span class="cl">   - Combines risk and ethical assessments
</span></span><span class="line"><span class="cl">   - Selects action with best overall score
</span></span><span class="line"><span class="cl">   - Provides detailed reasoning and expected outcomes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The system prioritizes:
</span></span><span class="line"><span class="cl">- Protection of human life
</span></span><span class="line"><span class="cl">- Minimization of harm
</span></span><span class="line"><span class="cl">- Fairness in risk distribution
</span></span><span class="line"><span class="cl">- Consideration of vulnerable individuals
</span></span><span class="line"><span class="cl">- Practical feasibility of actions
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Key ethical principles like minimizing harm and protecting vulnerable individuals 
</span></span><span class="line"><span class="cl">are given higher weights in the decision process, while still maintaining 
</span></span><span class="line"><span class="cl">a balance with practical safety considerations.
</span></span></code></pre></div>
</details></p>
</blockquote>
<h2 id="การนำ-agentic-design-patterns-ไปใชงาน">การนำ Agentic Design Patterns ไปใช้งาน<a hidden class="anchor" aria-hidden="true" href="#การนำ-agentic-design-patterns-ไปใชงาน">#</a></h2>
<p>การเลือกใช้รูปแบบการออกแบบที่เหมาะสมเป็นสิ่งสำคัญมาก เพราะแต่ละรูปแบบมีจุดแข็งและข้อจำกัดที่แตกต่างกัน ในการพัฒนาระบบ AI ควรพิจารณาปัจจัยต่างๆ ดังนี้:</p>
<ol>
<li>
<p><strong>ลักษณะของงาน</strong>: งานที่ต้องการการตอบสนองรวดเร็วอาจเหมาะกับ Reflexive Agent ในขณะที่งานที่ซับซ้อนอาจต้องใช้ Meta-Agent หรือ Collaborative Multi-Agent Systems</p>
</li>
<li>
<p><strong>ทรัพยากรที่มี</strong>: บางรูปแบบต้องการทรัพยากรการประมวลผลมาก เช่น Self-Improvement หรือ Adaptive Workflow Orchestration ควรพิจารณาความพร้อมของระบบก่อนเลือกใช้</p>
</li>
<li>
<p><strong>ความต้องการด้านความแม่นยำ</strong>: งานที่ต้องการความแม่นยำสูงอาจต้องใช้รูปแบบที่มีการตรวจสอบและยืนยันผลลัพธ์ เช่น ReACT หรือ Planner-Executor</p>
</li>
<li>
<p><strong>ความต้องการด้านการปรับตัว</strong>: หากระบบต้องทำงานในสภาพแวดล้อมที่เปลี่ยนแปลงบ่อย ควรเลือกรูปแบบที่มีความยืดหยุ่นสูง เช่น Self-Improvement หรือ Interactive Learning</p>
</li>
</ol>
<h2 id="บทสรป">บทสรุป<a hidden class="anchor" aria-hidden="true" href="#บทสรป">#</a></h2>
<p>Agentic Design Patterns เป็นแนวคิดที่น่าสนใจและมีประโยชน์มากในการพัฒนาระบบ AI ให้ทำงานได้อย่างชาญฉลาด การเข้าใจจุดแข็งและข้อจำกัดของแต่ละรูปแบบจะช่วยให้เราสามารถเลือกใช้และผสมผสานรูปแบบต่างๆ ได้อย่างเหมาะสม เพื่อสร้างระบบ AI ที่มีประสิทธิภาพและตอบโจทย์ความต้องการได้อย่างแท้จริง</p>
<h2 id="แหลงขอมลเพมเตม">แหล่งข้อมูลเพิ่มเติม<a hidden class="anchor" aria-hidden="true" href="#แหลงขอมลเพมเตม">#</a></h2>
<ul>
<li><a href="https://github.com/panaversity/learn-agentic-ai/tree/main/05_ai_agents_intro/13_agentic_design_patterns">Agentic Design Patterns</a></li>
</ul>
<hr>
<p><em>Cover image by <a href="https://github.com/ksm26/AI-Agentic-Design-Patterns-with-AutoGen">AI Agentic Design Patterns with AutoGen</a></em></p>
<p><em>ปล. บทความนี้เขียนด้วย AI  (^ . ^)</em></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/ai/">AI</a></li>
      <li><a href="http://localhost:1313/tags/artificial-intelligence/">Artificial Intelligence</a></li>
      <li><a href="http://localhost:1313/tags/agentic-ai/">Agentic AI</a></li>
      <li><a href="http://localhost:1313/tags/design-patterns/">Design Patterns</a></li>
      <li><a href="http://localhost:1313/tags/software-engineering/">Software Engineering</a></li>
      <li><a href="http://localhost:1313/tags/python/">Python</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/agentic-ai/next-generation-architecture/">
    <span class="title">« Prev</span>
    <br>
    <span>การเปลี่ยนแปลงครั้งใหญ่: สถาปัตยกรรม AI Agent รุ่นใหม่และการปฏิวัติการทำงานของซอฟต์แวร์</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/agent-example/">
    <span class="title">Next »</span>
    <br>
    <span>ลองเล่น Deepseek-R1 และสร้าง AI Agent ด้วย Langgraph</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on x"
            href="https://x.com/intent/tweet/?text=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f&amp;hashtags=AI%2cArtificialIntelligence%2cAgenticAI%2cDesignPatterns%2cSoftwareEngineering%2cPython">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f&amp;title=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94&amp;summary=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f&title=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on whatsapp"
            href="https://api.whatsapp.com/send?text=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on telegram"
            href="https://telegram.me/share/url?text=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ทำความรู้จักกับ Agentic Design Patterns: รูปแบบการออกแบบ AI ที่ช่วยให้ระบบทำงานได้อย่างชาญฉลาด on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e0%b8%97%e0%b8%b3%e0%b8%84%e0%b8%a7%e0%b8%b2%e0%b8%a1%e0%b8%a3%e0%b8%b9%e0%b9%89%e0%b8%88%e0%b8%b1%e0%b8%81%e0%b8%81%e0%b8%b1%e0%b8%9a%20Agentic%20Design%20Patterns%3a%20%e0%b8%a3%e0%b8%b9%e0%b8%9b%e0%b9%81%e0%b8%9a%e0%b8%9a%e0%b8%81%e0%b8%b2%e0%b8%a3%e0%b8%ad%e0%b8%ad%e0%b8%81%e0%b9%81%e0%b8%9a%e0%b8%9a%20AI%20%e0%b8%97%e0%b8%b5%e0%b9%88%e0%b8%8a%e0%b9%88%e0%b8%a7%e0%b8%a2%e0%b9%83%e0%b8%ab%e0%b9%89%e0%b8%a3%e0%b8%b0%e0%b8%9a%e0%b8%9a%e0%b8%97%e0%b8%b3%e0%b8%87%e0%b8%b2%e0%b8%99%e0%b9%84%e0%b8%94%e0%b9%89%e0%b8%ad%e0%b8%a2%e0%b9%88%e0%b8%b2%e0%b8%87%e0%b8%8a%e0%b8%b2%e0%b8%8d%e0%b8%89%e0%b8%a5%e0%b8%b2%e0%b8%94&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fagentic-ai%2fagentic-design-patterns%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Toffysoft&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
